name: Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  api-tests:
    name: API Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'

    - name: Download dependencies
      run: go mod download

    - name: Build application
      run: |
        mkdir -p bin test/bin
        CGO_ENABLED=0 go build -o bin/quaero ./cmd/quaero
        cp bin/quaero test/bin/quaero

    - name: Setup test environment
      run: |
        # Create test directories
        mkdir -p test/bin/pages test/bin/job-definitions test/bin/variables test/bin/data

        # Copy pages for UI
        cp -r pages test/bin/

        # Copy test config files
        cp test/config/test-quaero.toml test/bin/quaero.toml

        # Copy job definitions
        cp -r test/config/job-definitions/* test/bin/job-definitions/ || true

        # Copy variables
        cp -r test/config/variables/* test/bin/variables/ || true

    - name: Run API tests
      run: |
        cd test/api
        go test -v -timeout 10m ./...
      env:
        TEST_MODE: integration
        TEST_TIMEOUT_SECONDS: 120

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: api-test-results
        path: test/results/api/
        retention-days: 7

  ui-tests:
    name: UI Tests
    runs-on: ubuntu-latest
    needs: api-tests

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'

    - name: Install Chrome dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          chromium-browser \
          chromium-chromedriver \
          libnss3 \
          libgbm1 \
          libasound2 \
          libatk1.0-0 \
          libatk-bridge2.0-0 \
          libcups2 \
          libdrm2 \
          libxkbcommon0 \
          libxcomposite1 \
          libxdamage1 \
          libxrandr2 \
          fonts-liberation

    - name: Download dependencies
      run: go mod download

    - name: Build application
      run: |
        mkdir -p bin test/bin
        CGO_ENABLED=0 go build -o bin/quaero ./cmd/quaero
        cp bin/quaero test/bin/quaero

    - name: Setup test environment
      run: |
        # Create test directories
        mkdir -p test/bin/pages test/bin/job-definitions test/bin/variables test/bin/data
        mkdir -p test/bin/quaero-chrome-extension test/bin/bin/connectors

        # Copy pages for UI
        cp -r pages test/bin/

        # Copy Chrome extension
        cp -r cmd/quaero-chrome-extension test/bin/ || true

        # Copy test config files
        cp test/config/test-quaero.toml test/bin/quaero.toml

        # Copy job definitions
        cp -r test/config/job-definitions/* test/bin/job-definitions/ || true

        # Copy variables
        cp -r test/config/variables/* test/bin/variables/ || true

        # Copy connectors
        cp -r test/config/connectors/* test/bin/bin/connectors/ || true

    - name: Run UI tests
      run: |
        cd test/ui
        go test -v -timeout 15m ./...
      env:
        TEST_MODE: integration
        TEST_TIMEOUT_SECONDS: 180
        CHROMEDP_NO_SANDBOX: "true"
        CHROME_PATH: /usr/bin/chromium-browser

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ui-test-results
        path: test/results/ui/
        retention-days: 7

  docker-test:
    name: Docker Test Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build test image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./deployments/docker/Dockerfile.test
        push: false
        tags: quaero-test:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Test Docker image builds correctly
      run: |
        docker run --rm quaero-test:latest /app/bin/quaero --version || echo "Version check completed"
