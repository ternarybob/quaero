# ASX Stocks Daily Analysis - Orchestrated Version
# =========================================================================
# Uses the OrchestratorWorker with Planner-Executor-Reviewer loop for
# dynamic, goal-based execution of stock analysis.
#
# KEY DIFFERENCES from static asx-stocks-daily.toml:
# - Single orchestrator step instead of multiple job_template steps
# - LLM-based planning decides which tools to call and in what order
# - Recovery logic if data collection fails
#
# TOOL ORCHESTRATION PATTERN:
# 1. PLANNER: LLM decides which tools to call (forced tool use - no fabrication)
# 2. EXECUTOR: Each tool call becomes a separate queue job (tool_execution type)
#    - Visible in queue UI with independent status tracking
#    - Parallel execution where possible
#    - Independent failure handling
# 3. REVIEWER: LLM validates goal achievement and synthesizes results
#
# VARIABLES:
# Global variables are declared once at job level in [config] section.
# The orchestrator reads these variables to know which stocks to analyze.
# =========================================================================

id = "asx-stocks-daily-orchestrated"
name = "ASX Daily Stock Analysis (Thinking)"
type = "orchestrator"
description = "AI-powered stock analysis using dynamic planning and execution"
tags = ["asx", "stocks", "daily", "orchestrator", "thinking"]
schedule = ""
timeout = "2h"
enabled = true
auto_start = false

# =========================================================================
# Orchestrator Configuration
# =========================================================================

# Global variables - the orchestrator reads these to know what to analyze
# Available variable keys: ticker, name, industry
[config]
variables = [
    { ticker = "GNP", name = "GenusPlus Group Ltd", industry = "infrastructure" },
    # { ticker = "CBA", name = "Commonwealth Bank", industry = "banking" },
    # { ticker = "WES", name = "Wesfarmers", industry = "retail" },
    # { ticker = "EXR", name = "Elixir Energy", industry = "energy" },
    # { ticker = "SRL", name = "Sunrise Energy Metals", industry = "mining" },
    # { ticker = "ROC", name = "RocketBoots Limited", industry = "AI" },
]

# =========================================================================
# Orchestrator Step - Dynamic Planning and Execution
# =========================================================================

[step.analyze_stocks]
type = "orchestrator"
description = "AI-powered stock analysis with dynamic planning"
on_error = "continue"

# Natural language goal - the LLM will plan how to achieve this
goal = """
Perform a comprehensive daily analysis of all ASX stocks in the variables list.

For EACH stock in the list:
1. Collect current market data (prices, volume, technical indicators)
2. Fetch recent ASX announcements
3. Search for financial news and analyst coverage
4. Analyze announcements for signal vs noise
5. Generate a stock summary with key metrics
6. Create a BUY/SELL/HOLD recommendation with conviction score

If data collection fails for any stock:
- Note the failure explicitly
- Attempt alternative data sources (web search)
- Continue with remaining stocks

Final output should include:
- Individual stock reports
- Summary table of all recommendations
- Any alerts for significant price movements or announcements
"""

# Thinking level for LLM reasoning depth
thinking_level = "HIGH"

# Model preference (auto selects based on task complexity)
model_preference = "auto"

# Available tools - workers exposed to the orchestrator as callable tools
# Each tool becomes a tool_execution queue job when invoked:
# - name: Tool identifier used by the planner
# - description: Human-readable description for LLM context
# - worker: The worker type that executes this tool
# - template: (optional) For job_template workers, the template to execute
available_tools = [
    { name = "fetch_stock_data", description = "Fetch ASX stock prices and technical indicators", worker = "asx_stock_data" },
    { name = "fetch_announcements", description = "Fetch ASX company announcements", worker = "asx_announcements" },
    { name = "search_web", description = "Search web for financial news", worker = "web_search" },
    { name = "analyze_summary", description = "Generate LLM-based analysis summary", worker = "summary" },
    { name = "run_stock_review", description = "Execute stock review template", worker = "job_template", template = "asx-stock-review" },
    { name = "run_data_collection", description = "Execute data collection template", worker = "job_template", template = "asx-stock-data" }
]

# Output tags - allows email step to find this document via body_from_tag
output_tags = ["stock-recommendation"]

# =========================================================================
# Email Step - Send consolidated report
# =========================================================================

[step.email_report]
type = "email"
description = "Email consolidated stock analysis report"
depends = "analyze_stocks"
on_error = "fail"
to = "bobmcallan@gmail.com"
subject = "ASX Daily Stock Analysis - AI-Powered Report"
body_from_tag = "stock-recommendation"
