# Combined Portfolio Newsletter
# =========================================================================
# Generates newsletter combining Navexa portfolio holdings with additional watchlist tickers
#
# WORKFLOW:
# 1. Fetch Portfolio: Get holdings from Navexa portfolio
# 2. Fetch News: Get news for portfolio holdings
# 3. Fetch Metadata: Get company metadata for holdings
# 4. Generate Newsletter: AI-generated newsletter content
# 5. Format Email: Format output for email delivery
# 6. Send Email: Deliver newsletter via email
#
# OUTPUT TAG: newsletter-output
# =========================================================================

# =========================================================================
# Job Definition (MUST be at root level before any [section])
# =========================================================================
id = "portfolio-newsletter-combined"
name = "Portfolio Newsletter (Navexa - SMSF)"
type = "orchestrator"
description = "Generate newsletter combining Navexa portfolio and watchlist"
tags = ["newsletter", "combined", "portfolio"]
schedule = ""
timeout = "15m"
enabled = true
auto_start = false

# =========================================================================
# META (documentation only, not parsed)
# =========================================================================
[meta]
author = "Claude Code"
version = "1.0"
created = "2026-01-20"
updated = "2026-01-20"
purpose = "Combined newsletter from Navexa portfolio and watchlist tickers"

# =========================================================================
# User Configuration
# =========================================================================
[config]
# Portfolio name for Navexa
portfolio_name = "SMSF"

# Additional watchlist tickers (optional)
# variables = [
#   { ticker = "ASX:GNP" },
#   { ticker = "ASX:CGS" },
# ]

# =========================================================================
# Step 1: Fetch Portfolio
# =========================================================================
[step.fetch_portfolio]
type = "navexa_portfolio"
description = "Fetch portfolio holdings from Navexa"
on_error = "fail"
name = "{config.portfolio_name}"
output_tags = ["fetch_news", "fetch_metadata"]

# =========================================================================
# Step 2: Fetch News
# =========================================================================
[step.fetch_news]
type = "ticker_news"
description = "Fetch news for portfolio holdings"
depends = "fetch_portfolio"
on_error = "continue"
period = "M1"
cache_hours = 24
output_tags = ["generate_newsletter"]

# =========================================================================
# Step 3: Fetch Metadata
# =========================================================================
[step.fetch_metadata]
type = "ticker_metadata"
description = "Fetch company metadata for holdings"
depends = "fetch_portfolio"
on_error = "continue"
cache_hours = 168
output_tags = ["generate_newsletter"]

# =========================================================================
# Step 4: Generate Newsletter
# =========================================================================
[step.generate_newsletter]
type = "portfolio_newsletter"
description = "Generate newsletter content"
depends = "fetch_news,fetch_metadata"
on_error = "fail"
portfolio = "combined"
model = "gemini"
output_tags = ["format_email"]

# =========================================================================
# Step 5: Format Email
# =========================================================================
[step.format_email]
type = "output_formatter"
description = "Format newsletter for email"
depends = "generate_newsletter"
on_error = "fail"
format = "html"
title = "Combined Portfolio Newsletter"
output_tags = ["send_email"]

# =========================================================================
# Step 6: Send Email
# =========================================================================
[step.send_email]
type = "email"
description = "Send newsletter via email"
depends = "format_email"
always_run = true
on_error = "fail"
to = "{email_recipient}"
subject = "Combined Portfolio Newsletter"
