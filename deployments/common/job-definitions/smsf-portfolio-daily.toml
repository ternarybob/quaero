# SMSF Aggressive Portfolio Review - Daily Analysis Job
# ===========================================================================
# This job orchestrates the SMSF Portfolio Review for an aggressive SMSF
# portfolio. It runs individual stock analyses using the asx-stock-review
# template, then consolidates all results into a single portfolio review with
# BUY|SELL|HOLD recommendations and SMSF compliance notes.
#
# STRATEGY: Aggressive 100% Australian Equities
# PERSONA: Senior Investment Strategist specializing in Australian SMSFs
#
# WORKFLOW:
# 1. Run smsf-portfolio-review template for each stock (parallel child jobs)
# 2. Generate consolidated portfolio summary with all stocks compared
# 3. Email single portfolio review to SMSF Investment Committee
# ===========================================================================

id = "smsf-portfolio-daily"
name = "SMSF Aggressive Portfolio Review"
type = "job_template"
description = "Senior Investment Strategist review for aggressive SMSF portfolio - BUY|SELL|HOLD recommendations with conviction scoring"
tags = ["smsf", "aggressive", "asx", "stocks", "daily", "template", "portfolio"]
schedule = ""
timeout = "3h"
enabled = true
auto_start = false

# ===========================================================================
# Step 1a: Fetch Benchmark Index Data
# ===========================================================================
# Executes the asx-index-review template for each configured benchmark index.
# Each index becomes a child job with data collection.
# Runs in parallel with stock analysis (no depends).

[step.fetch_benchmark_indices]
type = "job_template"
description = "Execute ASX Index Review template for benchmark indices"
on_error = "continue"
template = "asx-index-review"

# Variables array - each entry creates a separate job from the template
# Available variable keys: code, name
# Variable references in template: {index:code}, {index:name}, {index:code_lower}
variables = [
    { code = "XJO", name = "S&P/ASX 200" },
    { code = "XSO", name = "S&P/ASX Small Ordinaries" },
]

# ===========================================================================
# Step 1b: Run Individual Stock Analyses
# ===========================================================================
# Executes the smsf-portfolio-review template for each stock.
# Each stock becomes a child job with its own analysis.
# This step completes when ALL child jobs finish.

[step.run_smsf_analysis]
type = "job_template"
description = "Execute SMSF Portfolio Review template for each configured stock"
on_error = "continue"
template = "asx-stock-review"
parallel = true

# Variables array - each entry creates a separate job from the template
# Available variable keys: ticker, name, industry, units, avg_price, date_added
# Variable references in template: {stock:ticker}, {stock:name}, {stock:industry}
# Modifiers: {stock:ticker_lower}, {stock:ticker_upper}
# Portfolio data: units (number of shares), avg_price (average purchase price), date_added (YYYY-MM-DD)
variables = [
    # Technology & AI (High Growth)
    { ticker = "ROC", name = "RocketBoots Limited", industry = "AI", units = 10000, avg_price = 0.45, date_added = "2024-06-15" },

    # Industrials
    { ticker = "GNP", name = "GenusPlus Group Ltd", industry = "infrastructure", units = 5000, avg_price = 2.10, date_added = "2024-03-20" },
    # Technology
    # { ticker = "XRO", name = "Xero Limited", industry = "technology", units = 100, avg_price = 120.00, date_added = "2023-11-01" },
    # { ticker = "WTC", name = "WiseTech Global", industry = "technology", units = 50, avg_price = 85.00, date_added = "2024-01-15" },

    # Healthcare (Growth Sector)
    # { ticker = "CSL", name = "CSL Limited", industry = "healthcare", units = 30, avg_price = 280.00, date_added = "2023-06-01" },
    # { ticker = "PME", name = "Pro Medicus", industry = "healthcare", units = 20, avg_price = 95.00, date_added = "2024-02-10" },

    # Resources & Mining (Cyclical Growth)
    # { ticker = "BHP", name = "BHP Group", industry = "mining", units = 200, avg_price = 45.00, date_added = "2023-09-01" },
    # { ticker = "RIO", name = "Rio Tinto", industry = "mining", units = 100, avg_price = 115.00, date_added = "2023-08-15" },
    # { ticker = "FMG", name = "Fortescue Metals", industry = "mining", units = 300, avg_price = 22.00, date_added = "2024-04-01" },
    # { ticker = "LTR", name = "Liontown Resources", industry = "lithium", units = 5000, avg_price = 1.20, date_added = "2024-05-01" },

    # Energy (Transition Play)
    # { ticker = "WDS", name = "Woodside Energy", industry = "energy", units = 150, avg_price = 32.00, date_added = "2023-12-01" },
    # { ticker = "STO", name = "Santos Limited", industry = "energy", units = 400, avg_price = 7.50, date_added = "2024-01-20" },

    # Small/Mid Cap Growth
    # { ticker = "LNK", name = "Link Administration", industry = "fintech", units = 1000, avg_price = 1.80, date_added = "2024-07-01" },
    # { ticker = "TYR", name = "Tyro Payments", industry = "fintech", units = 2000, avg_price = 0.95, date_added = "2024-06-01" },
]

# ===========================================================================
# Step 2: Generate Consolidated Portfolio Summary
# ===========================================================================
# After all individual stock analyses complete, this step reads ALL
# smsf-recommendation documents and creates a portfolio-level view
# with consolidated BUY|SELL|HOLD recommendations.

[step.generate_portfolio_summary]
type = "summary"
description = "Generate consolidated SMSF aggressive portfolio review with all stocks"
depends = "run_smsf_analysis, fetch_benchmark_indices"
on_error = "fail"
filter_tags = ["smsf-portfolio"]
api_key = "{google_gemini_api_key}"
thinking_level = "HIGH"
prompt = """You are a Senior Investment Strategist preparing a consolidated SMSF portfolio review for an aggressive, 100% Australian Equities fund. Generate a 30-day "If-Then" Decision Matrix and Compliance Stress Test.

You have received:
1. Individual SMSF Portfolio Review reports for multiple ASX stocks (tagged smsf-recommendation)
2. S&P/ASX 200 (XJO) benchmark data (tagged benchmark, xjo) - use for "Portfolio Health vs S&P/ASX 200"
3. Small Ordinaries (XSO) benchmark data (tagged benchmark, xso) - use for "Portfolio Health vs Small Ordinaries"
4. Portfolio holdings data from the variables section (units, avg_price, date_added per stock)

Your task is to consolidate these into a SINGLE portfolio review document with risk-adjusted actions and forensic analysis.

# SMSF AGGRESSIVE PORTFOLIO REVIEW: CONSOLIDATED ASSESSMENT
## Prepared for: SMSF Investment Committee
## Strategy: Aggressive 100% Australian Equities
## Analysis Date: [Use the current date provided in the system context above]

---

## EXECUTIVE SUMMARY

**PORTFOLIO HEALTH vs S&P/ASX 200**: [Outperforming / In Line / Underperforming]
**PORTFOLIO HEALTH vs Small Ordinaries**: [Outperforming / In Line / Underperforming]

Based on the individual stock analyses, provide a high-level view of:
- Number of stocks reviewed: X
- Overall portfolio quality score: X/10
- Aggressive strategy alignment: [Strong / Moderate / Weak]
- Total Portfolio Value: $X (calculated from units × current price)
- Total Unrealized Gain/Loss: $X (X%)

[2-3 sentence summary of portfolio health and key actions required]

---

## UNREALIZED GAIN/LOSS TABLE

Calculate the Unrealized Gain/Loss for each position using the provided units and avg_price:

| Ticker | Units | Avg Price | Current Price | Cost Basis | Current Value | Unrealized P/L | P/L % |
|--------|-------|-----------|---------------|------------|---------------|----------------|-------|
| [XXX] | X | $X.XX | $X.XX | $X | $X | $X | X% |
| ... | ... | ... | ... | ... | ... | ... | ... |
| **TOTAL** | - | - | - | **$X** | **$X** | **$X** | **X%** |

---

## PERFORMANCE vs BENCHMARK (Since Date Added)

Compare individual stock performance against XJO and XSO from each stock's date_added:

| Ticker | Date Added | Stock Return | XJO Return (same period) | XSO Return (same period) | Alpha vs XJO | Alpha vs XSO |
|--------|------------|--------------|--------------------------|--------------------------|--------------|--------------|
| [XXX] | [YYYY-MM-DD] | X% | X% | X% | X% | X% |
| ... | ... | ... | ... | ... | ... | ... |

**Portfolio Alpha Summary**:
- Stocks Outperforming XJO: X of Y
- Stocks Outperforming XSO: X of Y
- Weighted Portfolio Alpha vs XJO: X%

---

## GLOBAL MACRO & DEFENSE OVERLAY

### Key Macro Indicators

| Indicator | Current Level | Trend | Impact on Portfolio |
|-----------|--------------|-------|---------------------|
| US 10-Year Treasury Yield | X% | Rising/Stable/Falling | [Impact on growth valuations] |
| China Industrial Demand | Strong/Moderate/Weak | Expanding/Contracting | [Impact on infrastructure/resources] |
| RBA Cash Rate | X% | Rising/Stable/Falling | [Impact on Australian equities] |
| AUD/USD | $X.XX | Strengthening/Weakening | [Impact on export earners] |

### Macro Outlook Assessment

**OVERALL MACRO ENVIRONMENT**: [BULLISH / NEUTRAL / BEARISH]

**MANDATORY DEFENSIVE SIGNAL**:
If macro indicators are assessed as "BEARISH":
- ⚠️ **RECOMMEND**: Shift X% (suggested 10-15%) to cash buffers
- Rationale: [Specific macro concerns]
- Implementation: [Which positions to reduce]

If "NEUTRAL" or "BULLISH":
- ✓ No mandatory defensive action required
- Continue monitoring: [Key indicators to watch]

---

## STOCK-BY-STOCK RECOMMENDATION TABLE

Consolidate ALL stocks analyzed into this table:

| Ticker | Status (BUY/SELL/HOLD) | Conviction (1-10) | Primary Reason |
|--------|------------------------|-------------------|----------------|
| [XXX] | [BUY/SELL/HOLD] | [1-10] | [One-line reason from individual analysis] |
| ... | ... | ... | ... |

### Conviction Distribution
- High Conviction (7-10): X stocks
- Moderate Conviction (4-6): X stocks
- Low Conviction (1-3): X stocks

---

## 30-DAY "IF-THEN" DECISION MATRIX

Provide binary triggers for the next 30 days for each stock:

### ACCUMULATION TRIGGERS (BUY More)
| Ticker | Condition | Action | Target Units |
|--------|-----------|--------|--------------|
| [XXX] | If stays above [SMA 200 = $X.XX] AND [Specific KPI met, e.g., 4C cash flow >$Xm OR revenue target achieved] | BUY [X] additional units | Total: [X] units |
| ... | ... | ... | ... |

**KPI Examples to Monitor**:
- Quarterly 4C cash flow positive or >$X million
- Revenue run-rate exceeding $X million
- Contract wins valued at >$X million
- Customer acquisition rate above prior quarter

### EXIT TRIGGERS (SELL)
| Ticker | Condition | Action | Reason |
|--------|-----------|--------|--------|
| [XXX] | If closes below [Support = $X.XX] OR [Macro Threshold: US 10yr Yield >4.5% OR AUD/USD <0.62] | SELL [X]% of position | [Risk mitigation reason] |
| ... | ... | ... | ... |

**Macro Threshold Triggers**:
- US 10-Year Treasury Yield >4.5% = Sell growth positions (valuation compression)
- US 10-Year Treasury Yield >5.0% = Mandatory 15% cash buffer
- AUD/USD <$0.62 = Review export-exposed holdings
- China PMI <48 = Sell resources/infrastructure exposure
- RBA rate hike = Reduce leverage-sensitive positions

### HOLD TRIGGERS (No Action Unless...)
| Ticker | Watch For | Change Recommendation If |
|--------|-----------|-------------------------|
| [XXX] | [Key event/level] | [Condition that changes to BUY or SELL] |
| ... | ... | ... |

---

## THE "WHY": DETAILED JUSTIFICATIONS

### SELL Recommendations (if any)
For each SELL recommendation, provide detailed justification:

**[Ticker] - [Company Name]**
- Conviction: X/10
- Primary Reason: [From individual analysis]
- Exit Strategy: [Immediate / Staged]
- Suggested Replacement: [From alternatives in individual analysis]

### HOLD Recommendations (if any)
For each HOLD recommendation, provide detailed justification:

**[Ticker] - [Company Name]**
- Conviction: X/10
- Reason for Not Selling: [Evidence from analysis]
- Reason for Not Buying More: [Evidence from analysis]
- Review Trigger: [What would change this to BUY or SELL]

---

## ALTERNATIVE REPLACEMENTS

From all individual analyses, consolidate the top 2-3 ASX stocks NOT in the portfolio that offer better risk-adjusted growth:

| Alternative | Ticker | Industry | Why Better | Replaces |
|-------------|--------|----------|------------|----------|
| [Company 1] | [XXX] | [Sector] | [Key advantage] | [Which holding to replace] |
| [Company 2] | [XXX] | [Sector] | [Key advantage] | [Which holding to replace] |
| [Company 3] | [XXX] | [Sector] | [Key advantage] | [General portfolio improvement] |

---

## SECTOR ALLOCATION ANALYSIS

| Sector | # Stocks | Recommendation Distribution | Sector Outlook |
|--------|----------|----------------------------|----------------|
| [Sector] | X | X BUY, X HOLD, X SELL | [Positive/Neutral/Negative] |
| ... | ... | ... | ... |

### Sector Concentration Concerns
- [Identify any over-concentration in specific sectors]
- [Recommendations for rebalancing if needed]

---

## SMSF LIQUIDITY & CONCENTRATION AUDIT

### Liquidity Stress Test

Identify if the user's position represents >10% of the stock's Average Daily Volume (ADV) and calculate "Days to Exit":

| Ticker | Units Held | Avg Daily Volume | Position as % of ADV | Days to Exit | Liquidity Risk |
|--------|------------|------------------|---------------------|--------------|----------------|
| [XXX] | X | X | X% | X days | [NORMAL / ELEVATED / HIGH] |
| ... | ... | ... | ... | ... | ... |

**Days to Exit Calculation**: Units Held ÷ (ADV × 0.25) = Days (assuming max 25% of daily volume per day)

**Liquidity Risk Classification**:
- **NORMAL** (<1 day): Position can be exited in a single trading session
- **ELEVATED** (1-2 days): Position requires 1-2 days to exit without market impact
- **HIGH LIQUIDITY RISK** (>2 days): Position takes >2 days to exit - requires staged exit strategy

**Liquidity Flags**:
- ⚠️ **HIGH LIQUIDITY RISK** (>2 days to exit): [List tickers] - Staged exit over multiple days required
- ⚠️ **DIFFICULT EXIT** (>10% of ADV): [List tickers] - Single-day exit would significantly impact price
- **Action Required**: [Specific recommendations for illiquid positions]

### Concentration Warning

**Single Stock Concentration Check** (>20% of portfolio = ATO compliance risk):

| Ticker | Current Value | % of Portfolio | Status |
|--------|--------------|----------------|--------|
| [XXX] | $X | X% | [OK / ⚠️ OVER 20%] |
| ... | ... | ... | ... |

**Concentration Flags**:
- ⚠️ **ATO COMPLIANCE RISK**: [List tickers exceeding 20%]
- For "Stable yet Aggressive" strategy, holdings >20% require documented justification
- **Recommended Action**: [Rebalancing suggestions]

### SMSF Compliance Summary

Per ATO requirements, SMSF trustees must ensure investments align with documented Investment Strategy:
- **Risk Tolerance**: Aggressive (100% growth assets) - [Appropriate / Requires Review]
- **Diversification**: [Adequate / Requires Attention due to concentration]
- **Liquidity**: [Sufficient / Review required due to ADV flags]
- **Single Asset Rule**: [Compliant / Non-compliant]
- **Insurance Needs**: [Consider life insurance requirements]

### Compliance Actions Required
1. [Action 1 - if any concentration issues]
2. [Action 2 - if any liquidity issues]
3. [Action 3 - documentation requirements]

---

## PRIORITY ACTION LIST

### Immediate Actions (Priority 1)
For SELL recommendations with High Conviction:
| Action | Stock | Reason | Target |
|--------|-------|--------|--------|
| SELL | [Ticker] | [Reason] | Exit by [date/price] |

### Near-Term Actions (Priority 2)
For BUY recommendations with High Conviction:
| Action | Stock | Reason | Target |
|--------|-------|--------|--------|
| BUY | [Ticker] | [Reason] | Entry at $X.XX |

### Monitor (Priority 3)
HOLD recommendations and low conviction actions:
| Stock | Watch For | Trigger |
|-------|-----------|---------|
| [Ticker] | [Event] | [What would change recommendation] |

---

## FOLLOW-UP PROTOCOL

This analysis supports the following follow-up queries:
- "Analyze a 20% shift into [Sector X]" - Portfolio rebalancing simulation
- "Stress test this portfolio against a 10% market correction" - Downside scenario
- "Find mid-cap alternatives with higher R&D-to-revenue ratios" - Growth screening
- "Calculate portfolio impact if [Macro Event] occurs" - Scenario analysis

---

## PORTFOLIO RISK SUMMARY

| Risk Category | Level | Mitigation |
|--------------|-------|------------|
| Market Risk | [Low/Med/High] | [Action if High] |
| Sector Concentration | [Low/Med/High] | [Action if High] |
| Single Stock Risk | [Low/Med/High] | [Action if High] |
| Liquidity Risk | [Low/Med/High] | [Action if High] |
| Macro Risk | [Low/Med/High] | [Action if High - see Defensive Signal] |

**OVERALL PORTFOLIO RISK**: [Low / Moderate / High]

---

## NEXT REVIEW

- **Recommended Review Date**: [4-6 weeks from analysis date]
- **Key Events to Monitor**: [Upcoming earnings, economic events, macro indicators]
- **Trigger for Early Review**: [Market correction > 5%, major company news, macro shift]

---

**DISCLAIMER**: This portfolio review uses formal financial methodology for SMSF investment decisions.
This is general information only and not personal financial advice.
SMSF trustees should consult licensed advisers for investment decisions.
Constraint: Only ASX-listed stocks considered.
"""
output_tags = ["smsf-portfolio-review", "smsf-portfolio", "portfolio-summary"]

# ===========================================================================
# Step 3: Email Consolidated Portfolio Report
# ===========================================================================
# Sends the single consolidated portfolio review email.

[step.email_portfolio_report]
type = "email"
description = "Email consolidated SMSF aggressive portfolio review"
depends = "generate_portfolio_summary"
on_error = "fail"
to = "bobmcallan@gmail.com"
subject = "SMSF Aggressive Portfolio Review - Consolidated Stock Analysis"
body_from_tag = "smsf-portfolio-review"
