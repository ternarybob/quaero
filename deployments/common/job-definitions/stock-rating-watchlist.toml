# Stock Rating Watchlist
# =========================================================================
# Calculates investability ratings for a watchlist of stocks using the
# deterministic rating pipeline: BFS, CDS, NFR, PPS, VRS, OB -> Composite
#
# WORKFLOW:
# 1. Fetch market data (fundamentals, announcements, price data)
# 2. Calculate component scores (can run in parallel after data fetch)
# 3. Calculate composite rating (depends on all component scores)
# 4. Email report with ratings summary
#
# TICKERS: EXR, GNP, SKS, TWR
# OUTPUT TAG: stock-rating
# =========================================================================

# =========================================================================
# Job Definition
# =========================================================================
id = "stock-rating-watchlist"
name = "Stock Rating - Watchlist"
type = "orchestrator"
description = "Calculate investability ratings for watchlist stocks"
tags = ["rating", "watchlist", "investability", "email"]
schedule = ""
timeout = "2h"
enabled = true
auto_start = false

# =========================================================================
# META
# =========================================================================
[meta]
author = "Quaero"
version = "1.0"
created = "2026-01-08"
updated = "2026-01-08"
purpose = "Investability rating calculation for watchlist stocks"

# =========================================================================
# User Configuration - Ticker List
# =========================================================================

[config]
variables = [
    { ticker = "EXR" },
    { ticker = "GNP" },
    { ticker = "SKS" },
    { ticker = "TWR" },
]

# =========================================================================
# Step 1: Fetch Fundamentals
# =========================================================================
[step.fetch_fundamentals]
type = "market_fundamentals"
description = "Fetch stock fundamentals for rating calculation"
on_error = "continue"
period = "Y2"
output_tags = ["calculate_bfs", "calculate_cds"]  # steps that depend on this

# =========================================================================
# Step 2: Fetch Announcements
# =========================================================================
[step.fetch_announcements]
type = "market_announcements"
description = "Fetch company announcements for rating calculation"
on_error = "continue"
period = "Y1"
limit = 500
output_tags = ["calculate_cds", "calculate_nfr", "calculate_pps", "calculate_ob"]  # steps that depend on this

# =========================================================================
# Step 3: Fetch Price Data
# =========================================================================
[step.fetch_price_data]
type = "market_data"
description = "Fetch price history for rating calculation"
on_error = "continue"
period = "2y"
output_tags = ["calculate_pps", "calculate_vrs"]  # steps that depend on this

# =========================================================================
# Step 4: Calculate BFS (Business Foundation Score)
# =========================================================================
[step.calculate_bfs]
type = "rating_bfs"
description = "Calculate Business Foundation Score (0-2)"
depends = "fetch_fundamentals"
on_error = "continue"
# input_tags defaults to ["calculate_bfs"] (step name)
output_tags = ["calculate_ob", "calculate_composite"]  # steps that depend on this

# =========================================================================
# Step 5: Calculate CDS (Capital Discipline Score)
# =========================================================================
[step.calculate_cds]
type = "rating_cds"
description = "Calculate Capital Discipline Score (0-2)"
depends = "fetch_fundamentals,fetch_announcements"
on_error = "continue"
months = 36
# input_tags defaults to ["calculate_cds"] (step name)
output_tags = ["calculate_composite"]  # steps that depend on this

# =========================================================================
# Step 6: Calculate NFR (Narrative-to-Fact Ratio)
# =========================================================================
[step.calculate_nfr]
type = "rating_nfr"
description = "Calculate Narrative-to-Fact Ratio (0-1)"
depends = "fetch_announcements"
on_error = "continue"
# input_tags defaults to ["calculate_nfr"] (step name)
output_tags = ["calculate_composite"]  # steps that depend on this

# =========================================================================
# Step 7: Calculate PPS (Price Progression Score)
# =========================================================================
[step.calculate_pps]
type = "rating_pps"
description = "Calculate Price Progression Score (0-1)"
depends = "fetch_announcements,fetch_price_data"
on_error = "continue"
# input_tags defaults to ["calculate_pps"] (step name)
output_tags = ["calculate_composite"]  # steps that depend on this

# =========================================================================
# Step 8: Calculate VRS (Volatility Regime Stability)
# =========================================================================
[step.calculate_vrs]
type = "rating_vrs"
description = "Calculate Volatility Regime Stability (0-1)"
depends = "fetch_price_data"
on_error = "continue"
# input_tags defaults to ["calculate_vrs"] (step name)
output_tags = ["calculate_composite"]  # steps that depend on this

# =========================================================================
# Step 9: Calculate OB (Optionality Bonus)
# =========================================================================
[step.calculate_ob]
type = "rating_ob"
description = "Calculate Optionality Bonus (0, 0.5, 1)"
depends = "calculate_bfs,fetch_announcements"
on_error = "continue"
# input_tags defaults to ["calculate_ob"] (step name)
output_tags = ["calculate_composite"]  # steps that depend on this

# =========================================================================
# Step 10: Calculate Composite Rating
# =========================================================================
[step.calculate_composite]
type = "rating_composite"
description = "Calculate final investability rating"
depends = "calculate_bfs,calculate_cds,calculate_nfr,calculate_pps,calculate_vrs,calculate_ob"
on_error = "fail"
# input_tags defaults to ["calculate_composite"] (step name)
output_tags = ["email_report"]  # next step name

# =========================================================================
# Step 11: Email Report
# =========================================================================
[step.email_report]
type = "email"
description = "Email stock ratings summary"
depends = "calculate_composite"
always_run = true
on_error = "fail"
to = "bobmcallan@gmail.com"
subject = "Stock Rating - Watchlist Summary"
style = "proforma"
# input_tags defaults to ["email_report"] (step name)
base_url = "http://localhost:8085"
