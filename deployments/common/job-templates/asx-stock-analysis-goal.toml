# ASX Stock Analysis - Orchestrator Goal Template
# =========================================================================
# Reusable goal and tools for ASX stock analysis.
# Referenced by job definitions via goal_template = "asx-stock-analysis-goal"
#
# This template defines:
# - The analysis goal (phases, output requirements)
# - Available tools for the orchestrator
# - Thinking level and model preferences
# - Output tags for downstream steps
#
# Variables are provided by the referencing job definition in [config].
# Expected variable keys: ticker, name, industry
# Expected benchmarks: code, name (e.g., XJO, S&P/ASX 200)
# =========================================================================

id = "asx-stock-analysis-goal"
name = "ASX Stock Analysis Goal Template"
type = "orchestrator_template"
description = "Reusable goal and tools for AI-powered ASX stock analysis"

[template]
# Thinking level for LLM reasoning depth
thinking_level = "HIGH"

# Model preference (auto selects based on task complexity)
model_preference = "auto"

# Output tags - allows email step to find this document via body_from_tag
output_tags = ["stock-recommendation"]

# Available tools - workers exposed to the orchestrator as callable tools
available_tools = [
    { name = "fetch_stock_data", description = "Fetch ASX stock prices, historical data, and technical indicators. Creates document tagged with ['asx-stock-data', '<ticker>']. REQUIRED params: asx_code (string). OPTIONAL: period (string) - M1, M3, M6, Y1, Y2, Y5 (default Y1). Use period=Y5 for 5-year historical analysis. Provides: current price, OHLCV history, SMA20/50/200, RSI14, support/resistance, period performance (7D, 1M, 3M, 6M, 1Y, 2Y returns).", worker = "asx_stock_data" },
    { name = "fetch_announcements", description = "Fetch official ASX company announcements with price sensitivity flags. Creates document tagged with ['asx-announcement', '<ticker>']. REQUIRED params: asx_code (string). OPTIONAL: period (string) - D1, W1, M1, M3, M6, Y1, Y5 (default Y1), limit (int) - max announcements. Use for FY/HY results, trading updates, contracts. Each announcement includes: date, headline, type, price_sensitive flag, PDF link.", worker = "asx_announcements" },
    { name = "fetch_index_data", description = "Fetch ASX index data for benchmarks (XJO, XSO). Creates document tagged with ['asx-index', '<code>', 'benchmark']. REQUIRED params: asx_code (string) - e.g. 'XJO', 'XSO'. Provides: current value, period performance, OHLCV history, technicals.", worker = "asx_stock_data" },
    { name = "search_web", description = "Search web for financial news, analyst reports, and company research. Creates document tagged with ['web-search']. REQUIRED params: query (string). Use for: analyst coverage, broker notes, news, historical financial data (revenue/profit history), competitor analysis. Useful for data not available from ASX APIs.", worker = "web_search" },
    { name = "analyze_summary", description = "Generate deep LLM-based analysis from collected documents. REQUIRED params: prompt (string) - detailed analysis instructions, filter_tags (array) - tags to filter documents. OPTIONAL: thinking_level (string) - LOW or HIGH (use HIGH for complex analysis like FY results deep dive, signal/noise rating). For stock data use ['asx-stock-data', '<ticker>'], for announcements use ['asx-announcement', '<ticker>'].", worker = "summary" },
]

# Natural language goal - the LLM will plan how to achieve this
goal = """
Perform a comprehensive daily analysis of all ASX stocks in the variables list.

=== PHASE 1: DATA COLLECTION (for EACH stock) ===

1. STOCK DATA: Fetch current market data with 5-year history
   - Use fetch_stock_data with period: Y5 for 5-year historical data
   - Captures: prices, volume, technical indicators, period performance

2. ANNOUNCEMENTS: Fetch 1-year of ASX announcements
   - Use fetch_announcements with period: Y1 (or M6 for recent focus)
   - Captures: all official ASX announcements with price sensitivity flags

3. NEWS: Search for financial news and analyst coverage
   - Use search_web for recent news, analyst reports, broker notes

4. BENCHMARK DATA:
   - Fetch ASX 200 (XJO) for market comparison

=== PHASE 2: DEEP ANALYSIS ===

5. ANNOUNCEMENT SIGNAL VS NOISE ANALYSIS
   For each announcement, rate its information value:
   - HIGH SIGNAL: Material financial data (FY/HY results, earnings guidance, major contracts, M&A)
   - MEDIUM SIGNAL: Operational updates, board changes, strategy updates
   - LOW SIGNAL (NOISE): Generic PR, routine notices, administrative filings
   Cross-reference price-sensitive flags and stock price movement on announcement dates.
   Calculate signal-to-noise ratio for the company's communication style.

6. FY/HY RESULTS DEEP DIVE
   Locate the most recent FY or HY results announcement and analyze:
   - KEY POSITIVES (list 3-5): Revenue growth, margin improvement, cash flow, strategic wins
   - KEY NEGATIVES (list 3-5): Cost pressures, debt levels, market headwinds, execution risks
   - YEAR-OVER-YEAR COMPARISON: Revenue, NPAT, EPS, dividend changes
   - MANAGEMENT OUTLOOK: Guidance, tone, and confidence level
   - MARKET REACTION: Share price movement following announcement
     * Day 1: +/-X% (immediate reaction)
     * Week 1: +/-X% (did reaction sustain or fade?)
     * Assessment: Was reaction proportionate to news quality?

6b. PRICE EVENT ANALYSIS
   Identify the 3-5 most significant share price movements in the past year:
   - For each major move (+/-10% or more in a week):
     * DATE: When did it occur?
     * MOVE: +/-X% over how many days?
     * CATALYST: What news/announcement triggered it? (if identifiable)
     * MARKET REACTION ASSESSMENT:
       - JUSTIFIED: Reaction proportionate to news significance
       - OVERREACTION: Price moved more than fundamentals warrant
       - UNDERREACTION: Price moved less than news significance suggests
       - KNEE-JERK: Initial spike/drop that reversed within days
     * CURRENT STATUS: Has the move held, reversed, or continued?

7. 5-YEAR COMPANY PERFORMANCE ANALYSIS
   Using historical stock data, analyze long-term trajectory:
   - STOCK PRICE PROGRESSION: 5-year CAGR, key inflection points
   - PERFORMANCE PHASES: Growth periods, consolidation, declines
   - PRICE VS MARKET: Performance vs ASX 200 (XJO) benchmark
   - VOLUME TRENDS: Institutional interest changes over time
   Note: Revenue/profit progression requires web search for historical financials.

8. COMPANY QUALITY ASSESSMENT
   Rate overall company quality (A/B/C/D/F) based on fundamental strength:
   - REVENUE TRAJECTORY: Growing, stable, or declining over 3-5 years
   - PROFIT TRAJECTORY: NPAT/margin trends, path to profitability
   - SHARE PRICE TRAJECTORY: Long-term capital appreciation vs destruction
   - QUALITY SCORE: A (excellent fundamentals), B (good), C (average), D (weak), F (poor/speculative)

   QUALITY REASONING (REQUIRED):
   Provide 2-3 sentences explaining WHY this company received its quality rating.
   Reference specific metrics: revenue growth %, profit margins, debt levels, share price CAGR.
   Example: "Quality B: Revenue grew 12% YoY with improving margins (8% to 11%), but high
   debt-to-equity (1.4x) and recent share price weakness (-15% vs XJO +8%) limit the rating."

9. STOCK SUMMARY with key metrics and technical levels

10. DUAL INVESTMENT RECOMMENDATIONS

   TRADER RECOMMENDATION (1-6 week horizon):
   - Focus: Technical momentum, short-term catalysts, volatility
   - Weighting: 70% technicals, 20% near-term catalysts, 10% fundamentals
   - Action: STRONG BUY / BUY / HOLD / SELL / STRONG SELL
   - Conviction: 1-10 score
   - Key triggers: Breakout levels, earnings dates, news catalysts
   - Suitable for: Active traders seeking short-term gains

   SUPER RECOMMENDATION (6-12+ month horizon):
   - Focus: Company quality, long-term value, sustainable growth
   - Weighting: 60% fundamentals/quality, 25% industry position, 15% technicals
   - Action: ACCUMULATE / HOLD / REDUCE / AVOID
   - Conviction: 1-10 score
   - Quality requirement: ONLY recommend ACCUMULATE for Quality A or B companies
   - For Quality C: Maximum recommendation is HOLD
   - For Quality D/F: Recommend REDUCE or AVOID regardless of technicals
   - Suitable for: SMSF, long-term investors, retirement portfolios

=== PHASE 3: SYNTHESIS ===

If data collection fails for any stock:
- Note the failure explicitly
- Attempt alternative data sources (web search)
- Continue with remaining stocks

FINAL OUTPUT MUST INCLUDE:
- Individual stock reports with all analysis sections above
- Summary table: Ticker | Name | Quality | Trader Rec | Trader Conv | Super Rec | Super Conv | Signal:Noise | 5Y CAGR
- Alerts for significant price movements or material announcements
- Overall watchlist assessment
- TRADER WATCHLIST: Stocks with momentum for short-term opportunities
- SUPER ACCUMULATE LIST: Quality A/B companies suitable for long-term investment
- DEFINITIONS (at end of report):
  * Quality Rating (A/B/C/D/F): Company fundamental strength grade
    - A (Excellent): Consistent revenue AND profit growth, share price appreciation, strong balance sheet
    - B (Good): Mostly positive trends with minor concerns
    - C (Average): Mixed results, some growth but also challenges
    - D (Weak): Declining trends in multiple areas, turnaround needed
    - F (Speculative): Pre-revenue, high-risk, or deteriorating fundamentals
  * Signal:Noise Ratio: Quality of company communications to ASX
    - HIGH (>70%): Most announcements contain material, actionable information
    - MEDIUM (40-70%): Mix of material updates and routine notices
    - LOW (<40%): Mostly routine/PR announcements with little investment substance
  * CAGR (Compound Annual Growth Rate): Annualized return over a period
    - Formula: (End Value / Start Value)^(1/Years) - 1
    - Example: 5Y CAGR of 15% = 15% average annual return compounded over 5 years
    - Interpretation: >15% excellent, 10-15% good, 5-10% average, <5% poor
"""

# Output schema for structured LLM output (Gemini ResponseSchema)
# When set, the LLM MUST return JSON matching this schema.
# The JSON is then converted to markdown for the final document.
[template.output_schema]
type = "object"
description = "Structured stock analysis with dual recommendations"
required = ["stocks", "summary_table", "watchlists", "definitions"]

[template.output_schema.properties.stocks]
type = "array"
description = "Individual stock analyses"

[template.output_schema.properties.stocks.items]
type = "object"
required = ["ticker", "name", "quality_rating", "signal_noise_ratio", "five_year_cagr", "trader_recommendation", "super_recommendation"]

[template.output_schema.properties.stocks.items.properties.ticker]
type = "string"
description = "ASX stock ticker code"

[template.output_schema.properties.stocks.items.properties.name]
type = "string"
description = "Company full name"

[template.output_schema.properties.stocks.items.properties.industry]
type = "string"
description = "Industry/sector classification"

[template.output_schema.properties.stocks.items.properties.stock_data_summary]
type = "string"
description = "Current price, market cap, P/E, EPS summary"

[template.output_schema.properties.stocks.items.properties.announcement_analysis]
type = "string"
description = "FY/HY results analysis and key announcements"

[template.output_schema.properties.stocks.items.properties.price_event_analysis]
type = "string"
description = "Significant price movements and catalysts"

[template.output_schema.properties.stocks.items.properties.five_year_performance]
type = "string"
description = "5-year CAGR and performance analysis"

[template.output_schema.properties.stocks.items.properties.quality_rating]
type = "string"
description = "Company quality grade"
enum = ["A", "B", "C", "D", "F"]

[template.output_schema.properties.stocks.items.properties.quality_reasoning]
type = "string"
description = "2-3 sentences explaining the quality rating"

[template.output_schema.properties.stocks.items.properties.signal_noise_ratio]
type = "string"
description = "Quality of company communications"
enum = ["HIGH", "MEDIUM", "LOW"]

[template.output_schema.properties.stocks.items.properties.five_year_cagr]
type = "number"
description = "5-year compound annual growth rate as decimal (e.g., 0.15 for 15%)"

[template.output_schema.properties.stocks.items.properties.trader_recommendation]
type = "object"
required = ["action", "conviction"]

[template.output_schema.properties.stocks.items.properties.trader_recommendation.properties.action]
type = "string"
enum = ["STRONG BUY", "BUY", "HOLD", "SELL", "STRONG SELL"]

[template.output_schema.properties.stocks.items.properties.trader_recommendation.properties.conviction]
type = "integer"
minimum = 1
maximum = 10

[template.output_schema.properties.stocks.items.properties.trader_recommendation.properties.triggers]
type = "string"
description = "Key triggers for the recommendation"

[template.output_schema.properties.stocks.items.properties.super_recommendation]
type = "object"
required = ["action", "conviction"]

[template.output_schema.properties.stocks.items.properties.super_recommendation.properties.action]
type = "string"
enum = ["ACCUMULATE", "HOLD", "REDUCE", "AVOID"]

[template.output_schema.properties.stocks.items.properties.super_recommendation.properties.conviction]
type = "integer"
minimum = 1
maximum = 10

[template.output_schema.properties.stocks.items.properties.super_recommendation.properties.rationale]
type = "string"
description = "Rationale for long-term investors"

[template.output_schema.properties.summary_table]
type = "array"
description = "Summary table of all stocks"

[template.output_schema.properties.summary_table.items]
type = "object"
required = ["ticker", "name", "quality", "trader_rec", "trader_conv", "super_rec", "super_conv", "signal_noise", "cagr"]

[template.output_schema.properties.summary_table.items.properties.ticker]
type = "string"

[template.output_schema.properties.summary_table.items.properties.name]
type = "string"

[template.output_schema.properties.summary_table.items.properties.quality]
type = "string"
enum = ["A", "B", "C", "D", "F"]

[template.output_schema.properties.summary_table.items.properties.trader_rec]
type = "string"
enum = ["STRONG BUY", "BUY", "HOLD", "SELL", "STRONG SELL"]

[template.output_schema.properties.summary_table.items.properties.trader_conv]
type = "integer"
minimum = 1
maximum = 10

[template.output_schema.properties.summary_table.items.properties.super_rec]
type = "string"
enum = ["ACCUMULATE", "HOLD", "REDUCE", "AVOID"]

[template.output_schema.properties.summary_table.items.properties.super_conv]
type = "integer"
minimum = 1
maximum = 10

[template.output_schema.properties.summary_table.items.properties.signal_noise]
type = "string"
enum = ["HIGH", "MEDIUM", "LOW"]

[template.output_schema.properties.summary_table.items.properties.cagr]
type = "string"
description = "5Y CAGR as percentage string (e.g., '15%')"

[template.output_schema.properties.watchlists]
type = "object"
description = "Categorized watchlists"

[template.output_schema.properties.watchlists.properties.trader_momentum]
type = "array"
description = "Stocks with momentum for short-term trades"

[template.output_schema.properties.watchlists.properties.trader_momentum.items]
type = "string"
description = "Ticker code"

[template.output_schema.properties.watchlists.properties.super_accumulate]
type = "array"
description = "Quality A/B stocks for long-term accumulation"

[template.output_schema.properties.watchlists.properties.super_accumulate.items]
type = "string"
description = "Ticker code"

[template.output_schema.properties.alerts]
type = "array"
description = "Significant alerts and material announcements"

[template.output_schema.properties.alerts.items]
type = "string"

[template.output_schema.properties.definitions]
type = "object"
description = "Definition of rating scales and metrics"

[template.output_schema.properties.definitions.properties.quality_rating]
type = "string"

[template.output_schema.properties.definitions.properties.signal_noise_ratio]
type = "string"

[template.output_schema.properties.definitions.properties.cagr]
type = "string"
