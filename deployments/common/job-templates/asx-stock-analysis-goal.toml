# ASX Stock Analysis - Orchestrator Goal Template
# =========================================================================
# Reusable goal and tools for ASX stock analysis.
# Referenced by job definitions via goal_template = "asx-stock-analysis-goal"
#
# This template defines:
# - The analysis goal (phases, output requirements)
# - Available tools for the orchestrator
# - Thinking level and model preferences
# - Output tags for downstream steps
#
# Variables are provided by the referencing job definition in [config].
# Expected variable keys: ticker, name, industry
# Expected benchmarks: code, name (e.g., XJO, S&P/ASX 200)
# =========================================================================

id = "asx-stock-analysis-goal"
name = "ASX Stock Analysis Goal Template"
type = "orchestrator_template"
description = "Reusable goal and tools for AI-powered ASX stock analysis"

[template]
# Thinking level for LLM reasoning depth
thinking_level = "HIGH"

# Model preference (auto selects based on task complexity)
model_preference = "auto"

# Output tags - allows email step to find this document via body_from_tag
output_tags = ["stock-recommendation"]

# Available tools - workers exposed to the orchestrator as callable tools
available_tools = [
    { name = "fetch_stock_data", description = "Fetch ASX stock prices, historical data, and technical indicators. Creates document tagged with ['asx-stock-data', '<ticker>']. REQUIRED params: asx_code (string). OPTIONAL: period (string) - M1, M3, M6, Y1, Y2, Y5 (default Y1). Use period=Y5 for 5-year historical analysis. Provides: current price, OHLCV history, SMA20/50/200, RSI14, support/resistance, period performance (7D, 1M, 3M, 6M, 1Y, 2Y returns).", worker = "asx_stock_data" },
    { name = "fetch_announcements", description = "Fetch official ASX company announcements with price sensitivity flags. Creates document tagged with ['asx-announcement', '<ticker>']. REQUIRED params: asx_code (string). OPTIONAL: period (string) - D1, W1, M1, M3, M6, Y1, Y5 (default Y1), limit (int) - max announcements. Use for FY/HY results, trading updates, contracts. Each announcement includes: date, headline, type, price_sensitive flag, PDF link.", worker = "asx_announcements" },
    { name = "fetch_index_data", description = "Fetch ASX index data for benchmarks (XJO, XSO). Creates document tagged with ['asx-index', '<code>', 'benchmark']. REQUIRED params: asx_code (string) - e.g. 'XJO', 'XSO'. Provides: current value, period performance, OHLCV history, technicals.", worker = "asx_stock_data" },
    { name = "fetch_analyst_coverage", description = "Fetch analyst coverage, broker ratings, and price targets. Creates document tagged with ['asx-analyst-coverage', '<ticker>']. REQUIRED params: asx_code (string). Provides: analyst count, consensus rating (buy/hold/sell), price target (mean/high/low/median), upside potential, recommendation distribution, recent upgrade/downgrades. PREFER this over search_web for analyst data.", worker = "asx_analyst_coverage" },
    { name = "fetch_historical_financials", description = "Fetch historical financial data (revenue, profit, EPS history). Creates document tagged with ['asx-historical-financials', '<ticker>']. REQUIRED params: asx_code (string). Provides: annual revenue/profit history, quarterly data, gross/net margins, EBITDA, cash flow, YoY growth rates, 3Y/5Y revenue CAGR. PREFER this over search_web for financial history.", worker = "asx_historical_financials" },
    { name = "search_web", description = "Search web for financial news and company research. Creates document tagged with ['web-search']. REQUIRED params: query (string). Use for: news, broker notes, competitor analysis, industry trends. NOTE: For analyst coverage use fetch_analyst_coverage instead. For financial history use fetch_historical_financials instead.", worker = "web_search" },
    { name = "analyze_summary", description = "Generate deep LLM-based analysis from collected documents. REQUIRED params: prompt (string) - detailed analysis instructions, filter_tags (array) - tags to filter documents. OPTIONAL: thinking_level (string) - LOW or HIGH (use HIGH for complex analysis like FY results deep dive, signal/noise rating). For stock data use ['asx-stock-data', '<ticker>'], for announcements use ['asx-announcement', '<ticker>'], for analyst coverage use ['asx-analyst-coverage', '<ticker>'], for financials use ['asx-historical-financials', '<ticker>'].", worker = "summary" },
]

# Natural language goal - the LLM will plan how to achieve this
goal = """
Perform a comprehensive daily analysis of all ASX stocks in the variables list.

=== PHASE 1: DATA COLLECTION (for EACH stock) ===

1. STOCK DATA: Fetch current market data with 5-year history
   - Use fetch_stock_data with period: Y5 for 5-year historical data
   - Captures: prices, volume, technical indicators, period performance

2. ANNOUNCEMENTS: Fetch 1-year of ASX announcements
   - Use fetch_announcements with period: Y1 (or M6 for recent focus)
   - Captures: all official ASX announcements with price sensitivity flags

3. ANALYST COVERAGE: Fetch broker ratings and price targets
   - Use fetch_analyst_coverage for structured analyst data
   - Captures: analyst count, consensus rating, price targets, upgrades/downgrades

4. HISTORICAL FINANCIALS: Fetch revenue and profit history
   - Use fetch_historical_financials for structured financial history
   - Captures: revenue, profit, margins, cash flow, YoY growth, CAGR

5. NEWS: Search for recent financial news
   - Use search_web for current news and market sentiment
   - Note: For analyst data, prefer fetch_analyst_coverage. For financials, prefer fetch_historical_financials.

6. BENCHMARK DATA:
   - Fetch ASX 200 (XJO) for market comparison

=== PHASE 2: DEEP ANALYSIS ===

7. ANNOUNCEMENT SIGNAL VS NOISE ANALYSIS
   For each announcement, rate its information value:
   - HIGH SIGNAL: Material financial data (FY/HY results, earnings guidance, major contracts, M&A)
   - MEDIUM SIGNAL: Operational updates, board changes, strategy updates
   - LOW SIGNAL (NOISE): Generic PR, routine notices, administrative filings
   Cross-reference price-sensitive flags and stock price movement on announcement dates.
   Calculate signal-to-noise ratio for the company's communication style.

8. FY/HY RESULTS DEEP DIVE
   Locate the most recent FY or HY results announcement and analyze:
   - KEY POSITIVES (list 3-5): Revenue growth, margin improvement, cash flow, strategic wins
   - KEY NEGATIVES (list 3-5): Cost pressures, debt levels, market headwinds, execution risks
   - YEAR-OVER-YEAR COMPARISON: Revenue, NPAT, EPS, dividend changes
   - MANAGEMENT OUTLOOK: Guidance, tone, and confidence level
   - MARKET REACTION: Share price movement following announcement
     * Day 1: +/-X% (immediate reaction)
     * Week 1: +/-X% (did reaction sustain or fade?)
     * Assessment: Was reaction proportionate to news quality?

8b. PRICE EVENT ANALYSIS
   Identify the 3-5 most significant share price movements in the past year:
   - For each major move (+/-10% or more in a week):
     * DATE: When did it occur?
     * MOVE: +/-X% over how many days?
     * CATALYST: What news/announcement triggered it? (if identifiable)
     * MARKET REACTION ASSESSMENT:
       - JUSTIFIED: Reaction proportionate to news significance
       - OVERREACTION: Price moved more than fundamentals warrant
       - UNDERREACTION: Price moved less than news significance suggests
       - KNEE-JERK: Initial spike/drop that reversed within days
     * CURRENT STATUS: Has the move held, reversed, or continued?

9. 5-YEAR COMPANY PERFORMANCE ANALYSIS
   Using historical stock data AND historical financials, analyze long-term trajectory:
   - STOCK PRICE PROGRESSION: 5-year CAGR, key inflection points
   - REVENUE PROGRESSION: 3Y and 5Y CAGR from fetch_historical_financials
   - PROFIT TRAJECTORY: Net income growth and margin trends
   - PERFORMANCE PHASES: Growth periods, consolidation, declines
   - PRICE VS MARKET: Performance vs ASX 200 (XJO) benchmark
   - VOLUME TRENDS: Institutional interest changes over time

10. COMPANY QUALITY ASSESSMENT
    Rate overall company quality (A/B/C/D/F) based on fundamental strength:
   - REVENUE TRAJECTORY: Growing, stable, or declining over 3-5 years
   - PROFIT TRAJECTORY: NPAT/margin trends, path to profitability
   - SHARE PRICE TRAJECTORY: Long-term capital appreciation vs destruction
   - QUALITY SCORE: A (excellent fundamentals), B (good), C (average), D (weak), F (poor/speculative)

   QUALITY REASONING (REQUIRED):
   Provide 2-3 sentences explaining WHY this company received its quality rating.
   Reference specific metrics: revenue growth %, profit margins, debt levels, share price CAGR.
   Example: "Quality B: Revenue grew 12% YoY with improving margins (8% to 11%), but high
   debt-to-equity (1.4x) and recent share price weakness (-15% vs XJO +8%) limit the rating."

11. ANALYST CONSENSUS ANALYSIS
    Using fetch_analyst_coverage data:
    - BROKER CONSENSUS: Buy/Hold/Sell distribution
    - PRICE TARGET ANALYSIS: Current price vs mean/median targets
    - UPSIDE POTENTIAL: Percentage to analyst target
    - RECENT ACTIONS: Any upgrades/downgrades in past 3 months
    - COVERAGE DEPTH: Number of analysts covering (more = higher confidence)

12. STOCK SUMMARY with key metrics and technical levels

13. DUAL INVESTMENT RECOMMENDATIONS

   TRADER RECOMMENDATION (1-6 week horizon):
   - Focus: Technical momentum, short-term catalysts, volatility
   - Weighting: 70% technicals, 20% near-term catalysts, 10% fundamentals
   - Action: STRONG BUY / BUY / HOLD / SELL / STRONG SELL
   - Conviction: 1-10 score
   - Key triggers: Breakout levels, earnings dates, news catalysts
   - Suitable for: Active traders seeking short-term gains

   SUPER RECOMMENDATION (6-12+ month horizon):
   - Focus: Company quality, long-term value, sustainable growth
   - Weighting: 60% fundamentals/quality, 25% industry position, 15% technicals
   - Action: ACCUMULATE / HOLD / REDUCE / AVOID
   - Conviction: 1-10 score
   - Quality requirement: ONLY recommend ACCUMULATE for Quality A or B companies
   - For Quality C: Maximum recommendation is HOLD
   - For Quality D/F: Recommend REDUCE or AVOID regardless of technicals
   - Suitable for: SMSF, long-term investors, retirement portfolios

=== PHASE 3: SYNTHESIS ===

If data collection fails for any stock:
- Note the failure explicitly
- Attempt alternative data sources (web search)
- Continue with remaining stocks

FINAL OUTPUT MUST INCLUDE:
- Individual stock reports with all analysis sections above
- Summary table: Ticker | Name | Quality | Trader Rec | Trader Conv | Super Rec | Super Conv | Signal:Noise | 5Y CAGR
- Alerts for significant price movements or material announcements
- Overall watchlist assessment
- TRADER WATCHLIST: Stocks with momentum for short-term opportunities
- SUPER ACCUMULATE LIST: Quality A/B companies suitable for long-term investment
- DEFINITIONS (at end of report):
  * Quality Rating (A/B/C/D/F): Company fundamental strength grade
    - A (Excellent): Consistent revenue AND profit growth, share price appreciation, strong balance sheet
    - B (Good): Mostly positive trends with minor concerns
    - C (Average): Mixed results, some growth but also challenges
    - D (Weak): Declining trends in multiple areas, turnaround needed
    - F (Speculative): Pre-revenue, high-risk, or deteriorating fundamentals
  * Signal:Noise Ratio: Quality of company communications to ASX
    - HIGH (>70%): Most announcements contain material, actionable information
    - MEDIUM (40-70%): Mix of material updates and routine notices
    - LOW (<40%): Mostly routine/PR announcements with little investment substance
  * CAGR (Compound Annual Growth Rate): Annualized return over a period
    - Formula: (End Value / Start Value)^(1/Years) - 1
    - Example: 5Y CAGR of 15% = 15% average annual return compounded over 5 years
    - Interpretation: >15% excellent, 10-15% good, 5-10% average, <5% poor
"""

# Output schema reference - loads external JSON schema from ../schemas/
# When set, the LLM MUST return JSON matching this schema.
# The JSON is then converted to markdown for the final document.
# NOTE: Use JSON format templates (.json) for new deployments - TOML is legacy.
output_schema_ref = "stock-report.schema.json"
