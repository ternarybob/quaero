# SMSF Portfolio Analysis - Orchestrator Goal Template
# =========================================================================
# Reusable goal and tools for SMSF portfolio analysis.
# Referenced by job definitions via goal_template = "smsf-portfolio-analysis-goal"
#
# This template defines:
# - The portfolio analysis goal (phases, P/L calculations, recommendations)
# - Available tools for the orchestrator
# - Thinking level and model preferences
# - Output tags for downstream steps
#
# Variables are provided by the referencing job definition in [config].
# Expected variable keys: ticker, name, industry, units, avg_price, weighting
# Expected benchmarks: code, name (e.g., XJO, XSO)
# =========================================================================

id = "smsf-portfolio-analysis-goal"
name = "SMSF Portfolio Analysis Goal Template"
type = "orchestrator_template"
description = "Reusable goal and tools for AI-powered SMSF portfolio analysis"

[template]
# Thinking level for LLM reasoning depth
thinking_level = "HIGH"

# Model preference (auto selects based on task complexity)
model_preference = "auto"

# Output tags - allows email step to find this document via body_from_tag
output_tags = ["smsf-portfolio-review"]

# Natural language goal - holistic portfolio analysis
goal = """
Perform a comprehensive SMSF portfolio review for all holdings in the variables list.

IMPORTANT: The portfolio may contain 1 or more stocks. Adjust analysis appropriately:
- For single-stock portfolios: Focus on that stock's performance and risk concentration
- For multi-stock portfolios: Include diversification and correlation analysis

=== PHASE 1: DATA COLLECTION ===

1. STOCK DATA: For EACH holding in variables:
   - Use fetch_stock_data with period: Y5 for 5-year historical data
   - Captures: current price, OHLCV history, technical indicators, period performance

2. ANNOUNCEMENTS: For EACH holding:
   - Use fetch_announcements with period: Y1 for annual announcements
   - Captures: FY/HY results, trading updates, material contracts

3. BENCHMARK DATA:
   - Fetch ASX 200 (XJO) for large cap comparison
   - Fetch Small Ords (XSO) for small cap comparison

4. NEWS: Search for financial news on each holding
   - Use search_web for analyst coverage, broker notes

=== PHASE 2: PROFIT & LOSS ANALYSIS ===

5. PORTFOLIO VALUATION (for EACH holding):
   - Current Price: from stock data
   - Cost Basis: Units × Avg Purchase Price (from variables)
   - Current Value: Units × Current Price
   - Unrealized P/L: Current Value - Cost Basis
   - Return %: (Current Value - Cost Basis) / Cost Basis × 100
   - Contribution: Holding's % of total portfolio gain/loss

6. TOTAL PORTFOLIO P/L:
   - Sum of all Cost Bases = Total Investment
   - Sum of all Current Values = Total Portfolio Value
   - Total Unrealized P/L = Total Value - Total Investment
   - Overall Return % = Total P/L / Total Investment × 100

=== PHASE 3: PORTFOLIO MIX ANALYSIS ===

7. DIVERSIFICATION ASSESSMENT:
   - Industry concentration: % in each industry/sector
   - Single-stock risk: Flag any holding >20% of portfolio
   - Sector correlation: How holdings might move together
   - For single-stock portfolio: Emphasize concentration risk

8. COMPANY QUALITY ASSESSMENT (for EACH holding):
   - Revenue trajectory (growing/stable/declining)
   - Profit trajectory (NPAT/margin trends)
   - Quality Grade: A (excellent) / B (good) / C (average) / D (weak) / F (speculative)

9. PORTFOLIO MIX RATING:
   - DEFENSIVE: % in ETFs, bonds, cash, blue chips
   - GROWTH: % in small caps, technology, emerging
   - INCOME: Dividend yield of portfolio
   - Risk Profile: Conservative / Balanced / Aggressive

=== PHASE 4: RECOMMENDATIONS ===

10. DUAL RECOMMENDATIONS (for EACH holding):

    TRADER VIEW (1-6 weeks):
    - Focus: Technical momentum, near-term catalysts
    - Action: STRONG BUY / BUY / HOLD / SELL / STRONG SELL
    - Conviction: 1-10

    SUPER VIEW (6-12+ months):
    - Focus: Company quality, long-term value, SMSF suitability
    - Action: ACCUMULATE / HOLD / REDUCE / AVOID
    - Conviction: 1-10
    - Only recommend ACCUMULATE for Quality A or B companies

11. PORTFOLIO ACTIONS:
    - Rebalancing recommendations if any holding drifted from target weight
    - Add/trim suggestions based on quality and valuation
    - SMSF compliance notes (diversification rules, arm's length requirements)

=== PHASE 5: SYNTHESIS ===

If data is missing for any stock:
- Calculate what you can with available data
- Note missing data explicitly
- Continue with remaining analysis

FINAL OUTPUT MUST INCLUDE:

1. PORTFOLIO VALUATION TABLE:
   Ticker | Units | Avg Cost | Current | Value | P/L | Return% | Weight

2. TOTAL PORTFOLIO SUMMARY:
   - Total Investment, Current Value, Total P/L, Overall Return %

3. RECOMMENDATIONS TABLE:
   Ticker | Quality | Trader Rec | Trader Conv | Super Rec | Super Conv

4. PORTFOLIO MIX SUMMARY:
   - Industry breakdown, Risk profile, Diversification score

5. PRIORITY ACTIONS:
   - Trader opportunities (1-6 weeks)
   - Super accumulation targets (6-12+ months)
   - Rebalancing needs

6. RISK ALERTS:
   - Overconcentration warnings
   - Quality concerns (D/F rated holdings)
   - Stocks at technical extremes
"""

# Available tools - workers exposed to the orchestrator as callable tools
available_tools = [
    { name = "fetch_stock_data", description = "Fetch ASX stock prices, historical data, and technical indicators. Creates document tagged with ['asx-stock-data', '<ticker>']. REQUIRED params: asx_code (string). OPTIONAL: period (string) - M1, M3, M6, Y1, Y2, Y5 (default Y1). Use period=Y5 for 5-year historical analysis. Provides: current price, OHLCV history, SMA20/50/200, RSI14, support/resistance, period performance.", worker = "asx_stock_data" },
    { name = "fetch_announcements", description = "Fetch official ASX company announcements with price sensitivity flags. Creates document tagged with ['asx-announcement', '<ticker>']. REQUIRED params: asx_code (string). OPTIONAL: period (string) - D1, W1, M1, M3, M6, Y1, Y5 (default Y1). Use for FY/HY results, trading updates, contracts.", worker = "asx_announcements" },
    { name = "fetch_index_data", description = "Fetch ASX index data for benchmarks (XJO, XSO). Creates document tagged with ['asx-index', '<code>', 'benchmark']. REQUIRED params: asx_code (string) - e.g. 'XJO', 'XSO'. Provides: current value, period performance, OHLCV history, technicals.", worker = "asx_stock_data" },
    { name = "search_web", description = "Search web for financial news, analyst reports, and company research. Creates document tagged with ['web-search']. REQUIRED params: query (string). Use for: analyst coverage, broker notes, competitor analysis.", worker = "web_search" },
    { name = "analyze_summary", description = "Generate deep LLM-based analysis from collected documents. REQUIRED params: prompt (string) - analysis instructions, filter_tags (array) - tags to filter documents. OPTIONAL: thinking_level (string) - LOW or HIGH. Use HIGH for portfolio P/L calculations and recommendations.", worker = "summary" },
]

# Output schema for structured LLM output (Gemini ResponseSchema)
# When set, the LLM MUST return JSON matching this schema.
# The JSON is then converted to markdown for the final document.
[template.output_schema]
type = "object"
description = "Structured SMSF portfolio analysis with P/L calculations and recommendations"
required = ["portfolio_valuation", "total_summary", "recommendations", "portfolio_mix", "priority_actions", "risk_alerts"]

[template.output_schema.properties.portfolio_valuation]
type = "array"
description = "Valuation table for each holding"

[template.output_schema.properties.portfolio_valuation.items]
type = "object"
required = ["ticker", "units", "avg_cost", "current_price", "current_value", "unrealized_pl", "return_pct", "weight_pct"]

[template.output_schema.properties.portfolio_valuation.items.properties.ticker]
type = "string"
description = "ASX stock ticker code"

[template.output_schema.properties.portfolio_valuation.items.properties.name]
type = "string"
description = "Company full name"

[template.output_schema.properties.portfolio_valuation.items.properties.units]
type = "number"
description = "Number of shares held"

[template.output_schema.properties.portfolio_valuation.items.properties.avg_cost]
type = "number"
description = "Average purchase price per share"

[template.output_schema.properties.portfolio_valuation.items.properties.current_price]
type = "number"
description = "Current market price per share"

[template.output_schema.properties.portfolio_valuation.items.properties.current_value]
type = "number"
description = "Current market value (units × current_price)"

[template.output_schema.properties.portfolio_valuation.items.properties.cost_basis]
type = "number"
description = "Total cost basis (units × avg_cost)"

[template.output_schema.properties.portfolio_valuation.items.properties.unrealized_pl]
type = "number"
description = "Unrealized profit/loss (current_value - cost_basis)"

[template.output_schema.properties.portfolio_valuation.items.properties.return_pct]
type = "number"
description = "Return percentage as decimal (e.g., 0.15 for 15%)"

[template.output_schema.properties.portfolio_valuation.items.properties.weight_pct]
type = "number"
description = "Portfolio weight percentage as decimal"

[template.output_schema.properties.total_summary]
type = "object"
description = "Total portfolio summary"
required = ["total_investment", "total_value", "total_pl", "overall_return_pct"]

[template.output_schema.properties.total_summary.properties.total_investment]
type = "number"
description = "Sum of all cost bases"

[template.output_schema.properties.total_summary.properties.total_value]
type = "number"
description = "Sum of all current values"

[template.output_schema.properties.total_summary.properties.total_pl]
type = "number"
description = "Total unrealized P/L"

[template.output_schema.properties.total_summary.properties.overall_return_pct]
type = "number"
description = "Overall return percentage as decimal"

[template.output_schema.properties.recommendations]
type = "array"
description = "Recommendations for each holding"

[template.output_schema.properties.recommendations.items]
type = "object"
required = ["ticker", "quality_rating", "trader_recommendation", "super_recommendation"]

[template.output_schema.properties.recommendations.items.properties.ticker]
type = "string"
description = "ASX stock ticker code"

[template.output_schema.properties.recommendations.items.properties.quality_rating]
type = "string"
description = "Company quality grade"
enum = ["A", "B", "C", "D", "F"]

[template.output_schema.properties.recommendations.items.properties.quality_reasoning]
type = "string"
description = "Brief explanation of quality rating"

[template.output_schema.properties.recommendations.items.properties.trader_recommendation]
type = "object"
required = ["action", "conviction"]

[template.output_schema.properties.recommendations.items.properties.trader_recommendation.properties.action]
type = "string"
enum = ["STRONG BUY", "BUY", "HOLD", "SELL", "STRONG SELL"]

[template.output_schema.properties.recommendations.items.properties.trader_recommendation.properties.conviction]
type = "integer"
minimum = 1
maximum = 10

[template.output_schema.properties.recommendations.items.properties.super_recommendation]
type = "object"
required = ["action", "conviction"]

[template.output_schema.properties.recommendations.items.properties.super_recommendation.properties.action]
type = "string"
enum = ["ACCUMULATE", "HOLD", "REDUCE", "AVOID"]

[template.output_schema.properties.recommendations.items.properties.super_recommendation.properties.conviction]
type = "integer"
minimum = 1
maximum = 10

[template.output_schema.properties.portfolio_mix]
type = "object"
description = "Portfolio mix analysis"

[template.output_schema.properties.portfolio_mix.properties.industry_breakdown]
type = "array"
description = "Industry concentration breakdown"

[template.output_schema.properties.portfolio_mix.properties.industry_breakdown.items]
type = "object"

[template.output_schema.properties.portfolio_mix.properties.industry_breakdown.items.properties.industry]
type = "string"

[template.output_schema.properties.portfolio_mix.properties.industry_breakdown.items.properties.weight_pct]
type = "number"

[template.output_schema.properties.portfolio_mix.properties.risk_profile]
type = "string"
description = "Overall risk profile"
enum = ["Conservative", "Balanced", "Aggressive"]

[template.output_schema.properties.portfolio_mix.properties.diversification_score]
type = "string"
description = "Diversification assessment"
enum = ["Poor", "Moderate", "Good", "Excellent"]

[template.output_schema.properties.portfolio_mix.properties.defensive_pct]
type = "number"
description = "Percentage in defensive assets"

[template.output_schema.properties.portfolio_mix.properties.growth_pct]
type = "number"
description = "Percentage in growth assets"

[template.output_schema.properties.portfolio_mix.properties.income_yield]
type = "number"
description = "Portfolio dividend yield as decimal"

[template.output_schema.properties.priority_actions]
type = "object"
description = "Priority actions for the portfolio"

[template.output_schema.properties.priority_actions.properties.trader_opportunities]
type = "array"
description = "Short-term trading opportunities"

[template.output_schema.properties.priority_actions.properties.trader_opportunities.items]
type = "string"

[template.output_schema.properties.priority_actions.properties.super_accumulate]
type = "array"
description = "Long-term accumulation targets"

[template.output_schema.properties.priority_actions.properties.super_accumulate.items]
type = "string"

[template.output_schema.properties.priority_actions.properties.rebalancing]
type = "array"
description = "Rebalancing recommendations"

[template.output_schema.properties.priority_actions.properties.rebalancing.items]
type = "string"

[template.output_schema.properties.risk_alerts]
type = "array"
description = "Risk alerts and warnings"

[template.output_schema.properties.risk_alerts.items]
type = "string"
