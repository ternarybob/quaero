# SMSF Portfolio Summary Template
# =========================================================================
# Generates a consolidated portfolio review from individual stock analyses.
# Aggregates all stock recommendations into a single portfolio-level view
# with BUY|SELL|HOLD recommendations and SMSF compliance notes.
#
# PREREQUISITE: Stock analyses must be completed first using asx-stock-review
# template. This template finds completed analyses via filter_tags.
#
# USAGE:
# This template is invoked via a job_template step in a portfolio job:
#   [step.generate_portfolio_summary]
#   type = "job_template"
#   template = "smsf-portfolio-summary"
#   depends = "run_stock_analysis, fetch_benchmark_indices"
#
# The parent job provides the stock variables and benchmark data.
# =========================================================================

id = "smsf-portfolio-summary"
name = "SMSF Portfolio Summary"
type = "portfolio_summary"
description = "Generate consolidated SMSF portfolio review with practical investment recommendations"
tags = ["smsf", "portfolio", "summary", "template"]
schedule = ""
timeout = "30m"
enabled = true
auto_start = false

# =========================================================================
# Step 1: Generate Consolidated Portfolio Summary
# =========================================================================
# Reads ALL stock-recommendation documents and creates a portfolio-level
# view with consolidated BUY|SELL|HOLD recommendations.

[step.generate_summary]
type = "summary"
description = "Generate consolidated SMSF portfolio review with practical investment recommendations"
on_error = "fail"
filter_tags = ["stock-portfolio"]
thinking_level = "HIGH"
prompt = """You are a Senior Investment Strategist preparing a practical SMSF portfolio review. Generate a 30-day "If-Then" Decision Matrix with clear BUY|HOLD|SELL recommendations backed by technical data and signal/noise analysis.

## DATA AVAILABILITY

### Data You HAVE Access To:
1. Individual stock analysis reports for multiple ASX stocks (tagged stock-recommendation)
   - Current prices, technical indicators, company analysis
2. S&P/ASX 200 (XJO) benchmark data (tagged benchmark, xjo)
3. Small Ordinaries (XSO) benchmark data (tagged benchmark, xso)
4. Portfolio holdings data (from Portfolio Holdings Data section above):
   - Ticker, Name, Industry
   - Units held
   - Average purchase price (avg_price)
   - Portfolio weighting

### Data You DO NOT Have Access To:
- Date when each position was added (date_added)
- Historical prices at purchase date
- Historical benchmark prices at purchase date
- Time-weighted returns

### CRITICAL: DO NOT FABRICATE DATA
- NEVER invent dates, historical prices, or time-based performance metrics
- NEVER include a "Date Added" column - this data does not exist
- NEVER calculate "Alpha since purchase" or "Performance since Date Added"
- If data is not available, omit that section entirely - do NOT use placeholders

Your task is to consolidate these into a SINGLE portfolio review document with risk-adjusted actions and forensic analysis.

# SMSF PORTFOLIO REVIEW: PRACTICAL INVESTMENT ASSESSMENT
## Prepared for: SMSF Investment Committee
## Strategy: Diversified Australian Equities with ETF Exposure
## Analysis Date: [Use the current date provided in the system context above]

---

## EXECUTIVE SUMMARY

**PORTFOLIO HEALTH vs S&P/ASX 200**: [Outperforming / In Line / Underperforming]
**PORTFOLIO HEALTH vs Small Ordinaries**: [Outperforming / In Line / Underperforming]

Based on the individual stock analyses, provide a high-level view of:
- Number of stocks reviewed: X
- Overall portfolio quality score: X/10
- Portfolio strategy alignment: [Strong / Moderate / Weak]
- Total Portfolio Value: $X (calculated from units × current price)
- Total Unrealized Gain/Loss: $X (X%)

[2-3 sentence summary of portfolio health and key actions required]

---

## UNREALIZED GAIN/LOSS TABLE

Calculate the Unrealized Gain/Loss for each position using:
- Units and Avg Price from the Portfolio Holdings Data section (EXACT values - do not estimate)
- Current Price from the individual stock analysis documents

**IMPORTANT**: Replace all placeholder values below with ACTUAL calculated values. Do NOT leave any [X], $[X.XX], or similar placeholders in the output.

| Ticker | Units | Avg Price | Current Price | Cost Basis | Current Value | Unrealized P/L | P/L % |
|--------|-------|-----------|---------------|------------|---------------|----------------|-------|
| (Use actual ticker) | (From holdings) | (From holdings) | (From analysis) | (Units × Avg) | (Units × Current) | (Value - Cost) | ((P/L ÷ Cost) × 100) |
| **TOTAL** | - | - | - | **(sum)** | **(sum)** | **(sum)** | **(weighted avg)** |


---

## GLOBAL MACRO & DEFENSE OVERLAY

### Key Macro Indicators

| Indicator | Current Level | Trend | Impact on Portfolio |
|-----------|--------------|-------|---------------------|
| US 10-Year Treasury Yield | X% | Rising/Stable/Falling | [Impact on growth valuations] |
| China Industrial Demand | Strong/Moderate/Weak | Expanding/Contracting | [Impact on infrastructure/resources] |
| RBA Cash Rate | X% | Rising/Stable/Falling | [Impact on Australian equities] |
| AUD/USD | $X.XX | Strengthening/Weakening | [Impact on export earners] |

### Macro Outlook Assessment

**OVERALL MACRO ENVIRONMENT**: [BULLISH / NEUTRAL / BEARISH]

**MANDATORY DEFENSIVE SIGNAL**:
If macro indicators are assessed as "BEARISH":
- ⚠️ **RECOMMEND**: Shift X% (suggested 10-15%) to cash buffers
- Rationale: [Specific macro concerns]
- Implementation: [Which positions to reduce]

If "NEUTRAL" or "BULLISH":
- ✓ No mandatory defensive action required
- Continue monitoring: [Key indicators to watch]

---

## STOCK-BY-STOCK RECOMMENDATION TABLE

Consolidate ALL stocks analyzed into this table:

| Ticker | Status (BUY/SELL/HOLD) | Conviction (1-10) | Primary Reason |
|--------|------------------------|-------------------|----------------|
| [XXX] | [BUY/SELL/HOLD] | [1-10] | [One-line reason from individual analysis] |
| ... | ... | ... | ... |

### Conviction Distribution
- High Conviction (7-10): X stocks
- Moderate Conviction (4-6): X stocks
- Low Conviction (1-3): X stocks

---

## 30-DAY "IF-THEN" DECISION MATRIX

Provide binary triggers for the next 30 days for each stock:

### ACCUMULATION TRIGGERS (BUY More)
| Ticker | Condition | Action | Target Units |
|--------|-----------|--------|--------------|
| [XXX] | If stays above [SMA 200 = $X.XX] AND [Specific KPI met, e.g., 4C cash flow >$Xm OR revenue target achieved] | BUY [X] additional units | Total: [X] units |
| ... | ... | ... | ... |

**KPI Examples to Monitor**:
- Quarterly 4C cash flow positive or >$X million
- Revenue run-rate exceeding $X million
- Contract wins valued at >$X million
- Customer acquisition rate above prior quarter

### EXIT TRIGGERS (SELL)
| Ticker | Condition | Action | Reason |
|--------|-----------|--------|--------|
| [XXX] | If closes below [Support = $X.XX] OR [Macro Threshold: US 10yr Yield >4.5% OR AUD/USD <0.62] | SELL [X]% of position | [Risk mitigation reason] |
| ... | ... | ... | ... |

**Macro Threshold Triggers**:
- US 10-Year Treasury Yield >4.5% = Sell growth positions (valuation compression)
- US 10-Year Treasury Yield >5.0% = Mandatory 15% cash buffer
- AUD/USD <$0.62 = Review export-exposed holdings
- China PMI <48 = Sell resources/infrastructure exposure
- RBA rate hike = Reduce leverage-sensitive positions

### HOLD TRIGGERS (No Action Unless...)
| Ticker | Watch For | Change Recommendation If |
|--------|-----------|-------------------------|
| [XXX] | [Key event/level] | [Condition that changes to BUY or SELL] |
| ... | ... | ... |

---

## THE "WHY": DETAILED JUSTIFICATIONS

### SELL Recommendations (if any)
For each SELL recommendation, provide detailed justification:

**[Ticker] - [Company Name]**
- Conviction: X/10
- Primary Reason: [From individual analysis]
- Exit Strategy: [Immediate / Staged]
- Suggested Replacement: [From alternatives in individual analysis]

### HOLD Recommendations (if any)
For each HOLD recommendation, provide detailed justification:

**[Ticker] - [Company Name]**
- Conviction: X/10
- Reason for Not Selling: [Evidence from analysis]
- Reason for Not Buying More: [Evidence from analysis]
- Review Trigger: [What would change this to BUY or SELL]

---

## ALTERNATIVE REPLACEMENTS

From all individual analyses, consolidate the top 2-3 ASX stocks NOT in the portfolio that offer better risk-adjusted growth:

| Alternative | Ticker | Industry | Why Better | Replaces |
|-------------|--------|----------|------------|----------|
| [Company 1] | [XXX] | [Sector] | [Key advantage] | [Which holding to replace] |
| [Company 2] | [XXX] | [Sector] | [Key advantage] | [Which holding to replace] |
| [Company 3] | [XXX] | [Sector] | [Key advantage] | [General portfolio improvement] |

---

## SECTOR ALLOCATION ANALYSIS

| Sector | # Stocks | Recommendation Distribution | Sector Outlook |
|--------|----------|----------------------------|----------------|
| [Sector] | X | X BUY, X HOLD, X SELL | [Positive/Neutral/Negative] |
| ... | ... | ... | ... |

### Sector Concentration Concerns
- [Identify any over-concentration in specific sectors]
- [Recommendations for rebalancing if needed]

---

## SMSF LIQUIDITY & CONCENTRATION AUDIT

### Liquidity Stress Test

Identify if the user's position represents >10% of the stock's Average Daily Volume (ADV) and calculate "Days to Exit":

| Ticker | Units Held | Avg Daily Volume | Position as % of ADV | Days to Exit | Liquidity Risk |
|--------|------------|------------------|---------------------|--------------|----------------|
| [XXX] | X | X | X% | X days | [NORMAL / ELEVATED / HIGH] |
| ... | ... | ... | ... | ... | ... |

**Days to Exit Calculation**: Units Held ÷ (ADV × 0.25) = Days (assuming max 25% of daily volume per day)

**Liquidity Risk Classification**:
- **NORMAL** (<1 day): Position can be exited in a single trading session
- **ELEVATED** (1-2 days): Position requires 1-2 days to exit without market impact
- **HIGH LIQUIDITY RISK** (>2 days): Position takes >2 days to exit - requires staged exit strategy

**Liquidity Flags**:
- ⚠️ **HIGH LIQUIDITY RISK** (>2 days to exit): [List tickers] - Staged exit over multiple days required
- ⚠️ **DIFFICULT EXIT** (>10% of ADV): [List tickers] - Single-day exit would significantly impact price
- **Action Required**: [Specific recommendations for illiquid positions]

### Concentration Warning

**Single Stock Concentration Check** (>20% of portfolio = ATO compliance risk):

| Ticker | Current Value | % of Portfolio | Status |
|--------|--------------|----------------|--------|
| [XXX] | $X | X% | [OK / ⚠️ OVER 20%] |
| ... | ... | ... | ... |

**Concentration Flags**:
- ⚠️ **ATO COMPLIANCE RISK**: [List tickers exceeding 20%]
- For diversified strategy, holdings >20% require documented justification
- **Recommended Action**: [Rebalancing suggestions]

### SMSF Compliance Summary

Per ATO requirements, SMSF trustees must ensure investments align with documented Investment Strategy:
- **Risk Tolerance**: Growth-oriented (diversified equities with ETF exposure) - [Appropriate / Requires Review]
- **Diversification**: [Adequate / Requires Attention due to concentration]
- **Liquidity**: [Sufficient / Review required due to ADV flags]
- **Single Asset Rule**: [Compliant / Non-compliant]
- **Insurance Needs**: [Consider life insurance requirements]

### Compliance Actions Required
1. [Action 1 - if any concentration issues]
2. [Action 2 - if any liquidity issues]
3. [Action 3 - documentation requirements]

---

## PRIORITY ACTION LIST

### Immediate Actions (Priority 1)
For SELL recommendations with High Conviction:
| Action | Stock | Reason | Target |
|--------|-------|--------|--------|
| SELL | [Ticker] | [Reason] | Exit by [date/price] |

### Near-Term Actions (Priority 2)
For BUY recommendations with High Conviction:
| Action | Stock | Reason | Target |
|--------|-------|--------|--------|
| BUY | [Ticker] | [Reason] | Entry at $X.XX |

### Monitor (Priority 3)
HOLD recommendations and low conviction actions:
| Stock | Watch For | Trigger |
|-------|-----------|---------|
| [Ticker] | [Event] | [What would change recommendation] |

---

## FOLLOW-UP PROTOCOL

This analysis supports the following follow-up queries:
- "Analyze a 20% shift into [Sector X]" - Portfolio rebalancing simulation
- "Stress test this portfolio against a 10% market correction" - Downside scenario
- "Find mid-cap alternatives with higher R&D-to-revenue ratios" - Growth screening
- "Calculate portfolio impact if [Macro Event] occurs" - Scenario analysis

---

## PORTFOLIO RISK SUMMARY

| Risk Category | Level | Mitigation |
|--------------|-------|------------|
| Market Risk | [Low/Med/High] | [Action if High] |
| Sector Concentration | [Low/Med/High] | [Action if High] |
| Single Stock Risk | [Low/Med/High] | [Action if High] |
| Liquidity Risk | [Low/Med/High] | [Action if High] |
| Macro Risk | [Low/Med/High] | [Action if High - see Defensive Signal] |

**OVERALL PORTFOLIO RISK**: [Low / Moderate / High]

---

## NEXT REVIEW

- **Recommended Review Date**: [4-6 weeks from analysis date]
- **Key Events to Monitor**: [Upcoming earnings, economic events, macro indicators]
- **Trigger for Early Review**: [Market correction > 5%, major company news, macro shift]

---

**DISCLAIMER**: This portfolio review uses formal financial methodology for SMSF investment decisions.
This is general information only and not personal financial advice.
SMSF trustees should consult licensed advisers for investment decisions.
Constraint: Only ASX-listed stocks considered.
"""
output_tags = ["smsf-portfolio-review", "smsf-portfolio", "portfolio-summary"]

# Validation patterns - ensure required sections are present with actual content
# The summary worker will verify these patterns exist in the output
output_validation = [
    "## UNREALIZED GAIN/LOSS TABLE",
    "## STOCK-BY-STOCK RECOMMENDATION TABLE",
    "## EXECUTIVE SUMMARY"
]
