# SMSF Portfolio Review - Daily Analysis Job
# ===========================================================================
# This job orchestrates the SMSF Portfolio Review for a diversified SMSF
# portfolio. It runs individual stock analyses using the asx-stock-review
# template, then consolidates all results into a single portfolio review with
# BUY|SELL|HOLD recommendations and SMSF compliance notes.
#
# STRATEGY: Diversified Australian Equities with ETF exposure
# PERSONA: Senior Investment Strategist specializing in Australian SMSFs
#
# WORKFLOW:
# 1a. Run asx-index-review template for benchmark indices (parallel)
# 1b. Run asx-stock-data template for each stock (data collection - parallel)
# 2. Run asx-stock-review template for each stock (analysis - depends on 1b)
# 3. Generate consolidated portfolio summary with all stocks compared (depends on 1a and 2)
# 4. Email single portfolio review to SMSF Investment Committee
# ===========================================================================

id = "smsf-portfolio-daily"
name = "SMSF Portfolio Review"
type = "job_template"
description = "Senior Investment Strategist review for SMSF portfolio - BUY|SELL|HOLD recommendations with conviction scoring"
tags = ["smsf", "asx", "stocks", "daily", "template", "portfolio"]
schedule = ""
timeout = "3h"
enabled = true
auto_start = false

# Global stock variables - inherited by both collect_stock_data and run_stock_analysis steps
# Available variable keys: ticker, name, industry, units, avg_price, weighting
# Variable references in templates: {stock:ticker}, {stock:name}, {stock:industry}
# Modifiers: {stock:ticker_lower}, {stock:ticker_upper}
# Portfolio data: units (number of shares), avg_price (average purchase price), weighting (% of portfolio)
[config]
variables = [
    # # =========================================================================
    # # ETFs & Index Funds (Defensive/Core)
    # # =========================================================================
    # { ticker = "AAA", name = "Betashares Australian High Interest Cash ETF", industry = "cash-etf", units = 198, avg_price = 50.235, weighting = 3.04 },
    # { ticker = "VACF", name = "Vanguard Australian Corporate Fixed Interest Index ETF", industry = "bond-etf", units = 193, avg_price = 51.666, weighting = 3.05 },
    # { ticker = "VGS", name = "Vanguard MSCI Index International Shares ETF", industry = "global-etf", units = 64, avg_price = 154.031, weighting = 3.01 },
    # { ticker = "PMGOLD", name = "Perth Mint Gold", industry = "gold-etf", units = 597, avg_price = 66.747, weighting = 12.21 },

    # # =========================================================================
    # # Large Cap Blue Chips (Stable Income)
    # # =========================================================================
    # { ticker = "WES", name = "Wesfarmers Limited", industry = "retail", units = 122, avg_price = 81.209, weighting = 3.03 },
    # { ticker = "WOW", name = "Woolworths Group Limited", industry = "retail", units = 339, avg_price = 29.329, weighting = 3.04 },

    # # =========================================================================
    # # Energy & Utilities (Income & Defensive)
    # # =========================================================================
    # { ticker = "APA", name = "APA Group", industry = "energy-infrastructure", units = 2129, avg_price = 9.321, weighting = 6.07 },

    # # =========================================================================
    # # Financials & Services
    # # =========================================================================
    # { ticker = "ASB", name = "Austal Limited", industry = "defence-shipbuilding", units = 2915, avg_price = 6.819, weighting = 6.11 },
    # { ticker = "GDG", name = "Generation Development Group", industry = "financial-services", units = 3406, avg_price = 5.831, weighting = 6.07 },
    # { ticker = "PNC", name = "Pioneer Credit Limited", industry = "financial-services", units = 28772, avg_price = 0.684, weighting = 6.03 },

    # # =========================================================================
    # # Technology & Growth
    # # =========================================================================
    # { ticker = "ACDC", name = "Global X Battery Tech & Lithium ETF", industry = "battery-tech-etf", units = 141, avg_price = 141.001, weighting = 6.08 },
    # { ticker = "DOW", name = "Downer EDI Limited", industry = "engineering-services", units = 2487, avg_price = 7.991, weighting = 6.08 },
    # { ticker = "SEMI", name = "ETFS Semiconductor ETF", industry = "semiconductor-etf", units = 864, avg_price = 23.113, weighting = 6.10 },
    # { ticker = "MYG", name = "Mayfield Group Holdings", industry = "technology", units = 6778, avg_price = 2.950, weighting = 6.11 },

    # =========================================================================
    # Infrastructure & Industrials
    # =========================================================================
    { ticker = "GNP", name = "GenusPlus Group Ltd", industry = "infrastructure", units = 3159, avg_price = 6.303, weighting = 5.97 },
    { ticker = "SKS", name = "SKS Technologies Group", industry = "technology-infrastructure", units = 4925, avg_price = 4.025, weighting = 6.01 },
    # { ticker = "SRG", name = "SRG Global Limited", industry = "engineering-services", units = 6621, avg_price = 3.000, weighting = 6.05 },
    # { ticker = "SSM", name = "Service Stream Limited", industry = "infrastructure-services", units = 8619, avg_price = 2.269, weighting = 5.96 },
]

# ===========================================================================
# Step 1a: Fetch Benchmark Index Data
# ===========================================================================
# Executes the asx-index-review template for each configured benchmark index.
# Each index becomes a child job with data collection.
# Runs in parallel with stock data collection (no depends).

[step.fetch_benchmark_indices]
type = "job_template"
description = "Execute ASX Index Review template for benchmark indices"
on_error = "continue"
template = "asx-index-review"
parallel = true

# Benchmark variables (separate from stock variables in [config])
# Available variable keys: code, name
# Variable references in template: {index:code}, {index:name}, {index:code_lower}
variables = [
    { code = "XJO", name = "S&P/ASX 200" },
    { code = "XSO", name = "S&P/ASX Small Ordinaries" },
]

# ===========================================================================
# Step 1b: Collect Stock Data
# ===========================================================================
# Executes the asx-stock-data template for each stock (data collection only).
# Runs in parallel with benchmark indices (no depends).
# Variables inherited from [config] section.

[step.collect_stock_data]
type = "job_template"
description = "Collect stock data (prices, announcements, news) for each portfolio stock"
on_error = "continue"
template = "asx-stock-data"
parallel = true
# Variables inherited from [config] section

# ===========================================================================
# Step 2: Run Individual Stock Analyses
# ===========================================================================
# Executes the asx-stock-review template for each stock (analysis only).
# Depends on collect_stock_data - uses data from previous step.
# Variables inherited from [config] section.

[step.run_stock_analysis]
type = "job_template"
description = "Execute stock analysis template for each configured stock"
depends = "collect_stock_data"
on_error = "continue"
template = "asx-stock-review"
parallel = true
# Variables inherited from [config] section

# ===========================================================================
# Step 3: Generate Consolidated Portfolio Summary
# ===========================================================================
# After all individual stock analyses complete, this step invokes the
# smsf-portfolio-summary template which reads ALL stock-recommendation
# documents and creates a portfolio-level view with consolidated
# BUY|SELL|HOLD recommendations.

[step.generate_portfolio_summary]
type = "job_template"
description = "Generate consolidated SMSF portfolio review using template"
depends = "run_stock_analysis, fetch_benchmark_indices"
on_error = "fail"
template = "smsf-portfolio-summary"
# Template declares singleton=true - runs once, parent variables inherited for data access

# ===========================================================================
# Step 4: Email Consolidated Portfolio Report
# ===========================================================================
# Sends the single consolidated portfolio review email.

[step.email_portfolio_report]
type = "email"
description = "Email consolidated SMSF portfolio review"
depends = "generate_portfolio_summary"
always_run = true
on_error = "fail"
to = "bobmcallan@gmail.com"
subject = "SMSF Portfolio Review - Practical Investment Analysis"
body_from_tag = "smsf-portfolio-review"
