# ASX Stock Analysis Job Template
# Template variables use {variable:key} syntax where variable comes from the orchestrator
# Example: {stock:ticker}, {stock:name}, {stock:industry}

id = "web-search-asx-{stock:ticker_lower}"
name = "ASX:{stock:ticker} Investment Analysis"
type = "web_search"
description = "Comprehensive investment analysis for ASX listed company ASX:{stock:ticker} ({stock:name})"
tags = ["web-search", "asx", "stocks", "{stock:ticker_lower}"]
schedule = ""
timeout = "15m"
enabled = true
auto_start = false

# Step 1: Fetch real-time stock data and technical indicators
[step.fetch_stock_data]
type = "asx_stock_data"
description = "Fetch real-time prices, valuations, and calculate technicals"
on_error = "continue"
asx_code = "{stock:ticker}"
period = "Y1"
output_tags = ["{stock:ticker_lower}", "asx-{stock:ticker_lower}-data"]

# Step 2: Fetch ASX company announcements
[step.fetch_announcements]
type = "asx_announcements"
description = "Fetch official ASX announcements for {stock:ticker}"
depends = "fetch_stock_data"
on_error = "continue"
asx_code = "{stock:ticker}"
period = "Y1"
limit = 30
output_tags = ["{stock:ticker_lower}", "asx-{stock:ticker_lower}-announcements"]

# Step 3: Web search for additional financial data and news
[step.search_asx_stock]
type = "web_search"
description = "Search for financial news and analyst coverage"
depends = "fetch_announcements"
on_error = "fail"
api_key = "{google_gemini_api_key}"
query = "ASX:{stock:ticker} {stock:name} financial results analyst ratings dividend news site:afr.com OR site:theaustralian.com.au OR site:stockhead.com.au OR site:hotcopper.com.au"
output_tags = ["{stock:ticker_lower}", "asx-{stock:ticker_lower}-search"]
depth = 3
breadth = 3

# Step 4: Search for industry outlook and sector trends
[step.search_industry]
type = "web_search"
description = "Search for {stock:industry} sector industry outlook"
depends = "search_asx_stock"
on_error = "continue"
api_key = "{google_gemini_api_key}"
query = "Australian {stock:industry} sector outlook 2025 2026 trends market analysis"
output_tags = ["{stock:ticker_lower}", "asx-{stock:ticker_lower}-industry"]
depth = 2
breadth = 3

# Step 5: Search for competitor analysis
[step.search_competitors]
type = "web_search"
description = "Search for {stock:industry} competitor comparison"
depends = "search_industry"
on_error = "continue"
api_key = "{google_gemini_api_key}"
query = "ASX {stock:industry} comparison {stock:name} competitors market share performance 2025"
output_tags = ["{stock:ticker_lower}", "asx-{stock:ticker_lower}-competitors"]
depth = 2
breadth = 3

# Step 6: Analyze announcements vs price correlation (NOISE VS SIGNAL)
[step.analyze_announcements]
type = "summary"
description = "Analyze announcements against share price movements to identify noise vs signal"
depends = "search_competitors"
on_error = "fail"
filter_tags = ["{stock:ticker_lower}"]
api_key = "{google_gemini_api_key}"
prompt = """You are a critical equity research analyst specializing in separating NOISE from SIGNAL in corporate communications.

**COMPANY**: ASX:{stock:ticker} ({stock:name}) - {stock:industry} sector

**YOUR TASK**: Analyze each ASX announcement against the historical share price data to determine if announcements actually moved the stock price or were just PR noise.

**INPUT DOCUMENTS**:
1. Stock Data document - Contains historical daily prices and technicals for {stock:ticker}
2. Announcements document - Contains dated announcements with headlines for {stock:ticker}
3. Competitor stock data documents (dynamically fetched)

## REQUIRED ANALYSIS

### ANNOUNCEMENT-PRICE CORRELATION TABLE

For EACH announcement, determine if price moved significantly in the 3 days after:

| Date | Announcement | Price Before | Price +3 Days | Change % | SIGNAL/NOISE |
|------|--------------|--------------|---------------|----------|--------------|
| ... | ... | $... | $... | ...% | SIGNAL/NOISE |

**SIGNAL** = Price moved >3% in either direction within 3 trading days (use 2% for large caps)
**NOISE** = Price moved below threshold or moved opposite to announcement sentiment

### SIGNAL ANNOUNCEMENTS (Price Movers)
List announcements that ACTUALLY moved the share price with evidence:
- Date, headline, price change, why it was material

### NOISE ANNOUNCEMENTS (PR Fluff)
List announcements that had NO material price impact despite positive spin:
- Date, headline, expected vs actual price reaction

### CRITICAL ANALYSIS: PR vs REALITY

**Company Narrative Credibility Score: X/10**

1. **Track Record of Promises vs Delivery**
   - What did management promise in past announcements?
   - Were those targets met? Evidence from subsequent announcements.

2. **Pattern Detection**
   - Does the company frequently announce "significant" deals that don't move the stock?
   - Are announcements timed to coincide with capital raises or insider activity?

3. **Information Quality**
   - Do announcements contain specific metrics or vague language?
   - Are financial impacts quantified or left ambiguous?

4. **Red Flags Identified**
   - Promotional language without substance
   - Frequent "strategic partnership" announcements with no follow-up
   - Management changes with minimal explanation
   - Dilutive capital raises disguised as "growth funding"

### INVESTOR INTELLIGENCE SUMMARY

**OVERALL ASSESSMENT**: [CREDIBLE / CAUTIOUS / SKEPTICAL]

- **Signal-to-Noise Ratio**: X signal announcements / Y total announcements = Z%
- **Key Takeaway**: [One sentence on whether to trust company announcements]

---
**CRITICAL RULES**:
- Use ONLY prices from the Stock Data document
- If you cannot find price data for an announcement date, state "Price data unavailable - CANNOT VERIFY"
- Be skeptical - assume all announcements are noise until proven otherwise
- Call out promotional language explicitly
- IF YOU DO NOT HAVE DATA, SAY "UNKNOWN" - never fabricate or estimate
- Adjust volatility threshold based on company size (large caps ~2%, small caps ~5%)"""
output_tags = [
    "{stock:ticker_lower}",
    "asx-{stock:ticker_lower}-announcement-analysis",
]

# Step 7: Generate final investment analysis with all data
[step.summarize_results]
type = "summary"
description = "Generate comprehensive investment analysis with industry context and critical assessment"
depends = "analyze_announcements"
on_error = "fail"
filter_tags = ["{stock:ticker_lower}"]
api_key = "{google_gemini_api_key}"
prompt = """You are a professional equity research analyst. Generate a comprehensive investment report for ASX:{stock:ticker} ({stock:name}) using ALL collected data.

**COMPANY**: ASX:{stock:ticker} ({stock:name})
**SECTOR**: {stock:industry}

**INPUT DOCUMENTS**:
1. Stock Data document - {stock:ticker} price data and technicals
2. Competitor stock data documents (dynamically fetched - look for ASX:XXX Stock Data titles)
3. Announcements document - Raw {stock:ticker} announcements
4. Web Search results - {stock:industry} sector outlook and trends
5. Web Search results - {stock:industry} competitor comparison
6. Announcement-Price Correlation Analysis - Noise vs signal analysis

**CRITICAL DATA ACCURACY RULES**:
- Use ONLY the stock data provided in the input documents
- Do NOT invent, estimate, or hallucinate any prices, metrics, or figures
- If data is missing or unavailable, state "DATA UNAVAILABLE" or "UNKNOWN"
- When uncertain, say "UNCERTAIN" rather than guessing

## EXECUTIVE SUMMARY (Read First)

| Assessment | Rating | Confidence |
|------------|--------|------------|
| Technical Outlook | BULLISH / BEARISH / NEUTRAL | HIGH / MEDIUM / LOW |
| Announcement Credibility | HIGH / MEDIUM / LOW | |
| Signal-to-Noise Ratio | X% | |
| {stock:industry} Sector Outlook | POSITIVE / NEUTRAL / NEGATIVE | |
| Competitive Position | LEADER / STRONG / MODERATE | |
| Overall Recommendation | STRONG BUY / BUY / HOLD / SELL / STRONG SELL | |

## 1. PRICE ACTION ANALYSIS

### Current Position ({stock:ticker})
| Metric | Value | Signal |
|--------|-------|--------|
| Last Price | $ (or "UNAVAILABLE") | |
| vs SMA 20 | Above/Below by $X (X%) | Bullish/Bearish |
| vs SMA 50 | Above/Below by $X (X%) | Bullish/Bearish |
| vs SMA 200 | Above/Below by $X (X%) | Bullish/Bearish |
| RSI (14) | X | Overbought/Oversold/Neutral |
| 52-Week Position | X% (Low $X, High $X) | |

### Technical Verdict
- **Trend**: [Description of current trend with evidence FROM THE DATA]
- **Key Levels**: Support $X, Resistance $X
- **Pattern**: [Any chart patterns identified - or "No clear pattern"]

## 2. {stock:industry} SECTOR OUTLOOK

### Macro Environment
- **RBA Interest Rate Outlook**: [Current rate and expected trajectory - or "UNKNOWN if not in data"]
- **Economic Factors**: [Key drivers for {stock:industry} sector]
- **Regulatory Environment**: [Any relevant regulatory impacts]
- **Inflation/Cost Impact**: [On {stock:industry} margins and operations]

### Sector Headwinds/Tailwinds
[List key factors affecting the {stock:industry} sector based on search data]

### {stock:ticker}-Specific Sector Exposure
[Describe how {stock:name} is positioned within the {stock:industry} sector]

## 3. COMPETITIVE POSITIONING (With DYNAMICALLY FETCHED Competitor Data)

### Peer Comparison - USING ACTUAL FETCHED DATA
List ALL competitor stock data documents found and extract their key metrics:

| Stock | Last Price | Change % | SMA20 vs Price | RSI | Trend Signal |
|-------|------------|----------|----------------|-----|--------------|
| {stock:ticker} | $ | % | | | |
| [Competitor 1] | $ | % | | | |
| [Competitor 2] | $ | % | | | |
| ... | ... | ... | ... | ... | ... |

**NOTE**: The search steps identified competitors in the {stock:industry} sector.
All prices above MUST come from the fetched stock data documents. If unavailable, write "N/A".

### Valuation Comparison (if available in data)
| Stock | P/E | Div Yield | Market Cap |
|-------|-----|-----------|------------|
| {stock:ticker} | | % | $ |
| [Competitors...] | | % | $ |

### {stock:ticker} Competitive Position
- **Market Position**: [Assessment based on available data]
- **Technology/Innovation**: [Assessment if data available]
- **Capital Position**: [From announcements/search data]
- **Dividend Policy**: [Payout ratio, franking from data - if applicable]

### Competitive Advantages/Disadvantages
- **Strengths**: [Based on search and announcement data]
- **Weaknesses**: [Based on search and announcement data]

## 4. ANNOUNCEMENT QUALITY ASSESSMENT

### Credibility Score: X/10

**High-Impact Announcements** (Price moved significantly):
1. [Date]: [Headline] - Price impact: +/-X%

**Low-Impact "Noise"** (No price movement):
1. [Date]: [Headline] - Expected reaction vs actual

**Management Reliability**: [Assessment based on earnings guidance accuracy]

## 5. NOISE vs SIGNAL SUMMARY

**Signal Ratio**: X/Y announcements (Z%) actually moved the stock

**Key Findings**:
- [What announcement types are material for {stock:ticker}]
- [Patterns in how market reacts to {stock:ticker} news]

**Investor Intelligence**:
- [Insights on {stock:name} communication style]

## 6. INVESTMENT THESIS

### Bull Case
[List positive factors based on collected data]

### Bear Case
[List risk factors based on collected data]

### Fair Value Assessment
- **Base Case**: $X (X% upside/downside) - OR "INSUFFICIENT DATA FOR VALUATION"
- **Bull Case**: $X (if [positive scenario])
- **Bear Case**: $X (if [negative scenario])

## 7. ACTIONABLE RECOMMENDATION

### For Traders (1-4 weeks)
**SIGNAL: BUY / HOLD / SELL / NO TRADE**
- Entry: $X (or "Wait for confirmation")
- Stop Loss: $X
- Target: $X
- Risk/Reward: X:1
- **CONFIDENCE**: HIGH / MEDIUM / LOW

### For Investors (6-12 months)
**SIGNAL: BUY / HOLD / SELL**
- Accumulate below: $X
- Sell above: $X
- Key catalyst to watch: [Upcoming events/results]

### Dividend Investors (if applicable)
- Current yield: X% (or "SEE STOCK DATA" or "N/A")
- Expected yield: X%
- Ex-dividend dates to watch

## 8. COMPETITOR RELATIVE STRENGTH

Based on the fetched competitor stock data:

**Strongest Performer**: [Stock with best technicals]
**Weakest Performer**: [Stock with worst technicals]

**Relative {stock:ticker} Position**: [How {stock:ticker} compares technically to peers]

## 9. DATA SOURCES & CONFIDENCE

**Data Sources Used:**
- [List all web sources with URLs from the search results]
- [Include dates of data collection]
- [List all competitor stock data documents that were fetched]

**Data Quality Assessment:**
- Stock prices: [From ASX data sources - confidence level]
- Competitor data: [List which competitors were found]
- Industry data: [From web search - confidence level]

## 10. FINAL VERDICT

**[One paragraph summarizing:
1. Is {stock:ticker} attractively valued vs peers?
2. How does the macro outlook affect the thesis?
3. What are the key competitive advantages/risks?
4. What's the risk-adjusted recommendation?
5. What would change this view?]**

---
**CRITICAL WARNINGS**:
- This analysis is based on available data only
- Where data is missing, I have stated "UNAVAILABLE" or "UNKNOWN"
- Price targets are indicative only, not guarantees
- Past performance does not predict future results
- DO NOT trade solely based on this analysis
- Verify all figures independently before trading
- Competitors were identified from search data - verify they are correct"""
output_tags = ["asx-{stock:ticker_lower}-summary"]

# Step 8: Email the analysis report
[step.email_summary]
type = "email"
description = "Send ASX:{stock:ticker} investment analysis via email"
depends = "summarize_results"
on_error = "fail"
to = "{email_recipient}"
subject = "ASX:{stock:ticker} Investment Analysis - {stock:name}"
body_from_tag = "asx-{stock:ticker_lower}-summary"
