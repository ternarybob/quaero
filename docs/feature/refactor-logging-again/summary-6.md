# Summary: Server-Assigned Line Numbers for Real-Time SSE (Iteration 6)

## Issue

User identified that line numbers on the left side of logs were being generated by the frontend, not the server. This caused incorrect line numbers when SSE streamed new logs in real-time.

## Root Cause

The SSE event payload for job logs did NOT include `line_number`:

```go
// BEFORE - no line_number in event
payload := map[string]interface{}{
    "job_id":     jobID,
    "message":    message,
    "timestamp":  now.Format(time.RFC3339),
    // line_number was MISSING
}
```

Although the storage layer (`AppendLog`) correctly assigned line numbers when persisting logs, this value was not returned to the caller and therefore not included in the SSE event.

## Fixes Applied

### 1. Interface Changes

Updated `LogStorage` and `LogService` interfaces to return the assigned line number:

**`internal/interfaces/storage.go`:**
```go
// BEFORE
AppendLog(ctx context.Context, jobID string, entry models.LogEntry) error

// AFTER
AppendLog(ctx context.Context, jobID string, entry models.LogEntry) (lineNumber int, err error)
```

**`internal/interfaces/queue_service.go`:**
```go
// BEFORE
AppendLog(ctx context.Context, jobID string, entry models.LogEntry) error

// AFTER
AppendLog(ctx context.Context, jobID string, entry models.LogEntry) (lineNumber int, err error)
```

### 2. Implementation Changes

**`internal/storage/badger/log_storage.go`:**
```go
func (s *LogStorage) AppendLog(...) (int, error) {
    // ... existing code ...
    return entry.LineNumber, nil
}
```

**`internal/logs/service.go`:**
```go
func (s *Service) AppendLog(...) (int, error) {
    return s.storage.AppendLog(ctx, jobID, entry)
}
```

### 3. Event Payload Update

**`internal/queue/job_manager.go`:**
```go
lineNumber, err := m.logStorage.AppendLog(ctx, jobID, entry)
if err != nil {
    return fmt.Errorf("failed to append log: %w", err)
}

payload := map[string]interface{}{
    // ... other fields ...
    "line_number": lineNumber,  // NOW INCLUDED
}
```

### 4. Frontend Updates

**`pages/queue.html`:**
- Re-enabled sorting by `line_number` in `handleSSELogs`
- Updated display to always use server-provided `log.line_number`

```html
<!-- BEFORE - conditional line number -->
<span x-text="hasStepEarlierLogs(...) ? (log.line_number || (logIdx + 1)) : (logIdx + 1)">

<!-- AFTER - always use server line number -->
<span x-text="log.line_number || (logIdx + 1)">
```

## Files Modified

1. `internal/interfaces/storage.go` - Updated `LogStorage.AppendLog` signature
2. `internal/interfaces/queue_service.go` - Updated `LogService.AppendLog` signature
3. `internal/storage/badger/log_storage.go` - Return line number from `AppendLog`
4. `internal/logs/service.go` - Return line number from `AppendLog`
5. `internal/queue/job_manager.go` - Include `line_number` in event payload
6. `internal/queue/state/runtime.go` - Handle new return value (ignore line number)
7. `pages/queue.html` - Use server-provided line numbers in display

## Build Status

âœ… Build passes

## Testing

1. Restart the server
2. Hard-refresh browser (Ctrl+F5)
3. Create a Test Job Generator job
4. Watch the log panel - line numbers should now match the actual log sequence
5. New SSE logs should appear with correct sequential line numbers
