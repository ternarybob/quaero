# Test: Log Line Numbers Are Server-Provided

## Test File
`test/ui/job_test_generator_streaming_test.go`

## Test Function
`TestLogLineNumbersAreServerProvided`

## Purpose
This test verifies that log line numbers displayed in the UI come from the server (`line_number` field) and are NOT generated by the UI using the array index.

## What It Tests

### Assertion 1: Line numbers should be sequential
```go
for i := 1; i < len(step.LineNumbers); i++ {
    diff := step.LineNumbers[i] - step.LineNumbers[i-1]
    assert.Equal(t, 1, diff, "Line numbers should be sequential")
}
```
Verifies there are no gaps in the displayed line numbers (1, 2, 3... not 1, 3, 5...).

### Assertion 2: First line number should NOT be 1 when showing latest logs
```go
if step.TotalLog > step.DisplayedLog {
    assert.NotEqual(t, 1, firstLineNum,
        "First line number should NOT be 1 when showing last N of M logs")
}
```
**This is the key assertion that catches the current bug.**

If we have 3556 total logs and are showing the last 100, the line numbers should be ~3457-3556, NOT 1-100.

If the first line number is 1, it means the UI is generating numbers from the array index instead of using server-provided `line_number`.

### Assertion 3: Last line number should be close to total
```go
assert.InDelta(t, float64(step.TotalLog), float64(lastLineNum), float64(step.DisplayedLog),
    "Last line number should be close to total")
```
Verifies we're showing the LATEST logs (not oldest) with correct server line numbers.

### Assertion 4: Displayed count matches actual count
```go
assert.Equal(t, len(step.LineNumbers), step.DisplayedLog,
    "Actual displayed log count should match badge count")
```
Verifies the `logs: X/Y` badge X value matches actual DOM elements.

## Expected Failure Message
When the bug is present, the test will fail with:
```
Step high_volume_generator: First line number should NOT be 1 when showing last 100 of 3556 logs
(line_number should come from server, not be UI-generated)
```

## Running the Test
```bash
go test -v -run TestLogLineNumbersAreServerProvided ./test/ui/...
```

## Bug Being Caught
The UI template at `pages/queue.html:728`:
```html
<span class="tree-log-num" x-text="log.line_number || (logIdx + 1)"></span>
```

Falls back to `(logIdx + 1)` when `log.line_number` is 0 or undefined, causing UI-generated line numbers 1, 2, 3... instead of server values like 3457, 3458, 3459...
