{
  "task": "Remove environment parameter from functions and consolidate configuration in internal\\common\\config.go",
  "folder": "remove-environment-parameter",
  "context": {
    "problem": "The 'environment' parameter is passed through multiple layers (storage.NewStorageManager -> sqlite.NewManager -> sqlite.NewSQLiteDB) when it should be accessed directly from Config. This violates single responsibility principle where config processing should be centralized in internal\\common\\config.go",
    "current_flow": "Config -> storage.NewStorageManager(logger, config) -> sqlite.NewManager(logger, sqliteConfig, config.Environment) -> sqlite.NewSQLiteDB(logger, sqliteConfig, environment)",
    "desired_flow": "Config (with Environment field) -> sqlite.NewSQLiteDB uses config.Environment directly for reset_on_startup validation"
  },
  "steps": [
    {
      "id": 1,
      "task": "Add Environment field to SQLiteConfig struct in internal\\common\\config.go. This makes environment a first-class configuration setting that travels with SQLite config, eliminating the need to pass it separately.",
      "validation": "Verify Environment field is added to SQLiteConfig struct with toml tag. Run 'go build' to ensure no syntax errors. Check that NewDefaultConfig() sets SQLite.Environment to match top-level Environment field (default: 'development').",
      "files_affected": [
        "C:\\development\\quaero\\internal\\common\\config.go"
      ]
    },
    {
      "id": 2,
      "task": "Update NewDefaultConfig() in internal\\common\\config.go to initialize SQLite.Environment field. Set it to match the top-level Environment field ('development' by default). This ensures consistency between global and SQLite-specific environment settings.",
      "validation": "Verify SQLite.Environment is set in NewDefaultConfig(). Confirm it matches top-level Environment field. Run 'go build' to ensure no compilation errors.",
      "files_affected": [
        "C:\\development\\quaero\\internal\\common\\config.go"
      ]
    },
    {
      "id": 3,
      "task": "Update applyEnvOverrides() in internal\\common\\config.go to sync Environment field changes to SQLiteConfig. When QUAERO_ENV or GO_ENV environment variables update config.Environment, also update config.Storage.SQLite.Environment to maintain consistency.",
      "validation": "Verify that after setting config.Environment from env vars, config.Storage.SQLite.Environment is also updated. Add test case or manual verification that both fields stay synchronized. Run 'go build' to ensure no compilation errors.",
      "files_affected": [
        "C:\\development\\quaero\\internal\\common\\config.go"
      ]
    },
    {
      "id": 4,
      "task": "Remove environment parameter from NewSQLiteDB function signature in internal\\storage\\sqlite\\connection.go. Update function body to access environment from config.Environment instead of parameter. Update all references to 'environment' variable to use 'config.Environment' instead.",
      "validation": "Verify NewSQLiteDB signature changed from 'func NewSQLiteDB(logger arbor.ILogger, config *common.SQLiteConfig, environment string)' to 'func NewSQLiteDB(logger arbor.ILogger, config *common.SQLiteConfig)'. Confirm all uses of 'environment' variable in function body now use 'config.Environment'. Run 'go build' to identify all callers that need updating.",
      "files_affected": [
        "C:\\development\\quaero\\internal\\storage\\sqlite\\connection.go"
      ]
    },
    {
      "id": 5,
      "task": "Update sqlite.NewManager function in internal\\storage\\sqlite\\manager.go to remove environment parameter from signature and remove it from NewSQLiteDB call. NewManager should only pass logger and config to NewSQLiteDB.",
      "validation": "Verify NewManager signature changed from 'func NewManager(logger arbor.ILogger, config *common.SQLiteConfig, environment string)' to 'func NewManager(logger arbor.ILogger, config *common.SQLiteConfig)'. Confirm NewSQLiteDB is called without environment parameter. Run 'go build' to identify callers.",
      "files_affected": [
        "C:\\development\\quaero\\internal\\storage\\sqlite\\manager.go"
      ]
    },
    {
      "id": 6,
      "task": "Update storage.NewStorageManager function in internal\\storage\\factory.go to remove config.Environment from sqlite.NewManager call. Pass only logger and &config.Storage.SQLite to NewManager since SQLiteConfig now contains its own Environment field.",
      "validation": "Verify sqlite.NewManager call changed from 'sqlite.NewManager(logger, &config.Storage.SQLite, config.Environment)' to 'sqlite.NewManager(logger, &config.Storage.SQLite)'. Run 'go build' to ensure compilation succeeds.",
      "files_affected": [
        "C:\\development\\quaero\\internal\\storage\\factory.go"
      ]
    },
    {
      "id": 7,
      "task": "Update test file internal\\storage\\sqlite\\document_storage_search_test.go setupTestDB function to remove environment parameter from NewSQLiteDB call. The test creates its own config so no environment parameter is needed.",
      "validation": "Verify setupTestDB's NewSQLiteDB call changed from 'NewSQLiteDB(logger, config, environment)' to 'NewSQLiteDB(logger, config)'. Run 'go test -v ./internal/storage/sqlite' to ensure tests pass.",
      "files_affected": [
        "C:\\development\\quaero\\internal\\storage\\sqlite\\document_storage_search_test.go"
      ]
    },
    {
      "id": 8,
      "task": "Run full test suite to verify all changes work correctly. Test both development and production environment configurations. Verify reset_on_startup behavior still works correctly in development mode.",
      "validation": "Run 'go test ./...' to execute all tests. Manually test with QUAERO_ENV=development and QUAERO_ENV=production to verify environment-specific behavior. Check that reset_on_startup only works in development environment. Verify no compilation errors and all tests pass.",
      "files_affected": [
        "All files in the project (test suite)"
      ]
    },
    {
      "id": 9,
      "task": "Build the application using scripts\\build.ps1 to ensure production build succeeds with all changes.",
      "validation": "Run '.\\scripts\\build.ps1' and verify successful build. Check that quaero.exe is created in bin\\ directory. Verify no runtime errors when starting the application with default configuration.",
      "files_affected": [
        "All files (build verification)"
      ]
    }
  ],
  "architecture_notes": {
    "before": "Environment parameter passed through 3 layers: storage.NewStorageManager -> sqlite.NewManager -> sqlite.NewSQLiteDB",
    "after": "Environment stored in SQLiteConfig and accessed directly where needed (sqlite.NewSQLiteDB)",
    "benefits": [
      "Single source of truth for environment configuration",
      "Follows CLAUDE.md principle: all configuration processing in internal\\common\\config.go",
      "Reduces parameter passing complexity",
      "Makes environment a first-class SQLite configuration setting",
      "Easier to test and mock"
    ],
    "risk_mitigation": [
      "Small, incremental changes",
      "Each step independently testable",
      "Compile-time verification at each step",
      "Test suite validates behavior unchanged",
      "Production build verification as final step"
    ]
  }
}
