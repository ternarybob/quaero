{
  "task": "Load job configs via API for test data setup",
  "folder": "test-job-config-loading",
  "overview": "Implement test setup to load job definition TOML files via API at test startup. This provides test data for UI tests that edit and modify job definitions.",
  "context": {
    "api_endpoint": "POST /api/job-definitions/upload",
    "handler": "UploadJobDefinitionTOMLHandler in internal/handlers/job_definition_handler.go",
    "test_configs": [
      "test/config/news-crawler.toml - Required at startup, fail if not loaded",
      "test/config/my-custom-crawler.toml - Used for specific edit tests"
    ],
    "affected_tests": [
      "TestEditJobDefinition - Edit a user job (loads editor)",
      "TestEditJobSave - Edit and save a user job"
    ],
    "test_infrastructure": "test/common/setup.go - SetupTestEnvironment() function"
  },
  "steps": [
    {
      "id": 1,
      "task": "Add HTTPTestHelper method for multipart form uploads",
      "description": "The UploadJobDefinitionTOMLHandler expects TOML content in the request body. Add a POSTFile or POSTBody method to HTTPTestHelper that sends raw content with appropriate Content-Type header.",
      "files_affected": [
        "test/common/setup.go"
      ],
      "implementation_details": {
        "method_signature": "func (h *HTTPTestHelper) POSTBody(path string, body []byte, contentType string) (*http.Response, error)",
        "usage": "h.POSTBody(\"/api/job-definitions/upload\", tomlBytes, \"application/toml\")",
        "location": "Add after existing POST method around line 795"
      },
      "validation": "Can compile without errors. Method should be similar to existing POST but accept []byte instead of interface{}"
    },
    {
      "id": 2,
      "task": "Create helper function to load TOML files via API",
      "description": "Add a helper function that loads a TOML file and uploads it via the API. This will be called during test setup.",
      "files_affected": [
        "test/common/setup.go"
      ],
      "implementation_details": {
        "function_signature": "func (env *TestEnvironment) LoadJobDefinitionFile(t *testing.T, filePath string) error",
        "logic": [
          "Read TOML file from disk (os.ReadFile)",
          "Create HTTPTestHelper",
          "POST to /api/job-definitions/upload with TOML content",
          "Check response status (201 Created or 200 OK for updates)",
          "Log success/failure to test log",
          "Return error if upload fails"
        ],
        "location": "Add after GetResultsDir() method around line 706"
      },
      "validation": "Can compile without errors. Function should handle both file read errors and API errors gracefully."
    },
    {
      "id": 3,
      "task": "Add test setup function to load required job configs",
      "description": "Create a function that loads all required job definition files. This will be called after service startup but before tests run.",
      "files_affected": [
        "test/common/setup.go"
      ],
      "implementation_details": {
        "function_signature": "func (env *TestEnvironment) LoadTestJobDefinitions(t *testing.T) error",
        "logic": [
          "Define list of required job configs: [\"../config/news-crawler.toml\"]",
          "Define list of optional job configs: [\"../config/my-custom-crawler.toml\"]",
          "Loop through required configs and call LoadJobDefinitionFile",
          "Fail immediately if any required config fails to load",
          "Loop through optional configs and call LoadJobDefinitionFile",
          "Log warning (not error) if optional configs fail",
          "Return nil if all required configs loaded successfully"
        ],
        "location": "Add after LoadJobDefinitionFile() method"
      },
      "validation": "Can compile without errors. Function should distinguish between required and optional configs."
    },
    {
      "id": 4,
      "task": "Integrate job config loading into SetupTestEnvironment",
      "description": "Call LoadTestJobDefinitions after service is ready but before returning the environment to the test.",
      "files_affected": [
        "test/common/setup.go"
      ],
      "implementation_details": {
        "location": "After service ready check (around line 322)",
        "code_to_add": [
          "// Load test job definitions",
          "fmt.Fprintf(logFile, \"\\n=== LOADING TEST JOB DEFINITIONS ===\\n\")",
          "if err := env.LoadTestJobDefinitions(t); err != nil {",
          "    fmt.Fprintf(logFile, \"❌ Failed to load test job definitions: %v\\n\", err)",
          "    env.Cleanup()",
          "    return nil, fmt.Errorf(\"failed to load test job definitions: %w\", err)",
          "}",
          "fmt.Fprintf(logFile, \"✓ Test job definitions loaded\\n\")"
        ]
      },
      "validation": "Tests should fail if news-crawler.toml cannot be loaded. Tests should still run if my-custom-crawler.toml fails."
    },
    {
      "id": 5,
      "task": "Update SetupTestEnvironment signature to accept testing.T",
      "description": "The SetupTestEnvironment function needs access to testing.T to log messages during setup. Currently it only gets testName string.",
      "files_affected": [
        "test/common/setup.go"
      ],
      "implementation_details": {
        "current_signature": "func SetupTestEnvironment(testName string) (*TestEnvironment, error)",
        "new_signature": "func SetupTestEnvironment(t *testing.T, testName string) (*TestEnvironment, error)",
        "reason": "Need t for logging in LoadTestJobDefinitions helper",
        "note": "This is a breaking change - all existing test calls must be updated"
      },
      "validation": "After this change, all tests will fail to compile until step 6 is completed."
    },
    {
      "id": 6,
      "task": "Update all test calls to SetupTestEnvironment",
      "description": "Update every test in test/ui/ to pass testing.T to SetupTestEnvironment. This is a mechanical change across all test files.",
      "files_affected": [
        "test/ui/jobs_test.go",
        "test/ui/auth_test.go",
        "test/ui/browser_validation_test.go",
        "test/ui/chat_test.go",
        "test/ui/config_test.go",
        "test/ui/connectivity_test.go",
        "test/ui/hero_consistency_test.go",
        "test/ui/homepage_test.go",
        "test/ui/queue_test.go",
        "test/ui/queue_rerun_test.go",
        "test/ui/search_test.go"
      ],
      "implementation_details": {
        "find": "env, err := common.SetupTestEnvironment(\"TestName\")",
        "replace": "env, err := common.SetupTestEnvironment(t, \"TestName\")",
        "method": "Use Edit tool with replace_all for each file"
      },
      "validation": "All tests should compile after this step. Run 'go test -v ./test/ui' to verify compilation (tests may fail but should compile)."
    },
    {
      "id": 7,
      "task": "Verify TestEditJobDefinition can find user jobs",
      "description": "With news-crawler.toml loaded at startup, TestEditJobDefinition should now find a user job to edit instead of skipping the test.",
      "files_affected": [
        "test/ui/jobs_test.go"
      ],
      "implementation_details": {
        "test_name": "TestEditJobDefinition",
        "current_behavior": "Skips test if no user jobs found (line 1040)",
        "expected_behavior": "Should find news-crawler job and proceed with edit test",
        "verification": "Run: cd test/ui && go test -v -run TestEditJobDefinition"
      },
      "validation": "Test should pass and log 'Found user job: News Crawler' instead of skipping."
    },
    {
      "id": 8,
      "task": "Verify TestEditJobSave can modify user jobs",
      "description": "With news-crawler.toml loaded, TestEditJobSave should find a user job to modify and test the save functionality.",
      "files_affected": [
        "test/ui/jobs_test.go"
      ],
      "implementation_details": {
        "test_name": "TestEditJobSave",
        "current_behavior": "Skips test if no user jobs found via API (line 1239)",
        "expected_behavior": "Should find news-crawler job, modify TOML, and save successfully",
        "verification": "Run: cd test/ui && go test -v -run TestEditJobSave"
      },
      "validation": "Test should pass and show job was modified and saved. Check for success notification in logs."
    },
    {
      "id": 9,
      "task": "Add optional loading of my-custom-crawler.toml",
      "description": "my-custom-crawler.toml is marked optional in LoadTestJobDefinitions. Tests can check if it exists and use it for additional test scenarios.",
      "files_affected": [
        "test/ui/jobs_test.go"
      ],
      "implementation_details": {
        "approach": "Tests can check for 'My Custom Crawler' job and run additional assertions",
        "example": "Check if job with ID 'my-custom-crawler' exists in ListJobDefinitionsHandler response",
        "benefit": "Allows testing multiple user jobs without making test brittle"
      },
      "validation": "If my-custom-crawler.toml exists, tests should use it. If not, tests should still pass with just news-crawler."
    },
    {
      "id": 10,
      "task": "Add comprehensive test execution and validation",
      "description": "Run full test suite to ensure no regressions and verify job configs are loaded correctly.",
      "files_affected": [
        "All test files in test/ui/"
      ],
      "implementation_details": {
        "test_commands": [
          "cd test/ui",
          "go test -v -run TestEditJobDefinition",
          "go test -v -run TestEditJobSave",
          "go test -v -run TestSystemJobProtection",
          "go test -v ./..."
        ],
        "verification_points": [
          "TestEditJobDefinition no longer skips",
          "TestEditJobSave no longer skips",
          "All jobs page tests still pass",
          "Job definitions are loaded before any test runs",
          "Service logs show 'Test job definitions loaded'"
        ]
      },
      "validation": "All tests should pass. Check test/results/ directories for screenshots and logs confirming job loading."
    }
  ],
  "technical_notes": {
    "api_behavior": {
      "endpoint": "POST /api/job-definitions/upload",
      "handler": "UploadJobDefinitionTOMLHandler",
      "request": {
        "method": "POST",
        "body": "Raw TOML file content",
        "content_type": "application/toml or text/plain"
      },
      "response": {
        "success_codes": [201, 200],
        "201": "Job created (first upload)",
        "200": "Job updated (subsequent uploads)",
        "400": "Invalid TOML or validation failed",
        "403": "Attempted to update system job",
        "500": "Server error"
      }
    },
    "test_infrastructure": {
      "setup_sequence": [
        "1. Build application (buildService)",
        "2. Check for existing service (isServiceRunning)",
        "3. Start test service (startService)",
        "4. Wait for service ready (WaitForServiceReady)",
        "5. Load test job definitions (NEW: LoadTestJobDefinitions)",
        "6. Return environment to test"
      ],
      "http_helper": "HTTPTestHelper provides GET, POST, PUT, DELETE methods",
      "new_method": "POSTBody for uploading raw content"
    },
    "job_definition_files": {
      "news-crawler.toml": {
        "id": "news-crawler",
        "name": "News Crawler",
        "type": "crawler",
        "required": true,
        "purpose": "Provides test data for edit tests"
      },
      "my-custom-crawler.toml": {
        "id": "my-custom-crawler",
        "name": "My Custom Crawler",
        "type": "crawler",
        "required": false,
        "purpose": "Additional test data for multiple job scenarios"
      }
    },
    "error_handling": {
      "required_configs": "Test setup must fail if news-crawler.toml cannot be loaded",
      "optional_configs": "Log warning but continue if my-custom-crawler.toml fails",
      "api_errors": "Check response status and parse error messages from API",
      "file_errors": "Handle file not found, permission denied, invalid TOML"
    }
  },
  "testing_strategy": {
    "unit_testing": "Not applicable - this is integration test infrastructure",
    "integration_testing": [
      "Verify TOML files are uploaded correctly",
      "Verify API returns expected status codes",
      "Verify job definitions appear in ListJobDefinitionsHandler",
      "Verify TestEditJobDefinition finds loaded jobs",
      "Verify TestEditJobSave can modify loaded jobs"
    ],
    "manual_testing": [
      "Run individual test: go test -v -run TestEditJobDefinition",
      "Run test suite: go test -v ./test/ui",
      "Check service logs in test/results/ui/{suite}-{timestamp}/{test}/service.log",
      "Check test logs in test/results/ui/{suite}-{timestamp}/{test}/test.log",
      "Verify screenshots show job loaded in UI"
    ]
  },
  "success_criteria": [
    "✅ news-crawler.toml is loaded via API at test startup",
    "✅ Test fails if news-crawler.toml cannot be loaded",
    "✅ my-custom-crawler.toml is loaded if available (optional)",
    "✅ TestEditJobDefinition finds News Crawler job and proceeds",
    "✅ TestEditJobSave finds News Crawler job and saves successfully",
    "✅ All existing tests still pass",
    "✅ No regressions in test infrastructure",
    "✅ Service logs show job definitions being loaded"
  ],
  "rollback_plan": {
    "step_5_breaking_change": "If step 5 breaks too many tests, consider alternative: pass testing.T through context or add separate initialization function",
    "alternative_approach": "Instead of modifying SetupTestEnvironment signature, create SetupTestEnvironmentWithJobs(t, testName, jobFiles) variant",
    "minimal_change_option": "Load job files in each test individually instead of in SetupTestEnvironment (less DRY but simpler)"
  }
}
