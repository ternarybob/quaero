# Stock Deep Dive Analysis - Orchestrator Goal Template
# Type: orchestrator (for OrchestratorWorker)
#
# Comprehensive stock analysis using LLM orchestration with dynamic tool calling.
# Uses Kneppy Invest Business Rating framework for structured analysis.
#
# This template can be used as a reference for the orchestrator step config.
# Copy the goal and available_tools to your job definition's step config.

type = "orchestrator"

# Available tools - workers exposed to the orchestrator as callable tools
available_tools = [
    { name = "fetch_fundamentals", description = "Fetch comprehensive stock fundamentals including financials, valuation metrics, analyst coverage, and historical data. Creates document tagged with ['fundamentals', '<ticker>']. REQUIRED params: ticker (string, e.g. 'ASX:GNP'). OPTIONAL: period (string) - Y1, Y2, Y3, Y5 (default Y3). Provides: PE ratio, EV/EBITDA, margins, shares outstanding, insider ownership, revenue/profit history, analyst targets.", worker = "market_fundamentals" },
    { name = "fetch_announcements", description = "Fetch and classify official ASX company announcements with price sensitivity flags and signal:noise analysis. Creates document tagged with ['announcements', '<ticker>']. REQUIRED params: ticker (string, e.g. 'ASX:GNP'). OPTIONAL: period (string) - M1, M3, M6, Y1 (default Y1), limit (int) - max announcements. Provides: announcements with relevance classification, price sensitivity flags, signal-to-noise ratio.", worker = "market_announcements" },
    { name = "fetch_market_data", description = "Fetch price history and calculate technical indicators. Creates document tagged with ['market-data', '<ticker>']. REQUIRED params: ticker (string, e.g. 'ASX:GNP'). OPTIONAL: period (string) - M1, M3, M6, Y1, Y2 (default Y2). Provides: current price, OHLCV history, SMA20/50/200, RSI14, support/resistance levels, trend signal.", worker = "market_data" },
    { name = "analyze_competitors", description = "Identify ASX-listed competitors using LLM analysis of company fundamentals. Creates document tagged with ['competitors', '<ticker>']. REQUIRED params: ticker (string, e.g. 'ASX:GNP'). Provides: list of competitor ASX codes with rationale for competitive moat assessment.", worker = "market_competitor" },
    { name = "fetch_annual_report", description = "Extract structured financial data from annual report PDFs (ROIC, WACC, debt facilities, management guidance). Creates document tagged with ['annual-report', '<ticker>']. REQUIRED params: ticker (string, e.g. 'ASX:GNP'). OPTIONAL: max_reports (int) - number of reports to process (default 1). Provides: ROIC reported, WACC disclosed, debt facility details, capital raise purposes, segment data.", worker = "market_annual_report" },
    { name = "analyze_summary", description = "Generate deep LLM-based analysis from collected documents using the Kneppy framework template. REQUIRED params: prompt (string) - detailed analysis instructions, filter_tags (array) - tags to filter documents. OPTIONAL: thinking_level (string) - LOW or HIGH (use HIGH for comprehensive analysis). The prompt should reference the Kneppy Invest framework pillars.", worker = "summary" },
]

goal = """
Perform a comprehensive deep dive analysis of all ASX stocks in the variables list using the Kneppy Invest Business Rating framework.

=== PHASE 1: DATA COLLECTION (for EACH stock) ===

For EACH ticker in the variables list, collect all required data:

1. FUNDAMENTALS: Fetch comprehensive fundamentals
   - Use fetch_fundamentals with period: Y3 for 3-year historical data
   - Creates document tagged with ['fundamentals', '<ticker>']
   - Provides: PE ratio, EV/EBITDA, margins, shares outstanding, insider ownership,
     revenue history, profit margins, analyst targets, analyst estimates

2. ANNOUNCEMENTS: Fetch 1-year of ASX announcements
   - Use fetch_announcements with period: Y1
   - Creates document tagged with ['announcements', '<ticker>']
   - Provides: classified announcements with signal:noise ratio

3. MARKET DATA: Fetch price history and technicals
   - Use fetch_market_data with period: Y2
   - Creates document tagged with ['market-data', '<ticker>']
   - Provides: price, SMAs, RSI14, support/resistance, trend signal

4. COMPETITOR ANALYSIS: Identify ASX-listed competitors
   - Use analyze_competitors for each ticker
   - Creates document tagged with ['competitors', '<ticker>']
   - Provides: competitor codes for moat assessment

5. ANNUAL REPORT DATA: Extract structured data from annual reports
   - Use fetch_annual_report for each ticker
   - Creates document tagged with ['annual-report', '<ticker>']
   - Provides: ROIC reported, WACC disclosed, debt facility details,
     capital raise purposes, management guidance, segment data

=== PHASE 2: DEEP DIVE ANALYSIS ===

After collecting data for EACH stock, perform comprehensive analysis:

6. KNEPPY FRAMEWORK ANALYSIS
   For each stock, use analyze_summary with HIGH thinking_level and filter by ['fundamentals', '<ticker>'] plus other relevant tags.

   The analysis MUST cover all SIX PILLARS of the Kneppy Invest Business Rating:

   QUANTITATIVE PILLARS (Fact-Based):
   1. CAPITAL EFFICIENCY (The Compounding Engine)
      - ROIC consistently > 15%
      - 5-year trend analysis
      - ROIC vs WACC spread

   2. SHARE ALLOCATION & DILUTION CONTROL
      - Outstanding shares flat or decreasing
      - Opportunistic buybacks
      - No value-destructive capital raises

   3. FINANCIAL ROBUSTNESS
      - Net Debt/EBITDA < 2.0x (preferably zero)
      - Strong cash position
      - Adequate runway

   4. CASH FLOW REALITY
      - FCF/Net Income conversion > 90%
      - Quality of earnings
      - Working capital trends

   QUALITATIVE PILLARS (Human Layer):
   5. MANAGEMENT ALIGNMENT & SKIN IN THE GAME
      - Insider ownership levels
      - Recent insider trading patterns
      - Institutional backing

   6. COMPETITIVE MOAT
      - Source of advantage (Brand/Switching/Network/Cost/None)
      - Margin sustainability
      - Competitor positioning

   CRITICAL REQUIREMENTS FOR ANALYSIS:
   - For EVERY metric, report the ACTUAL VALUE from collected data
   - If data is not available, mark it explicitly as "DATA_UNAVAILABLE"
   - NEVER fabricate or assume values
   - Complete the Improvements section identifying data gaps

=== PHASE 3: SYNTHESIS ===

7. FINAL SCORECARD
   Create a consolidated report for each stock including:
   - Scorecard table with all 6 pillars
   - Data Completeness Score (X/6 pillars)
   - Quality Grade (A/B/C/D/F)
   - Investment Recommendation (ACCUMULATE/HOLD/REDUCE/AVOID)
   - Conviction Level (1-10)
   - Reasoning (2-3 sentences)

8. IMPROVEMENTS SECTION (REQUIRED)
   - List ALL metrics marked DATA_UNAVAILABLE
   - Impact of each data gap on analysis
   - Recommended additional sources
   - Next steps for better analysis

=== OUTPUT REQUIREMENTS ===

FINAL OUTPUT MUST INCLUDE:
- Individual stock deep dive reports with all Kneppy pillars
- Final scorecard with Quality Grade for each stock
- Clear marking of data gaps with DATA_UNAVAILABLE
- Improvements section with specific recommendations
- Summary table: Ticker | Quality Grade | Recommendation | Conviction | Data Completeness

If data collection fails for any stock:
- Note the failure explicitly
- Continue with remaining stocks
- Include failure in final summary
"""
