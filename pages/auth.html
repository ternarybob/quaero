<!DOCTYPE html>
<html lang="en">

<head>
    {{template "head.html" .}}
    <title>Authentication Management - Quaero</title>
</head>

<body>

    {{template "navbar.html" .}}

    <main class="page-container">

        <!-- Page Title -->
        <div class="page-title">
            <h1>Authentication Management</h1>
            <p>Manage authentication credentials captured from websites</p>
        </div>

        <!-- Authentication Section -->
        <section style="margin-top: 1.5rem;" x-data="authPage()">
            <div class="card">
                <div class="card-header">
                    <header class="navbar">
                        <section class="navbar-section">
                            <h3>Authentication</h3>
                        </section>
                        <section class="navbar-section">
                            <button class="btn btn-sm" @click="loadAuthentications" title="Refresh Authentications">
                                <i class="fa-solid fa-rotate-right"></i>
                            </button>
                        </section>
                    </header>
                </div>
                <div class="card-body">
                    <!-- Loading State -->
                    <div x-show="loading" class="text-center p-5">
                        <span class="icon">
                            <i class="fas fa-spinner fa-pulse fa-2x"></i>
                        </span>
                        <p class="mt-3">Loading authentications...</p>
                    </div>

                    <!-- Empty State -->
                    <div x-show="!loading && authentications.length === 0" class="text-center p-5">
                        <span class="icon text-muted">
                            <i class="fas fa-lock fa-3x"></i>
                        </span>
                        <p class="mt-3 text-muted">No authentication credentials stored</p>
                        <p class="text-muted">Use the Chrome extension to capture authentication from your sites</p>
                    </div>

                    <!-- Authentication Table -->
                    <div x-show="!loading && authentications.length > 0">
                        <table class="table striped border">
                            <thead>
                                <tr>
                                    <th>Site</th>
                                    <th>Name</th>
                                    <th>Service Type</th>
                                    <th>Last Updated</th>
                                    <th class="text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="auth in authentications" :key="auth.id">
                                    <tr>
                                        <td>
                                            <strong x-text="auth.site_domain"></strong>
                                            <br>
                                            <small class="text-muted" x-text="auth.base_url"></small>
                                        </td>
                                        <td x-text="auth.name || '-'"></td>
                                        <td>
                                            <span class="label label-secondary" x-text="(auth.service_type || 'unknown').toUpperCase()"></span>
                                        </td>
                                        <td x-text="formatDate(auth.updated_at)"> </td>
                                        <td class="text-right">
                                            <button class="btn btn-sm btn-error" @click="deleteAuthentication(auth.id, auth.site_domain)" :disabled="deleting === auth.id" title="Delete Authentication">
                                                <i class="fas" :class="deleting === auth.id ? 'fa-spinner fa-pulse' : 'fa-trash'"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- API Keys Section -->
        <section style="margin-top: 1.5rem;" x-data="apiKeysPage()">
            <div class="card">
                <div class="card-header">
                    <header class="navbar">
                        <section class="navbar-section">
                            <h3>API Keys</h3>
                        </section>
                        <section class="navbar-section">
                            <button class="btn btn-sm" @click="loadApiKeys" title="Refresh API Keys">
                                <i class="fa-solid fa-rotate-right"></i>
                            </button>
                            <button class="btn btn-sm btn-primary ml-2" @click="showCreateModal = true" title="Add API Key">
                                <i class="fa-solid fa-plus"></i>
                                Add API Key
                            </button>
                        </section>
                    </header>
                </div>
                <div class="card-body">
                    <!-- Loading State -->
                    <div x-show="loading" class="text-center p-5">
                        <span class="icon">
                            <i class="fas fa-spinner fa-pulse fa-2x"></i>
                        </span>
                        <p class="mt-3">Loading API keys...</p>
                    </div>

                    <!-- Empty State -->
                    <div x-show="!loading && apiKeys.length === 0" class="text-center p-5">
                        <span class="icon text-muted">
                            <i class="fas fa-key fa-3x"></i>
                        </span>
                        <p class="mt-3 text-muted">No API keys stored</p>
                        <p class="text-muted">Add API keys for services like Google Places, LLM, and more</p>
                    </div>

                    <!-- API Keys Table -->
                    <div x-show="!loading && apiKeys.length > 0">
                        <table class="table striped border">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Service Type</th>
                                    <th>API Key</th>
                                    <th>Description</th>
                                    <th>Last Updated</th>
                                    <th class="text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="apiKey in apiKeys" :key="apiKey.id">
                                    <tr>
                                        <td><strong x-text="apiKey.name"></strong></td>
                                        <td>
                                            <span class="label label-secondary" x-text="(apiKey.service_type || 'unknown').toUpperCase()"></span>
                                        </td>
                                        <td>
                                            <div class="input-group">
                                                <code class="form-input" x-text="getMaskedApiKey(apiKey)" style="flex: 1;"></code>
                                                <button type="button" class="btn btn-sm" @click="toggleApiKeyVisibility(apiKey.id)" :title="getShowFull(apiKey.id) ? 'Hide' : 'Show'">
                                                    <i class="fas" :class="getShowFull(apiKey.id) ? 'fa-eye-slash' : 'fa-eye'"></i>
                                                </button>
                                            </div>
                                        </td>
                                        <td x-text="getDescription(apiKey)"></td>
                                        <td x-text="formatDate(apiKey.updated_at)"> </td>
                                        <td class="text-right">
                                            <button class="btn btn-sm btn-primary mr-1" @click="editApiKey(apiKey)" title="Edit API Key">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-error" @click="deleteApiKey(apiKey.id, apiKey.name)" :disabled="deleting === apiKey.id" title="Delete API Key">
                                                <i class="fas" :class="deleting === apiKey.id ? 'fa-spinner fa-pulse' : 'fa-trash'"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Create/Edit API Key Modal -->
            <div class="modal" :class="showCreateModal || showEditModal ? 'active' : ''">
                <a href="#" class="modal-overlay" @click="closeModals"></a>
                <div class="modal-container">
                    <div class="modal-header">
                        <a href="#" class="btn btn-clear float-right" @click="closeModals"></a>
                        <div class="modal-title" x-text="showEditModal ? 'Edit API Key' : 'Add API Key'"></div>
                    </div>
                    <div class="modal-body">
                        <div class="content">
                            <form @submit.prevent="submitApiKey">
                                <div class="form-group">
                                    <label class="form-label" for="name">Name *</label>
                                    <input class="form-input" type="text" id="name" x-model="formData.name" placeholder="e.g., google-places-key" required>
                                    <p class="form-input-hint">Used to reference this API key in job definitions</p>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="serviceType">Service Type *</label>
                                    <select class="form-input" id="serviceType" x-model="formData.serviceType" required>
                                        <option value="">Select a service type...</option>
                                        <option value="gemini-llm">gemini-llm</option>
                                        <option value="gemini-agent">gemini-agent</option>
                                        <option value="google-places">google-places</option>
                                        <option value="other">other</option>
                                    </select>
                                    <p class="form-input-hint">Identifier for the service</p>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="apiKey">API Key *</label>
                                    <div class="input-group">
                                        <input class="form-input" :type="showPassword ? 'text' : 'password'" id="apiKey" x-model="formData.apiKey" placeholder="Enter API key value" required>
                                        <button type="button" class="btn btn-sm" @click="showPassword = !showPassword" :title="showPassword ? 'Hide' : 'Show'">
                                            <i class="fas" :class="showPassword ? 'fa-eye-slash' : 'fa-eye'"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="description">Description</label>
                                    <textarea class="form-input" id="description" x-model="formData.description" rows="3" placeholder="Optional description of this API key"></textarea>
                                </div>

                                <div class="form-actions">
                                    <button type="button" class="btn" @click="closeModals">Cancel</button>
                                    <button type="submit" class="btn btn-primary" :disabled="saving">
                                        <span x-show="saving"><i class="fas fa-spinner fa-pulse mr-1"></i>Saving...</span>
                                        <span x-show="!saving" x-text="showEditModal ? 'Update' : 'Create'"></span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Service Logs Section -->
        <section style="margin-top: 1.5rem;">
            {{template "service-logs.html" .}}
        </section>

    </main>

    {{template "footer.html" .}}

    {{template "snackbar.html" .}}

    <script>
        // Alpine.js component for authentication page
        function authPage() {
            return {
                authentications: [],
                loading: true,
                deleting: null,

                init() {
                    this.loadAuthentications();
                },

                async loadAuthentications() {
                    this.loading = true;
                    try {
                        const response = await fetch('/api/auth/list');
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();
                        // Filter to only show non-API key credentials
                        this.authentications = Array.isArray(data) ? data.filter(auth => auth.auth_type !== 'api_key') : [];
                    } catch (error) {
                        console.error('Failed to load authentications:', error);
                        window.showNotification('Failed to load authentications', 'error');
                    } finally {
                        this.loading = false;
                    }
                },

                async deleteAuthentication(id, siteDomain) {
                    if (!confirm(`Are you sure you want to delete authentication for ${siteDomain}?\n\nAny sources using this authentication will need to be updated.`)) {
                        return;
                    }

                    this.deleting = id;
                    try {
                        const response = await fetch(`/api/auth/${id}`, {
                            method: 'DELETE'
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        // Remove from local array
                        this.authentications = this.authentications.filter(auth => auth.id !== id);
                        window.showNotification('Authentication deleted successfully', 'success');
                    } catch (error) {
                        console.error('Failed to delete authentication:', error);
                        window.showNotification('Failed to delete authentication', 'error');
                    } finally {
                        this.deleting = null;
                    }
                },

                formatDate(timestamp) {
                    if (!timestamp) return '-';

                    let date;
                    try {
                        // Handle different timestamp formats
                        if (typeof timestamp === 'string') {
                            // ISO string or other string format
                            date = new Date(timestamp);
                        } else if (typeof timestamp === 'number') {
                            // Determine if timestamp is in seconds or milliseconds
                            // Timestamps in seconds are typically < 10^11 (year 5138)
                            // Timestamps in milliseconds are typically >= 10^11
                            if (timestamp < 10000000000) {
                                // Assume seconds, multiply by 1000
                                date = new Date(timestamp * 1000);
                            } else {
                                // Assume milliseconds
                                date = new Date(timestamp);
                            }
                        } else {
                            return '-';
                        }

                        // Check if date is valid
                        if (isNaN(date.getTime())) return '-';

                        const now = new Date();
                        const diffMs = now - date;
                        const diffMins = Math.floor(diffMs / 60000);
                        const diffHours = Math.floor(diffMs / 3600000);
                        const diffDays = Math.floor(diffMs / 86400000);

                        if (diffMins < 1) return 'Just now';
                        if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
                        if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
                        if (diffDays < 7) return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;

                        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                    } catch (error) {
                        console.error('Error formatting date:', error);
                        return '-';
                    }
                }
            }
        }

        // Alpine.js component for API keys page
        function apiKeysPage() {
            return {
                apiKeys: [],
                loading: true,
                deleting: null,
                saving: false,
                showPassword: false,
                showCreateModal: false,
                showEditModal: false,
                editingId: null,
                showFullById: {},  // Track show/hide state per API key
                formData: {
                    name: '',
                    apiKey: '',
                    serviceType: '',
                    description: ''
                },

                init() {
                    this.loadApiKeys();
                },

                async loadApiKeys() {
                    this.loading = true;
                    try {
                        const response = await fetch('/api/auth/list');
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();
                        // Filter to only show API key credentials
                        this.apiKeys = Array.isArray(data) ? data.filter(auth => auth.auth_type === 'api_key') : [];
                    } catch (error) {
                        console.error('Failed to load API keys:', error);
                        window.showNotification('Failed to load API keys', 'error');
                    } finally {
                        this.loading = false;
                    }
                },

                async deleteApiKey(id, name) {
                    if (!confirm(`Are you sure you want to delete API key "${name}"?\n\nAny job definitions using this API key will fail.`)) {
                        return;
                    }

                    this.deleting = id;
                    try {
                        const response = await fetch(`/api/auth/api-key/${id}`, {
                            method: 'DELETE'
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        // Remove from local array
                        this.apiKeys = this.apiKeys.filter(key => key.id !== id);
                        window.showNotification('API key deleted successfully', 'success');
                    } catch (error) {
                        console.error('Failed to delete API key:', error);
                        window.showNotification('Failed to delete API key', 'error');
                    } finally {
                        this.deleting = null;
                    }
                },

                editApiKey(apiKey) {
                    this.editingId = apiKey.id;
                    this.formData = {
                        name: apiKey.name,
                        apiKey: '', // Don't prefill for security
                        serviceType: apiKey.service_type,
                        description: this.getDescription(apiKey)
                    };
                    this.showEditModal = true;
                },

                async submitApiKey() {
                    this.saving = true;
                    try {
                        const isEdit = this.showEditModal;
                        const url = isEdit ? `/api/auth/api-key/${this.editingId}` : '/api/auth/api-key';
                        const method = isEdit ? 'PUT' : 'POST';

                        // Prepare request body
                        const body = {
                            name: this.formData.name,
                            service_type: this.formData.serviceType,
                            description: this.formData.description
                        };

                        // Only include API key if provided (for create or update)
                        if (this.formData.apiKey) {
                            body.api_key = this.formData.apiKey;
                        }

                        const response = await fetch(url, {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(body)
                        });

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                        }

                        // Reload API keys from server
                        await this.loadApiKeys();
                        this.closeModals();

                        window.showNotification(
                            `API key ${isEdit ? 'updated' : 'created'} successfully`,
                            'success'
                        );
                    } catch (error) {
                        console.error('Failed to save API key:', error);
                        window.showNotification(
                            error.message || `Failed to ${this.showEditModal ? 'update' : 'create'} API key`,
                            'error'
                        );
                    } finally {
                        this.saving = false;
                    }
                },

                closeModals() {
                    this.showCreateModal = false;
                    this.showEditModal = false;
                    this.editingId = null;
                    this.formData = {
                        name: '',
                        apiKey: '',
                        serviceType: '',
                        description: ''
                    };
                    this.showPassword = false;  // Reset password visibility
                },

                getDescription(apiKey) {
                    // Try to get description from data object
                    if (apiKey.data && apiKey.data.description) {
                        return apiKey.data.description;
                    }
                    return '-';
                },

                toggleApiKeyVisibility(id) {
                    this.showFullById[id] = !this.showFullById[id];
                },

                getShowFull(id) {
                    return this.showFullById[id] || false;
                },

                getMaskedApiKey(apiKey) {
                    // If show full is enabled for this key, show the masked string
                    // Otherwise show fully masked version
                    const isShown = this.getShowFull(apiKey.id);
                    const maskedString = apiKey.api_key || '***MASKED***';

                    if (!isShown) {
                        // Fully masked - don't reveal pattern
                        return '••••••••';
                    }

                    // Use the masked string from server (first-4 + last-4)
                    return maskedString;
                },

                formatDate(timestamp) {
                    if (!timestamp) return '-';

                    let date;
                    try {
                        // Handle different timestamp formats
                        if (typeof timestamp === 'string') {
                            // ISO string or other string format
                            date = new Date(timestamp);
                        } else if (typeof timestamp === 'number') {
                            // Determine if timestamp is in seconds or milliseconds
                            // Timestamps in seconds are typically < 10^11 (year 5138)
                            // Timestamps in milliseconds are typically >= 10^11
                            if (timestamp < 10000000000) {
                                // Assume seconds, multiply by 1000
                                date = new Date(timestamp * 1000);
                            } else {
                                // Assume milliseconds
                                date = new Date(timestamp);
                            }
                        } else {
                            return '-';
                        }

                        // Check if date is valid
                        if (isNaN(date.getTime())) return '-';

                        const now = new Date();
                        const diffMs = now - date;
                        const diffMins = Math.floor(diffMs / 60000);
                        const diffHours = Math.floor(diffMs / 3600000);
                        const diffDays = Math.floor(diffMs / 86400000);

                        if (diffMins < 1) return 'Just now';
                        if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
                        if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
                        if (diffDays < 7) return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;

                        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                    } catch (error) {
                        console.error('Error formatting date:', error);
                        return '-';
                    }
                }
            }
        }

        // Page initialization
        document.addEventListener('DOMContentLoaded', function () {
            console.log('[Auth] ==================== PAGE LOAD ====================');
            console.log('[Auth] DOMContentLoaded event fired');
            console.log('[Auth] Current URL:', window.location.href);
            console.log('[Auth] Initializing page components...');

            console.log('[Auth] Page initialization complete');
            console.log('[Auth] ====================================================');
        });

        // Ensure Alpine.js is fully initialized
        document.addEventListener('alpine:init', function () {
            console.log('[Auth] Alpine.js initialized');
        });
    </script>
</body>

</html>