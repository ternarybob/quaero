<!DOCTYPE html>
<html lang="en">

<head>
  {{template "head.html" .}}
  <title>Quaero - Authentication Management</title>
</head>

<body class="has-navbar-fixed-top">
  <div class="wrapper">
    {{template "navbar.html" .}}

    <!-- Hero Section -->
    <section class="hero">
      <div class="hero-body">
        <div class="container">
          <h1 class="title">Authentication Management</h1>
          <p class="subtitle">Manage authentication credentials for data sources</p>
        </div>
      </div>
    </section>

    <!-- Main Content -->
    <section class="section">
      <div class="container">

        <!-- Instructions Card -->
        <div class="card mb-5">
          <header class="card-header">
            <p class="card-header-title">
              <span class="icon"><i class="fas fa-info-circle"></i></span>
              <span>How to Add Authentication</span>
            </p>
          </header>
          <div class="card-content">
            <div class="content">
              <ol>
                <li>Navigate to your Atlassian site (Jira or Confluence) in Chrome</li>
                <li>Log in to your account</li>
                <li>Click the Quaero Chrome extension icon</li>
                <li>The extension will automatically capture and store your authentication</li>
                <li>Authentication for the same site will be automatically updated when recaptured</li>
              </ol>
              <div class="notification is-info is-light mt-4">
                <strong>Note:</strong> Each site domain can have only one set of credentials.
                Capturing new authentication for an existing site will override the previous credentials.
              </div>
            </div>
          </div>
        </div>

        <!-- Authentication List -->
        <div class="card" x-data="authPage()">
          <header class="card-header">
            <p class="card-header-title">
              <span class="icon"><i class="fas fa-key"></i></span>
              <span>Stored Authentications</span>
            </p>
            <div class="card-header-icon">
              <button class="button is-small is-outlined" @click="loadAuthentications" title="Refresh Authentications">
                <span class="icon"><i class="fa-solid fa-rotate-right"></i></span>
              </button>
            </div>
          </header>
          <div class="card-content">
            <!-- Loading State -->
            <div x-show="loading" class="has-text-centered p-5">
              <span class="icon is-large">
                <i class="fas fa-spinner fa-pulse fa-2x"></i>
              </span>
              <p class="mt-3">Loading authentications...</p>
            </div>

            <!-- Empty State -->
            <div x-show="!loading && authentications.length === 0" class="has-text-centered p-5">
              <span class="icon is-large has-text-grey-light">
                <i class="fas fa-lock fa-3x"></i>
              </span>
              <p class="mt-3 has-text-grey">No authentication credentials stored</p>
              <p class="has-text-grey-light">Use the Chrome extension to capture authentication from your sites</p>
            </div>

            <!-- Authentication Table -->
            <div x-show="!loading && authentications.length > 0">
              <table class="table is-fullwidth is-hoverable">
                <thead>
                  <tr>
                    <th>Site</th>
                    <th>Name</th>
                    <th>Service Type</th>
                    <th>Last Updated</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="auth in authentications" :key="auth.id">
                    <tr>
                      <td>
                        <strong x-text="auth.site_domain"></strong>
                        <br>
                        <small class="has-text-grey" x-text="auth.base_url"></small>
                      </td>
                      <td x-text="auth.name || '-'"></td>
                      <td>
                        <span class="tag is-primary" x-text="auth.service_type.toUpperCase()"></span>
                      </td>
                      <td>
                        <small x-text="formatDate(auth.updated_at)"></small>
                      </td>
                      <td>
                        <div class="buttons are-small">
                          <button class="button is-small is-danger is-outlined"
                                  @click="deleteAuthentication(auth.id, auth.site_domain)"
                                  :disabled="deleting === auth.id"
                                  title="Delete Authentication">
                            <span class="icon">
                              <i class="fas" :class="deleting === auth.id ? 'fa-spinner fa-pulse' : 'fa-trash'"></i>
                            </span>
                          </button>
                        </div>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Associated Sources Information -->
        <div class="card mt-5">
          <header class="card-header">
            <p class="card-header-title">
              <span class="icon"><i class="fas fa-link"></i></span>
              <span>Using Authentication in Sources</span>
            </p>
          </header>
          <div class="card-content">
            <div class="content">
              <p>
                Once you have captured authentication for a site, you can create sources that use these credentials:
              </p>
              <ul>
                <li><strong>Jira Source:</strong> Create a source with URL like <code>https://yoursite.atlassian.net/jira</code></li>
                <li><strong>Confluence Source:</strong> Create a source with URL like <code>https://yoursite.atlassian.net/wiki</code></li>
              </ul>
              <p>
                Sources will automatically use the authentication credentials matching their site domain.
              </p>
              <a href="/sources" class="button is-info">
                <span class="icon"><i class="fas fa-database"></i></span>
                <span>Manage Sources</span>
              </a>
            </div>
          </div>
        </div>

      </div>
    </section>
  </div>

  {{template "footer.html" .}}
  {{template "snackbar.html" .}}

  <script>
    function authPage() {
      return {
        authentications: [],
        loading: true,
        deleting: null,

        init() {
          this.loadAuthentications();
        },

        async loadAuthentications() {
          this.loading = true;
          try {
            const response = await fetch('/api/auth/list');
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            this.authentications = Array.isArray(data) ? data : [];
          } catch (error) {
            console.error('Failed to load authentications:', error);
            window.showSnackbar('Failed to load authentications', 'error');
          } finally {
            this.loading = false;
          }
        },

        async deleteAuthentication(id, siteDomain) {
          if (!confirm(`Are you sure you want to delete authentication for ${siteDomain}?\n\nAny sources using this authentication will need to be updated.`)) {
            return;
          }

          this.deleting = id;
          try {
            const response = await fetch(`/api/auth/${id}`, {
              method: 'DELETE'
            });

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            // Remove from local array
            this.authentications = this.authentications.filter(auth => auth.id !== id);
            window.showSnackbar('Authentication deleted successfully', 'success');
          } catch (error) {
            console.error('Failed to delete authentication:', error);
            window.showSnackbar('Failed to delete authentication', 'error');
          } finally {
            this.deleting = null;
          }
        },

        formatDate(timestamp) {
          if (!timestamp) return '-';
          const date = new Date(timestamp * 1000);
          const now = new Date();
          const diffMs = now - date;
          const diffMins = Math.floor(diffMs / 60000);
          const diffHours = Math.floor(diffMs / 3600000);
          const diffDays = Math.floor(diffMs / 86400000);

          if (diffMins < 1) return 'Just now';
          if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
          if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
          if (diffDays < 7) return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;

          return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }
      }
    }
  </script>

</body>

</html>