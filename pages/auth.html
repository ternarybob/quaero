<!DOCTYPE html>
<html lang="en">

<head>
    {{template "head.html" .}}
    <title>Quaero - Authentication Management</title>
</head>

<body>

    {{template "navbar.html" .}}

    <main class="page-container">

        <!-- Page Title -->
        <div class="page-title">
            <h1>Authentication Management</h1>
            <p>Manage authentication credentials for data sources</p>
        </div>

        <!-- Instructions Card -->
        <section>
            <div class="card">
                <div class="card-header">
                    <h2>How to Add Authentication</h2>
                </div>
                <div class="card-body">
                        <ol>
                            <li>Navigate to your Atlassian site (Jira or Confluence) in Chrome</li>
                            <li>Log in to your account</li>
                            <li>Click the Quaero Chrome extension icon</li>
                            <li>The extension will automatically capture and store your authentication</li>
                            <li>Authentication for the same site will be automatically updated when recaptured</li>
                        </ol>
                        <div class="toast toast-primary" style="margin-top: 1rem;">
                            <strong>Note:</strong> Each site domain can have only one set of credentials.
                            Capturing new authentication for an existing site will override the previous credentials.
                        </div>
                    </div>
                </div>
        </section>

        <!-- Authentication List -->
        <section style="margin-top: 1.5rem;" x-data="authPage()">
            <div class="card">
                <div class="card-header">
                    <header class="navbar">
                        <section class="navbar-section">
                            <h2>Stored Authentications</h2>
                        </section>
                        <section class="navbar-section">
                            <button class="btn btn-sm" @click="loadAuthentications" title="Refresh Authentications">
                                <i class="fa-solid fa-rotate-right"></i>
                            </button>
                        </section>
                    </header>
                </div>
                <div class="card-body">
                        <!-- Loading State -->
                        <div x-show="loading" class="text-center p-5">
                            <span class="icon">
                                <i class="fas fa-spinner fa-pulse fa-2x"></i>
                            </span>
                            <p class="mt-3">Loading authentications...</p>
                        </div>

                        <!-- Empty State -->
                        <div x-show="!loading && authentications.length === 0" class="text-center p-5">
                            <span class="icon text-muted">
                                <i class="fas fa-lock fa-3x"></i>
                            </span>
                            <p class="mt-3 text-muted">No authentication credentials stored</p>
                            <p class="text-muted">Use the Chrome extension to capture authentication from your sites</p>
                        </div>

                        <!-- Authentication Table -->
                        <div x-show="!loading && authentications.length > 0">
                            <table class="table striped border">
                                <thead>
                                    <tr>
                                        <th>Site</th>
                                        <th>Name</th>
                                        <th>Service Type</th>
                                        <th>Last Updated</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="auth in authentications" :key="auth.id">
                                        <tr>
                                            <td>
                                                <strong x-text="auth.site_domain"></strong>
                                                <br>
                                                <small class="text-muted" x-text="auth.base_url"></small>
                                            </td>
                                            <td x-text="auth.name || '-'"></td>
                                            <td>
                                                <span class="label label-primary" x-text="auth.service_type.toUpperCase()"></span>
                                            </td>
                                            <td>
                                                <small x-text="formatDate(auth.updated_at)"></small>
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-error" @click="deleteAuthentication(auth.id, auth.site_domain)" :disabled="deleting === auth.id" title="Delete Authentication">
                                                    <i class="fas" :class="deleting === auth.id ? 'fa-spinner fa-pulse' : 'fa-trash'"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
        </section>

        <!-- Associated Sources Information -->
        <section style="margin-top: 1.5rem;">
            <div class="card">
                <div class="card-header">
                    <h2>Using Authentication in Sources</h2>
                </div>
                <div class="card-body">
                        <p>
                            Once you have captured authentication for a site, you can create sources that use these credentials:
                        </p>
                        <ul>
                            <li><strong>Jira Source:</strong> Create a source with URL like <code>https://yoursite.atlassian.net/jira</code></li>
                            <li><strong>Confluence Source:</strong> Create a source with URL like <code>https://yoursite.atlassian.net/wiki</code></li>
                        </ul>
                        <p>
                            Sources will automatically use the authentication credentials matching their site domain.
                        </p>
                        <a href="/sources" class="btn btn-sm">
                            <i class="fas fa-database"></i>
                            <span>Manage Sources</span>
                        </a>
                    </div>
                </div>
            </div>
        </section>

    </main>

    {{template "footer.html" .}}

    {{template "snackbar.html" .}}

    <script>
        function authPage() {
            return {
                authentications: [],
                loading: true,
                deleting: null,

                init() {
                    this.loadAuthentications();
                },

                async loadAuthentications() {
                    this.loading = true;
                    try {
                        const response = await fetch('/api/auth/list');
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();
                        this.authentications = Array.isArray(data) ? data : [];
                    } catch (error) {
                        console.error('Failed to load authentications:', error);
                        window.showNotification('Failed to load authentications', 'error');
                    } finally {
                        this.loading = false;
                    }
                },

                async deleteAuthentication(id, siteDomain) {
                    if (!confirm(`Are you sure you want to delete authentication for ${siteDomain}?\n\nAny sources using this authentication will need to be updated.`)) {
                        return;
                    }

                    this.deleting = id;
                    try {
                        const response = await fetch(`/api/auth/${id}`, {
                            method: 'DELETE'
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        // Remove from local array
                        this.authentications = this.authentications.filter(auth => auth.id !== id);
                        window.showNotification('Authentication deleted successfully', 'success');
                    } catch (error) {
                        console.error('Failed to delete authentication:', error);
                        window.showNotification('Failed to delete authentication', 'error');
                    } finally {
                        this.deleting = null;
                    }
                },

                formatDate(timestamp) {
                    if (!timestamp) return '-';
                    const date = new Date(timestamp * 1000);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMs / 3600000);
                    const diffDays = Math.floor(diffMs / 86400000);

                    if (diffMins < 1) return 'Just now';
                    if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
                    if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
                    if (diffDays < 7) return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;

                    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                }
            }
        }
    </script>

</body>

</html>