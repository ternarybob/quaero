<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - Quaero</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/beercss@3.7.10/dist/cdn/beer.min.css">
    <script type="module" src="https://cdn.jsdelivr.net/npm/beercss@3.7.10/dist/cdn/beer.min.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    
    <!-- Quaero Theme -->
    <link rel="stylesheet" href="/static/common.css">

    <style>
        /* Force navbar title styling */
        nav.top a:first-child {
            display: flex !important;
            flex-direction: column !important;
        }
    </style>
    
    <script>
        // Ensure navbar styling is applied after BeerCSS loads
        document.addEventListener('DOMContentLoaded', function() {
            const navTitle = document.querySelector('nav.top a:first-child');
            if (navTitle) {
                navTitle.style.display = 'flex';
                navTitle.style.flexDirection = 'column';
            }
        });
    </script>
</head>
<body class="light">

{{template "navbar" .}}
{{template "snackbar" .}}

<main class="responsive" style="padding: 1rem;">
    {{template "service-status" .}}
    
    <article>
        <h5 style="margin: 0 0 1rem 0; font-size: 1.2rem;">Chat</h5>

        <!-- Chat Container -->
        <div class="border" style="height: 60vh; overflow-y: auto; padding: 1rem; margin-bottom: 1rem; background: #1a1a1a;">
            <div id="chat-messages"></div>
        </div>

        <!-- Message Input -->
        <div class="field border" style="margin-bottom: 1rem;">
            <textarea id="user-message" rows="3" placeholder="Type your message..." style="background: #1a1a1a; color: #e0e0e0; border: none; width: 100%;"></textarea>
        </div>

        <!-- Controls -->
        <div class="row">
            <div class="max">
                <label class="checkbox">
                    <input type="checkbox" id="rag-enabled">
                    <span>Enable RAG (Document Retrieval) - Requires embedding support</span>
                </label>
            </div>
            <button id="send-btn" class="border" style="background: #1a1a1a; color: #ffffff;">
                <i>send</i>
                <span>Send</span>
            </button>
            <button id="clear-btn" class="border" style="background: #1a1a1a; color: #ffffff;">
                <i>delete</i>
                <span>Clear</span>
            </button>
        </div>

        <!-- Status -->
        <div id="status" style="margin-top: 1rem; font-size: 0.9rem; color: #888;"></div>
    </article>
</main>

<script>
// Status update functionality
function updateSystemStatus(online) {
    const statusIndicator = document.querySelector('.status-indicator');
    const statusText = document.querySelector('.status-text');

    if (online) {
        statusIndicator.style.background = '#00cc00';
        statusText.style.color = '#00cc00';
        statusText.textContent = 'ONLINE';
    } else {
        statusIndicator.style.background = '#cc0000';
        statusText.style.color = '#cc0000';
        statusText.textContent = 'OFFLINE';
    }
}

// WebSocket connection for system status
let ws;
let reconnectInterval;

function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws`;

    ws = new WebSocket(wsUrl);

    ws.onopen = function() {
        console.log('WebSocket connected');
        updateSystemStatus(true);
        if (reconnectInterval) {
            clearInterval(reconnectInterval);
            reconnectInterval = null;
        }
    };

    ws.onerror = function(error) {
        console.error('WebSocket error:', error);
        updateSystemStatus(false);
    };

    ws.onclose = function() {
        console.log('WebSocket disconnected');
        updateSystemStatus(false);

        // Reconnect after 3 seconds
        if (!reconnectInterval) {
            reconnectInterval = setInterval(function() {
                connectWebSocket();
            }, 3000);
        }
    };
}

// Chat functionality
const chatMessages = document.getElementById('chat-messages');
const userMessageInput = document.getElementById('user-message');
const sendBtn = document.getElementById('send-btn');
const clearBtn = document.getElementById('clear-btn');
const ragEnabled = document.getElementById('rag-enabled');
const statusDiv = document.getElementById('status');

let conversationHistory = [];

// Add message to chat
function addMessage(role, content) {
    const messageDiv = document.createElement('div');
    messageDiv.style.marginBottom = '1rem';
    messageDiv.style.padding = '0.5rem';
    messageDiv.style.borderLeft = role === 'user' ? '3px solid #4a90e2' : '3px solid #888';
    messageDiv.style.background = role === 'user' ? '#2a2a2a' : '#1a1a1a';

    const roleSpan = document.createElement('strong');
    roleSpan.textContent = role === 'user' ? 'You: ' : 'Assistant: ';
    roleSpan.style.color = role === 'user' ? '#4a90e2' : '#888';

    const contentSpan = document.createElement('span');
    contentSpan.textContent = content;
    contentSpan.style.whiteSpace = 'pre-wrap';

    messageDiv.appendChild(roleSpan);
    messageDiv.appendChild(contentSpan);
    chatMessages.appendChild(messageDiv);

    // Scroll to bottom
    chatMessages.parentElement.scrollTop = chatMessages.parentElement.scrollHeight;
}

// Send message
async function sendMessage() {
    const message = userMessageInput.value.trim();
    if (!message) {
        showNotification('Please enter a message', 'error');
        return;
    }

    // Add user message to chat
    addMessage('user', message);
    conversationHistory.push({ role: 'user', content: message });

    // Clear input
    userMessageInput.value = '';

    // Disable send button
    sendBtn.disabled = true;
    statusDiv.textContent = 'Thinking...';

    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: message,
                history: conversationHistory.slice(0, -1), // Don't include the current message
                rag_config: {
                    enabled: ragEnabled.checked,
                    max_documents: 5,
                    min_similarity: 0.7,
                    search_mode: 'vector'
                }
            })
        });

        const data = await response.json();

        if (data.success) {
            // Add assistant response
            addMessage('assistant', data.message);
            conversationHistory.push({ role: 'assistant', content: data.message });

            // Update status
            const contextDocs = data.context_docs ? data.context_docs.length : 0;
            statusDiv.textContent = `Mode: ${data.mode} | Model: ${data.model} | Context docs: ${contextDocs}`;
        } else {
            showNotification('Error: ' + data.error, 'error');
            statusDiv.textContent = 'Error occurred';
        }
    } catch (error) {
        showNotification('Failed to send message: ' + error.message, 'error');
        statusDiv.textContent = 'Connection error';
    } finally {
        sendBtn.disabled = false;
    }
}

// Clear chat
function clearChat() {
    chatMessages.innerHTML = '';
    conversationHistory = [];
    statusDiv.textContent = '';
    showNotification('Chat cleared', 'info');
}

// Event listeners
sendBtn.addEventListener('click', sendMessage);
clearBtn.addEventListener('click', clearChat);

userMessageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// Connect WebSocket for status updates
connectWebSocket();

// Check service health on load
fetch('/api/chat/health')
    .then(r => r.json())
    .then(data => {
        if (data.healthy) {
            statusDiv.textContent = `Chat service ready (${data.mode} mode)`;
        } else {
            showNotification('Chat service unhealthy: ' + data.error, 'error');
            statusDiv.textContent = 'Service unavailable';
        }
    })
    .catch(err => {
        showNotification('Failed to check service health', 'error');
        statusDiv.textContent = 'Connection error';
    });
</script>

{{template "footer" .}}

</body>
</html>
