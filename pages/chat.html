<!DOCTYPE html>
<html lang="en">
<head>
    {{template "head.html" .}}
    <title>Chat - Quaero</title>
</head>
<body class="has-navbar-fixed-top">
    <div class="wrapper">
        {{template "navbar.html" .}}

        <!-- Hero Section -->
        <section class="hero">
            <div class="hero-body">
                <div class="container">
                    <h1 class="title">Chat</h1>
                    <p class="subtitle">AI-powered conversational interface with RAG document retrieval</p>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="container">
                <div class="card mt-5">
                    <header class="card-header">
                        <p class="card-header-title">
                            <span class="icon"><i class="fas fa-comments"></i></span>
                            <span>Chat</span>
                        </p>
                    </header>
                    <div class="card-content">
                        <!-- Chat Container -->
                        <div class="box" style="height: 60vh; overflow-y: auto; padding: 1rem; margin-bottom: 1rem; background: #1a1a1a;">
                            <div id="chat-messages"></div>
                        </div>

                        <!-- Message Input -->
                        <div class="field">
                            <div class="control">
                                <textarea id="user-message" class="textarea" rows="3" placeholder="Type your message..."></textarea>
                            </div>
                        </div>

                        <!-- Controls -->
                        <div class="field is-grouped">
                            <div class="control is-expanded">
                                <label class="checkbox">
                                    <input type="checkbox" id="rag-enabled" checked>
                                    Enable RAG (Document Retrieval) - Requires embedding support
                                </label>
                            </div>
                            <div class="control">
                                <button id="send-btn" class="button is-primary is-small is-outlined">
                                    <span class="icon"><i class="fas fa-paper-plane"></i></span>
                                    <span>Send</span>
                                </button>
                            </div>
                            <div class="control">
                                <button id="clear-btn" class="button is-danger is-small is-outlined">
                                    <span class="icon"><i class="fas fa-trash"></i></span>
                                    <span>Clear</span>
                                </button>
                            </div>
                        </div>

                        <!-- Status -->
                        <div class="mt-3">
                            <div id="status" class="has-text-grey mb-2"></div>
                            <div id="live-status" class="has-text-grey-light is-size-7">
                                <span class="icon-text">
                                    <span class="icon"><i class="fas fa-circle-notch fa-spin"></i></span>
                                    <span>Checking service status...</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                {{template "service-logs.html" .}}
            </div>
        </section>
    </div>

    {{template "footer.html" .}}

    {{template "snackbar.html" .}}

    <script>
// Chat functionality
const chatMessages = document.getElementById('chat-messages');
const userMessageInput = document.getElementById('user-message');
const sendBtn = document.getElementById('send-btn');
const clearBtn = document.getElementById('clear-btn');
const ragEnabled = document.getElementById('rag-enabled');
const statusDiv = document.getElementById('status');

let conversationHistory = [];

// Add message to chat
function addMessage(role, content) {
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message-block', role === 'user' ? 'is-user' : 'is-assistant');

    const roleSpan = document.createElement('strong');
    roleSpan.textContent = role === 'user' ? 'You: ' : 'Assistant: ';
    roleSpan.style.color = '#ffffff';

    const contentSpan = document.createElement('span');
    contentSpan.textContent = content;
    contentSpan.style.whiteSpace = 'pre-wrap';
    contentSpan.style.color = '#e0e0e0';

    messageDiv.appendChild(roleSpan);
    messageDiv.appendChild(contentSpan);
    chatMessages.appendChild(messageDiv);

    // Scroll to bottom
    chatMessages.parentElement.scrollTop = chatMessages.parentElement.scrollHeight;
}

// Add technical metadata section
function addTechnicalMetadata(metadata) {
    const metadataDiv = document.createElement('div');
    metadataDiv.classList.add('technical-metadata', 'box', 'is-size-7', 'has-background-dark', 'mt-2');
    metadataDiv.style.borderLeft = '3px solid #48c78e';
    metadataDiv.style.padding = '0.5rem 0.75rem';

    let html = '<strong style="color: #48c78e;">‚öô Technical Details</strong><br>';

    if (metadata.thinking_time) {
        html += `<span style="color: #b5b5b5;">‚è± Thinking time: ${metadata.thinking_time}</span><br>`;
    }

    if (metadata.document_count !== undefined) {
        html += `<span style="color: #b5b5b5;">üìÑ Documents used: ${metadata.document_count}</span><br>`;
    }

    if (metadata.references && metadata.references.length > 0) {
        html += '<span style="color: #b5b5b5;">üìö References:</span><br>';
        metadata.references.forEach((ref, idx) => {
            html += `<span style="color: #a0a0a0; margin-left: 1rem;">${idx + 1}. ${ref}</span><br>`;
        });
    }

    if (metadata.rag_enabled !== undefined) {
        const ragStatus = metadata.rag_enabled ? 'enabled' : 'disabled';
        const ragColor = metadata.rag_enabled ? '#48c78e' : '#f14668';
        html += `<span style="color: ${ragColor};">üîç RAG: ${ragStatus}</span>`;
    }

    metadataDiv.innerHTML = html;
    chatMessages.appendChild(metadataDiv);

    // Scroll to bottom
    chatMessages.parentElement.scrollTop = chatMessages.parentElement.scrollHeight;
}

// Add status message to chat window with scrolling bold animation
function addStatusMessage(message) {
    const statusMsg = document.createElement('div');
    statusMsg.classList.add('message-block', 'is-status');
    statusMsg.style.fontStyle = 'italic';
    statusMsg.style.color = '#a0a0a0';
    statusMsg.style.padding = '0.5rem';

    // Create container for animated text
    const textContainer = document.createElement('span');
    statusMsg.appendChild(textContainer);

    chatMessages.appendChild(statusMsg);

    // Scroll to bottom
    chatMessages.parentElement.scrollTop = chatMessages.parentElement.scrollHeight;

    // Text and dot patterns
    const text = 'Thinking';
    const dotPatterns = ['.', '..', '...', '....', '...', '..'];
    let boldIndex = 0; // Which letter is bold
    let dotIndex = 0;   // Which dot pattern

    // Function to render the text with one letter bold
    function renderText() {
        textContainer.innerHTML = '';

        // Render each letter, making one bold
        for (let i = 0; i < text.length; i++) {
            const letterSpan = document.createElement('span');
            letterSpan.textContent = text[i];
            if (i === boldIndex) {
                letterSpan.style.fontWeight = 'bold';
            }
            textContainer.appendChild(letterSpan);
        }

        // Add dots
        const dotsSpan = document.createElement('span');
        dotsSpan.textContent = dotPatterns[dotIndex];
        textContainer.appendChild(dotsSpan);
    }

    // Initial render
    renderText();

    // Animate: scroll bold through letters and cycle dots
    statusMsg.animationInterval = setInterval(() => {
        // Move bold to next letter
        boldIndex = (boldIndex + 1) % text.length;

        // Update dots every full cycle through the text
        if (boldIndex === 0) {
            dotIndex = (dotIndex + 1) % dotPatterns.length;
        }

        renderText();
    }, 200); // Update every 200ms for smooth scrolling

    return statusMsg;
}

// Remove status message from chat window
function removeStatusMessage(statusMsg) {
    if (statusMsg) {
        // Clear animation interval
        if (statusMsg.animationInterval) {
            clearInterval(statusMsg.animationInterval);
        }

        // Remove from DOM
        if (statusMsg.parentNode) {
            statusMsg.parentNode.removeChild(statusMsg);
        }
    }
}

// Send message
async function sendMessage() {
    const message = userMessageInput.value.trim();
    if (!message) {
        showNotification('Please enter a message', 'error');
        return;
    }

    // Add user message to chat
    addMessage('user', message);
    conversationHistory.push({ role: 'user', content: message });

    // Clear input
    userMessageInput.value = '';

    // Disable send button and show thinking status in chat
    sendBtn.disabled = true;
    const thinkingMsg = addStatusMessage('Thinking...');

    try {
        const requestBody = {
            message: message,
            history: conversationHistory.slice(0, -1),
            rag_config: {
                enabled: ragEnabled.checked,
                max_documents: 20,
                min_similarity: 0.6,
                search_mode: 'vector'
            }
        };
        console.log('[Chat] Sending request:', JSON.stringify(requestBody, null, 2));
        console.log('[Chat] RAG checkbox checked:', ragEnabled.checked);

        // Create AbortController for timeout handling
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 300000); // 300 second timeout (5 minutes)

        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody),
            signal: controller.signal
        });

        clearTimeout(timeoutId);

        // Remove thinking status
        removeStatusMessage(thinkingMsg);

        const data = await response.json();

        if (data.success) {
            // Add assistant response
            addMessage('assistant', data.message);
            conversationHistory.push({ role: 'assistant', content: data.message });

            // Add technical metadata if available
            if (data.metadata) {
                addTechnicalMetadata(data.metadata);
            }

            // Update status
            const contextDocs = data.context_docs ? data.context_docs.length : 0;
            statusDiv.textContent = `Mode: ${data.mode} | Model: ${data.model} | Context docs: ${contextDocs}`;
        } else {
            // Show error in chat window
            addMessage('assistant', '‚ùå Error: ' + data.error);
            showNotification('Error: ' + data.error, 'error');
            statusDiv.textContent = 'Error occurred';
        }
    } catch (error) {
        // Remove thinking status if still present
        removeStatusMessage(thinkingMsg);

        if (error.name === 'AbortError') {
            // Show timeout message in chat window
            const timeoutMsg = '‚è± Request timed out after 5 minutes. The LLM may need more time to process your request, or the server may be overloaded.';
            addMessage('assistant', timeoutMsg);
            showNotification('Request timed out after 5 minutes', 'error');
            statusDiv.textContent = 'Request timed out';
        } else {
            // Show connection error in chat window
            const errorMsg = '‚ùå Connection error: ' + error.message;
            addMessage('assistant', errorMsg);
            showNotification('Failed to send message: ' + error.message, 'error');
            statusDiv.textContent = 'Connection error';
        }
    } finally {
        sendBtn.disabled = false;
    }
}

// Clear chat
function clearChat() {
    chatMessages.innerHTML = '';
    conversationHistory = [];
    statusDiv.textContent = '';
    showNotification('Chat cleared', 'info');
}

// Load saved RAG preference from localStorage
const savedRagEnabled = localStorage.getItem('rag-enabled');
if (savedRagEnabled !== null) {
    ragEnabled.checked = savedRagEnabled === 'true';
}

// Save RAG preference when changed
ragEnabled.addEventListener('change', () => {
    localStorage.setItem('rag-enabled', ragEnabled.checked);
});

// Event listeners
sendBtn.addEventListener('click', sendMessage);
clearBtn.addEventListener('click', clearChat);

userMessageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// Live status monitoring
const liveStatusDiv = document.getElementById('live-status');
let lastHealthCheck = null;

function updateLiveStatus() {
    fetch('/api/chat/health')
        .then(r => r.json())
        .then(data => {
            lastHealthCheck = data;

            // Build status HTML with visual indicators
            let statusHTML = '<span class="icon-text is-flex-wrap-wrap">';

            // Mode indicator
            statusHTML += `<span class="mr-3"><strong>Mode:</strong> ${data.mode}</span>`;

            // For offline mode, show server statuses
            if (data.mode === 'offline') {
                // Embed server status
                const embedActive = data.embed_server === 'active';
                const embedColor = embedActive ? 'has-text-success' : 'has-text-danger';
                const embedIcon = embedActive ? 'fa-circle' : 'fa-circle';
                statusHTML += `<span class="icon-text mr-3">
                    <span class="icon ${embedColor}"><i class="fas ${embedIcon}"></i></span>
                    <span><strong>Embed:</strong> ${data.embed_server}</span>
                </span>`;

                // Chat server status
                const chatActive = data.chat_server === 'active';
                const chatColor = chatActive ? 'has-text-success' : 'has-text-danger';
                const chatIcon = chatActive ? 'fa-circle' : 'fa-circle';
                statusHTML += `<span class="icon-text mr-3">
                    <span class="icon ${chatColor}"><i class="fas ${chatIcon}"></i></span>
                    <span><strong>Chat:</strong> ${data.chat_server}</span>
                </span>`;

                // Model loaded indicator
                const modelColor = data.model_loaded ? 'has-text-success' : 'has-text-warning';
                const modelIcon = data.model_loaded ? 'fa-check-circle' : 'fa-exclamation-triangle';
                statusHTML += `<span class="icon-text">
                    <span class="icon ${modelColor}"><i class="fas ${modelIcon}"></i></span>
                    <span><strong>Models:</strong> ${data.model_loaded ? 'loaded' : 'not loaded'}</span>
                </span>`;
            } else {
                // For mock/online mode, just show health
                const healthColor = data.healthy ? 'has-text-success' : 'has-text-danger';
                const healthIcon = data.healthy ? 'fa-check-circle' : 'fa-times-circle';
                statusHTML += `<span class="icon-text">
                    <span class="icon ${healthColor}"><i class="fas ${healthIcon}"></i></span>
                    <span><strong>Status:</strong> ${data.healthy ? 'healthy' : 'unhealthy'}</span>
                </span>`;
            }

            statusHTML += '</span>';
            liveStatusDiv.innerHTML = statusHTML;

            // Update main status if not showing message response
            if (!statusDiv.textContent || statusDiv.textContent === 'Checking service status...' || statusDiv.textContent.includes('service ready')) {
                if (data.healthy) {
                    statusDiv.textContent = `Chat service ready (${data.mode} mode)`;
                } else {
                    statusDiv.textContent = 'Service unavailable';
                }
            }
        })
        .catch(err => {
            liveStatusDiv.innerHTML = `<span class="icon-text">
                <span class="icon has-text-danger"><i class="fas fa-times-circle"></i></span>
                <span>Connection error - retrying...</span>
            </span>`;
            console.error('Health check failed:', err);
        });
}

// Initial health check
updateLiveStatus();

// Poll health endpoint every 30 seconds (personal service - no need for frequent checks)
setInterval(updateLiveStatus, 30000);
    </script>
</body>
</html>
