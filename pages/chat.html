<!DOCTYPE html>
<html lang="en">
<head>
    {{template "head.html" .}}
    <title>Chat - Quaero</title>
</head>
<body class="has-navbar-fixed-top">
    <div class="wrapper">
        {{template "navbar.html" .}}

        <section class="section" style="min-height: calc(100vh - 200px);">
            <div class="container">
                <div class="card mt-5">
                    <header class="card-header">
                        <p class="card-header-title">
                            <span class="icon"><i class="fas fa-comments"></i></span>
                            <span>Chat</span>
                        </p>
                    </header>
                    <div class="card-content">
                        <!-- Chat Container -->
                        <div class="box" style="height: 60vh; overflow-y: auto; padding: 1rem; margin-bottom: 1rem; background: #1a1a1a;">
                            <div id="chat-messages"></div>
                        </div>

                        <!-- Message Input -->
                        <div class="field">
                            <div class="control">
                                <textarea id="user-message" class="textarea" rows="3" placeholder="Type your message..."></textarea>
                            </div>
                        </div>

                        <!-- Controls -->
                        <div class="field is-grouped">
                            <div class="control is-expanded">
                                <label class="checkbox">
                                    <input type="checkbox" id="rag-enabled">
                                    Enable RAG (Document Retrieval) - Requires embedding support
                                </label>
                            </div>
                            <div class="control">
                                <button id="send-btn" class="button is-primary is-small is-outlined">
                                    <span class="icon"><i class="fas fa-paper-plane"></i></span>
                                    <span>Send</span>
                                </button>
                            </div>
                            <div class="control">
                                <button id="clear-btn" class="button is-danger is-small is-outlined">
                                    <span class="icon"><i class="fas fa-trash"></i></span>
                                    <span>Clear</span>
                                </button>
                            </div>
                        </div>

                        <!-- Status -->
                        <div id="status" class="mt-3 has-text-grey"></div>
                    </div>
                </div>

                {{template "service-logs.html" .}}
            </div>
        </section>
    </div>

    {{template "footer.html" .}}

    {{template "snackbar.html" .}}

    <script>
// Chat functionality
const chatMessages = document.getElementById('chat-messages');
const userMessageInput = document.getElementById('user-message');
const sendBtn = document.getElementById('send-btn');
const clearBtn = document.getElementById('clear-btn');
const ragEnabled = document.getElementById('rag-enabled');
const statusDiv = document.getElementById('status');

let conversationHistory = [];

// Add message to chat
function addMessage(role, content) {
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message-block', role === 'user' ? 'is-user' : 'is-assistant');

    const roleSpan = document.createElement('strong');
    roleSpan.textContent = role === 'user' ? 'You: ' : 'Assistant: ';

    const contentSpan = document.createElement('span');
    contentSpan.textContent = content;
    contentSpan.style.whiteSpace = 'pre-wrap';

    messageDiv.appendChild(roleSpan);
    messageDiv.appendChild(contentSpan);
    chatMessages.appendChild(messageDiv);

    // Scroll to bottom
    chatMessages.parentElement.scrollTop = chatMessages.parentElement.scrollHeight;
}

// Send message
async function sendMessage() {
    const message = userMessageInput.value.trim();
    if (!message) {
        showNotification('Please enter a message', 'error');
        return;
    }

    // Add user message to chat
    addMessage('user', message);
    conversationHistory.push({ role: 'user', content: message });

    // Clear input
    userMessageInput.value = '';

    // Disable send button
    sendBtn.disabled = true;
    statusDiv.textContent = 'Thinking...';

    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: message,
                history: conversationHistory.slice(0, -1),
                rag_config: {
                    enabled: ragEnabled.checked,
                    max_documents: 5,
                    min_similarity: 0.7,
                    search_mode: 'vector'
                }
            })
        });

        const data = await response.json();

        if (data.success) {
            // Add assistant response
            addMessage('assistant', data.message);
            conversationHistory.push({ role: 'assistant', content: data.message });

            // Update status
            const contextDocs = data.context_docs ? data.context_docs.length : 0;
            statusDiv.textContent = `Mode: ${data.mode} | Model: ${data.model} | Context docs: ${contextDocs}`;
        } else {
            showNotification('Error: ' + data.error, 'error');
            statusDiv.textContent = 'Error occurred';
        }
    } catch (error) {
        showNotification('Failed to send message: ' + error.message, 'error');
        statusDiv.textContent = 'Connection error';
    } finally {
        sendBtn.disabled = false;
    }
}

// Clear chat
function clearChat() {
    chatMessages.innerHTML = '';
    conversationHistory = [];
    statusDiv.textContent = '';
    showNotification('Chat cleared', 'info');
}

// Event listeners
sendBtn.addEventListener('click', sendMessage);
clearBtn.addEventListener('click', clearChat);

userMessageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// Check service health on load
fetch('/api/chat/health')
    .then(r => r.json())
    .then(data => {
        if (data.healthy) {
            statusDiv.textContent = `Chat service ready (${data.mode} mode)`;
        } else {
            showNotification('Chat service unhealthy: ' + data.error, 'error');
            statusDiv.textContent = 'Service unavailable';
        }
    })
    .catch(err => {
        showNotification('Failed to check service health', 'error');
        statusDiv.textContent = 'Connection error';
    });
    </script>
</body>
</html>
