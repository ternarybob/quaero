<!DOCTYPE html>
<html lang="en">

<head>
    {{template "head.html" .}}
    <title>Chat - Quaero</title>
</head>

<body>

    {{template "navbar.html" .}}

    <main class="page-container">

        <!-- Page Title -->
        <div class="page-title">
            <h1>Chat</h1>
            <p>AI-powered conversational interface with RAG document retrieval</p>
        </div>

        <section>
            <div class="card">
                <div class="card-header">
                    <h2>Chat</h2>
                </div>
                <div class="card-body">
                        <!-- Chat Container -->
                        <div class="terminal" style="height: 60vh; margin-bottom: 1rem;">
                            <div id="chat-messages"></div>
                        </div>

                        <!-- Message Input -->
                        <div style="margin-bottom: 1rem;">
                            <textarea id="user-message" class="form-input" rows="3" placeholder="Type your message..." style="min-height: 5rem; resize: vertical;"></textarea>
                        </div>

                        <!-- Controls -->
                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; flex-wrap: wrap;">
                            <div>
                                <label class="form-checkbox">
                                    <input type="checkbox" id="rag-enabled" checked>
                                    <i class="form-icon"></i> Enable RAG (Document Retrieval) - Requires embedding support
                                </label>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button id="send-btn" class="btn btn-sm btn-primary">
                                    <i class="fas fa-paper-plane"></i>
                                    <span>Send</span>
                                </button>
                                <button id="clear-btn" class="btn btn-sm btn-error">
                                    <i class="fas fa-trash"></i>
                                    <span>Clear</span>
                                </button>
                            </div>
                        </div>

                        <!-- Status -->
                        <div style="margin-top: 1rem;">
                            <div id="status" style="color: var(--text-secondary); margin-bottom: 0.5rem;"></div>
                            <div id="live-status" style="color: var(--text-secondary); font-size: 0.875rem;">
                                <span>
                                    <i class="fas fa-circle-notch fa-spin"></i>
                                    <span>Checking service status...</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Service Logs -->
        <section style="margin-top: 1.5rem;">
            {{template "service-logs.html" .}}
        </section>

    </main>

    {{template "footer.html" .}}

    {{template "snackbar.html" .}}

    <script>
        // Chat functionality
        const chatMessages = document.getElementById('chat-messages');
        const userMessageInput = document.getElementById('user-message');
        const sendBtn = document.getElementById('send-btn');
        const clearBtn = document.getElementById('clear-btn');
        const ragEnabled = document.getElementById('rag-enabled');
        const statusDiv = document.getElementById('status');

        let conversationHistory = [];

        // Add message to chat
        function addMessage(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message-block', role === 'user' ? 'is-user' : 'is-assistant');

            const roleSpan = document.createElement('strong');
            roleSpan.textContent = role === 'user' ? 'You: ' : 'Assistant: ';
            roleSpan.style.color = '#ffffff';

            const contentSpan = document.createElement('span');
            contentSpan.textContent = content;
            contentSpan.style.whiteSpace = 'pre-wrap';
            contentSpan.style.color = '#e0e0e0';

            messageDiv.appendChild(roleSpan);
            messageDiv.appendChild(contentSpan);
            chatMessages.appendChild(messageDiv);

            // Scroll to bottom
            chatMessages.parentElement.scrollTop = chatMessages.parentElement.scrollHeight;
        }

        // Add technical metadata section
        function addTechnicalMetadata(metadata) {
            const metadataDiv = document.createElement('div');
            metadataDiv.classList.add('technical-metadata');
            metadataDiv.style.borderLeft = '3px solid #48c78e';
            metadataDiv.style.padding = '0.5rem 0.75rem';
            metadataDiv.style.borderRadius = '0.25rem';
            metadataDiv.style.fontSize = '0.875rem';
            metadataDiv.style.backgroundColor = 'var(--code-bg)';
            metadataDiv.style.marginTop = '0.5rem';

            let html = '<strong style="color: #48c78e;">‚öô Technical Details</strong><br>';

            if (metadata.thinking_time) {
                html += `<span style="color: #b5b5b5;">‚è± Thinking time: ${metadata.thinking_time}</span><br>`;
            }

            if (metadata.document_count !== undefined) {
                html += `<span style="color: #b5b5b5;">üìÑ Documents used: ${metadata.document_count}</span><br>`;
            }

            if (metadata.references && metadata.references.length > 0) {
                html += '<span style="color: #b5b5b5;">üìö References:</span><br>';
                metadata.references.forEach((ref, idx) => {
                    html += `<span style="color: #a0a0a0; margin-left: 1rem;">${idx + 1}. ${ref}</span><br>`;
                });
            }

            if (metadata.rag_enabled !== undefined) {
                const ragStatus = metadata.rag_enabled ? 'enabled' : 'disabled';
                const ragColor = metadata.rag_enabled ? '#48c78e' : '#f14668';
                html += `<span style="color: ${ragColor};">üîç RAG: ${ragStatus}</span>`;
            }

            metadataDiv.innerHTML = html;
            chatMessages.appendChild(metadataDiv);

            // Scroll to bottom
            chatMessages.parentElement.scrollTop = chatMessages.parentElement.scrollHeight;
        }

        // Add status message to chat window with scrolling bold animation
        function addStatusMessage(message) {
            const statusMsg = document.createElement('div');
            statusMsg.classList.add('message-block', 'is-status');
            statusMsg.style.fontStyle = 'italic';
            statusMsg.style.color = '#a0a0a0';
            statusMsg.style.padding = '0.5rem';

            // Create container for animated text
            const textContainer = document.createElement('span');
            statusMsg.appendChild(textContainer);

            chatMessages.appendChild(statusMsg);

            // Scroll to bottom
            chatMessages.parentElement.scrollTop = chatMessages.parentElement.scrollHeight;

            // Text and dot patterns
            const text = 'Thinking';
            const dotPatterns = ['.', '..', '...', '....', '...', '..'];
            let boldIndex = 0; // Which letter is bold
            let dotIndex = 0;   // Which dot pattern

            // Function to render the text with one letter bold
            function renderText() {
                textContainer.innerHTML = '';

                // Render each letter, making one bold
                for (let i = 0; i < text.length; i++) {
                    const letterSpan = document.createElement('span');
                    letterSpan.textContent = text[i];
                    if (i === boldIndex) {
                        letterSpan.style.fontWeight = 'bold';
                    }
                    textContainer.appendChild(letterSpan);
                }

                // Add dots
                const dotsSpan = document.createElement('span');
                dotsSpan.textContent = dotPatterns[dotIndex];
                textContainer.appendChild(dotsSpan);
            }

            // Initial render
            renderText();

            // Animate: scroll bold through letters and cycle dots
            statusMsg.animationInterval = setInterval(() => {
                // Move bold to next letter
                boldIndex = (boldIndex + 1) % text.length;

                // Update dots every full cycle through the text
                if (boldIndex === 0) {
                    dotIndex = (dotIndex + 1) % dotPatterns.length;
                }

                renderText();
            }, 200); // Update every 200ms for smooth scrolling

            return statusMsg;
        }

        // Remove status message from chat window
        function removeStatusMessage(statusMsg) {
            if (statusMsg) {
                // Clear animation interval
                if (statusMsg.animationInterval) {
                    clearInterval(statusMsg.animationInterval);
                }

                // Remove from DOM
                if (statusMsg.parentNode) {
                    statusMsg.parentNode.removeChild(statusMsg);
                }
            }
        }

        // Send message
        async function sendMessage() {
            const message = userMessageInput.value.trim();
            if (!message) {
                showNotification('Please enter a message', 'error');
                return;
            }

            // Add user message to chat
            addMessage('user', message);
            conversationHistory.push({ role: 'user', content: message });

            // Clear input
            userMessageInput.value = '';

            // Disable send button and show thinking status in chat
            sendBtn.disabled = true;
            const thinkingMsg = addStatusMessage('Thinking...');

            try {
                const requestBody = {
                    message: message,
                    history: conversationHistory.slice(0, -1),
                    rag_config: {
                        enabled: ragEnabled.checked,
                        max_documents: 20,
                        min_similarity: 0.6,
                        search_mode: 'vector'
                    }
                };
                console.log('[Chat] Sending request:', JSON.stringify(requestBody, null, 2));
                console.log('[Chat] RAG checkbox checked:', ragEnabled.checked);

                // Create AbortController for timeout handling
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 300000); // 300 second timeout (5 minutes)

                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                // Remove thinking status
                removeStatusMessage(thinkingMsg);

                const data = await response.json();

                if (data.success) {
                    // Add assistant response
                    addMessage('assistant', data.message);
                    conversationHistory.push({ role: 'assistant', content: data.message });

                    // Add technical metadata if available
                    if (data.metadata) {
                        addTechnicalMetadata(data.metadata);
                    }

                    // Update status
                    const contextDocs = data.context_docs ? data.context_docs.length : 0;
                    statusDiv.textContent = `Mode: ${data.mode} | Model: ${data.model} | Context docs: ${contextDocs}`;
                } else {
                    // Show error in chat window
                    addMessage('assistant', '‚ùå Error: ' + data.error);
                    showNotification('Error: ' + data.error, 'error');
                    statusDiv.textContent = 'Error occurred';
                }
            } catch (error) {
                // Remove thinking status if still present
                removeStatusMessage(thinkingMsg);

                if (error.name === 'AbortError') {
                    // Show timeout message in chat window
                    const timeoutMsg = '‚è± Request timed out after 5 minutes. The LLM may need more time to process your request, or the server may be overloaded.';
                    addMessage('assistant', timeoutMsg);
                    showNotification('Request timed out after 5 minutes', 'error');
                    statusDiv.textContent = 'Request timed out';
                } else {
                    // Show connection error in chat window
                    const errorMsg = '‚ùå Connection error: ' + error.message;
                    addMessage('assistant', errorMsg);
                    showNotification('Failed to send message: ' + error.message, 'error');
                    statusDiv.textContent = 'Connection error';
                }
            } finally {
                sendBtn.disabled = false;
            }
        }

        // Clear chat
        function clearChat() {
            chatMessages.innerHTML = '';
            conversationHistory = [];
            statusDiv.textContent = '';
            showNotification('Chat cleared', 'info');
        }

        // Load saved RAG preference from localStorage
        const savedRagEnabled = localStorage.getItem('rag-enabled');
        if (savedRagEnabled !== null) {
            ragEnabled.checked = savedRagEnabled === 'true';
        }

        // Save RAG preference when changed
        ragEnabled.addEventListener('change', () => {
            localStorage.setItem('rag-enabled', ragEnabled.checked);
        });

        // Event listeners
        sendBtn.addEventListener('click', sendMessage);
        clearBtn.addEventListener('click', clearChat);

        userMessageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Live status monitoring
        const liveStatusDiv = document.getElementById('live-status');
        let lastHealthCheck = null;

        function updateLiveStatus() {
            fetch('/api/chat/health')
                .then(r => r.json())
                .then(data => {
                    lastHealthCheck = data;

                    // Build status HTML with visual indicators
                    let statusHTML = '<span style="display: flex; flex-wrap: wrap; gap: 0.75rem;">';

                    // Mode indicator
                    statusHTML += `<span><strong>Mode:</strong> ${data.mode}</span>`;

                    // For offline mode, show server statuses
                    if (data.mode === 'offline') {
                        // Embed server status
                        const embedActive = data.embed_server === 'active';
                        const embedColor = embedActive ? 'var(--color-success)' : 'var(--color-danger)';
                        const embedIcon = embedActive ? 'fa-circle' : 'fa-circle';
                        statusHTML += `<span style="display: flex; align-items: center; gap: 0.25rem;">
                    <i class="fas ${embedIcon}" style="color: ${embedColor};"></i>
                    <span><strong>Embed:</strong> ${data.embed_server}</span>
                </span>`;

                        // Chat server status
                        const chatActive = data.chat_server === 'active';
                        const chatColor = chatActive ? 'var(--color-success)' : 'var(--color-danger)';
                        const chatIcon = chatActive ? 'fa-circle' : 'fa-circle';
                        statusHTML += `<span style="display: flex; align-items: center; gap: 0.25rem;">
                    <i class="fas ${chatIcon}" style="color: ${chatColor};"></i>
                    <span><strong>Chat:</strong> ${data.chat_server}</span>
                </span>`;

                        // Model loaded indicator
                        const modelColor = data.model_loaded ? 'var(--color-success)' : 'var(--color-warning)';
                        const modelIcon = data.model_loaded ? 'fa-check-circle' : 'fa-exclamation-triangle';
                        statusHTML += `<span style="display: flex; align-items: center; gap: 0.25rem;">
                    <i class="fas ${modelIcon}" style="color: ${modelColor};"></i>
                    <span><strong>Models:</strong> ${data.model_loaded ? 'loaded' : 'not loaded'}</span>
                </span>`;
                    } else {
                        // For mock/online mode, just show health
                        const healthColor = data.healthy ? 'var(--color-success)' : 'var(--color-danger)';
                        const healthIcon = data.healthy ? 'fa-check-circle' : 'fa-times-circle';
                        statusHTML += `<span style="display: flex; align-items: center; gap: 0.25rem;">
                    <i class="fas ${healthIcon}" style="color: ${healthColor};"></i>
                    <span><strong>Status:</strong> ${data.healthy ? 'healthy' : 'unhealthy'}</span>
                </span>`;
                    }

                    statusHTML += '</span>';
                    liveStatusDiv.innerHTML = statusHTML;

                    // Update main status if not showing message response
                    if (!statusDiv.textContent || statusDiv.textContent === 'Checking service status...' || statusDiv.textContent.includes('service ready')) {
                        if (data.healthy) {
                            statusDiv.textContent = `Chat service ready (${data.mode} mode)`;
                        } else {
                            statusDiv.textContent = 'Service unavailable';
                        }
                    }
                })
                .catch(err => {
                    liveStatusDiv.innerHTML = `<span style="display: flex; align-items: center; gap: 0.25rem;">
                <i class="fas fa-times-circle" style="color: var(--color-danger);"></i>
                <span>Connection error - retrying...</span>
            </span>`;
                    console.error('Health check failed:', err);
                });
        }

        // Initial health check
        updateLiveStatus();

        // Poll health endpoint every 30 seconds (personal service - no need for frequent checks)
        setInterval(updateLiveStatus, 30000);
    </script>
</body>

</html>