<!DOCTYPE html>
<html lang="en">
<head>
    {{template "head.html" .}}
    <title>Chat - Quaero</title>
</head>
<body class="has-navbar-fixed-top">
    <div class="wrapper">
        {{template "navbar.html" .}}

        <section class="section">
            <div class="container">
                <div class="card mt-5">
                    <header class="card-header">
                        <p class="card-header-title">
                            <span class="icon"><i class="fas fa-comments"></i></span>
                            <span>Chat</span>
                        </p>
                    </header>
                    <div class="card-content">
                        <!-- Chat Container -->
                        <div class="box" style="height: 60vh; overflow-y: auto; padding: 1rem; margin-bottom: 1rem; background: #1a1a1a;">
                            <div id="chat-messages"></div>
                        </div>

                        <!-- Message Input -->
                        <div class="field">
                            <div class="control">
                                <textarea id="user-message" class="textarea" rows="3" placeholder="Type your message..."></textarea>
                            </div>
                        </div>

                        <!-- Controls -->
                        <div class="field is-grouped">
                            <div class="control is-expanded">
                                <label class="checkbox">
                                    <input type="checkbox" id="rag-enabled" checked>
                                    Enable RAG (Document Retrieval) - Requires embedding support
                                </label>
                            </div>
                            <div class="control">
                                <button id="send-btn" class="button is-primary is-small is-outlined">
                                    <span class="icon"><i class="fas fa-paper-plane"></i></span>
                                    <span>Send</span>
                                </button>
                            </div>
                            <div class="control">
                                <button id="clear-btn" class="button is-danger is-small is-outlined">
                                    <span class="icon"><i class="fas fa-trash"></i></span>
                                    <span>Clear</span>
                                </button>
                            </div>
                        </div>

                        <!-- Status -->
                        <div class="mt-3">
                            <div id="status" class="has-text-grey mb-2"></div>
                            <div id="live-status" class="has-text-grey-light is-size-7">
                                <span class="icon-text">
                                    <span class="icon"><i class="fas fa-circle-notch fa-spin"></i></span>
                                    <span>Checking service status...</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                {{template "service-logs.html" .}}
            </div>
        </section>
    </div>

    {{template "footer.html" .}}

    {{template "snackbar.html" .}}

    <script>
// Chat functionality
const chatMessages = document.getElementById('chat-messages');
const userMessageInput = document.getElementById('user-message');
const sendBtn = document.getElementById('send-btn');
const clearBtn = document.getElementById('clear-btn');
const ragEnabled = document.getElementById('rag-enabled');
const statusDiv = document.getElementById('status');

let conversationHistory = [];

// Add message to chat
function addMessage(role, content) {
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message-block', role === 'user' ? 'is-user' : 'is-assistant');

    const roleSpan = document.createElement('strong');
    roleSpan.textContent = role === 'user' ? 'You: ' : 'Assistant: ';
    roleSpan.style.color = '#ffffff';

    const contentSpan = document.createElement('span');
    contentSpan.textContent = content;
    contentSpan.style.whiteSpace = 'pre-wrap';
    contentSpan.style.color = '#e0e0e0';

    messageDiv.appendChild(roleSpan);
    messageDiv.appendChild(contentSpan);
    chatMessages.appendChild(messageDiv);

    // Scroll to bottom
    chatMessages.parentElement.scrollTop = chatMessages.parentElement.scrollHeight;
}

// Send message
async function sendMessage() {
    const message = userMessageInput.value.trim();
    if (!message) {
        showNotification('Please enter a message', 'error');
        return;
    }

    // Add user message to chat
    addMessage('user', message);
    conversationHistory.push({ role: 'user', content: message });

    // Clear input
    userMessageInput.value = '';

    // Disable send button
    sendBtn.disabled = true;
    statusDiv.textContent = 'Thinking...';

    try {
        const requestBody = {
            message: message,
            history: conversationHistory.slice(0, -1),
            rag_config: {
                enabled: ragEnabled.checked,
                max_documents: 5,
                min_similarity: 0.7,
                search_mode: 'vector'
            }
        };
        console.log('[Chat] Sending request:', JSON.stringify(requestBody, null, 2));
        console.log('[Chat] RAG checkbox checked:', ragEnabled.checked);

        // Create AbortController for timeout handling
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 120000); // 120 second timeout (2 minutes)

        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody),
            signal: controller.signal
        });

        clearTimeout(timeoutId);

        const data = await response.json();

        if (data.success) {
            // Add assistant response
            addMessage('assistant', data.message);
            conversationHistory.push({ role: 'assistant', content: data.message });

            // Update status
            const contextDocs = data.context_docs ? data.context_docs.length : 0;
            statusDiv.textContent = `Mode: ${data.mode} | Model: ${data.model} | Context docs: ${contextDocs}`;
        } else {
            showNotification('Error: ' + data.error, 'error');
            statusDiv.textContent = 'Error occurred';
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            showNotification('Request timed out after 2 minutes. The LLM may need more time to process your request.', 'error');
            statusDiv.textContent = 'Request timed out';
        } else {
            showNotification('Failed to send message: ' + error.message, 'error');
            statusDiv.textContent = 'Connection error';
        }
    } finally {
        sendBtn.disabled = false;
    }
}

// Clear chat
function clearChat() {
    chatMessages.innerHTML = '';
    conversationHistory = [];
    statusDiv.textContent = '';
    showNotification('Chat cleared', 'info');
}

// Load saved RAG preference from localStorage
const savedRagEnabled = localStorage.getItem('rag-enabled');
if (savedRagEnabled !== null) {
    ragEnabled.checked = savedRagEnabled === 'true';
}

// Save RAG preference when changed
ragEnabled.addEventListener('change', () => {
    localStorage.setItem('rag-enabled', ragEnabled.checked);
});

// Event listeners
sendBtn.addEventListener('click', sendMessage);
clearBtn.addEventListener('click', clearChat);

userMessageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// Live status monitoring
const liveStatusDiv = document.getElementById('live-status');
let lastHealthCheck = null;

function updateLiveStatus() {
    fetch('/api/chat/health')
        .then(r => r.json())
        .then(data => {
            lastHealthCheck = data;

            // Build status HTML with visual indicators
            let statusHTML = '<span class="icon-text is-flex-wrap-wrap">';

            // Mode indicator
            statusHTML += `<span class="mr-3"><strong>Mode:</strong> ${data.mode}</span>`;

            // For offline mode, show server statuses
            if (data.mode === 'offline') {
                // Embed server status
                const embedActive = data.embed_server === 'active';
                const embedColor = embedActive ? 'has-text-success' : 'has-text-danger';
                const embedIcon = embedActive ? 'fa-circle' : 'fa-circle';
                statusHTML += `<span class="icon-text mr-3">
                    <span class="icon ${embedColor}"><i class="fas ${embedIcon}"></i></span>
                    <span><strong>Embed:</strong> ${data.embed_server}</span>
                </span>`;

                // Chat server status
                const chatActive = data.chat_server === 'active';
                const chatColor = chatActive ? 'has-text-success' : 'has-text-danger';
                const chatIcon = chatActive ? 'fa-circle' : 'fa-circle';
                statusHTML += `<span class="icon-text mr-3">
                    <span class="icon ${chatColor}"><i class="fas ${chatIcon}"></i></span>
                    <span><strong>Chat:</strong> ${data.chat_server}</span>
                </span>`;

                // Model loaded indicator
                const modelColor = data.model_loaded ? 'has-text-success' : 'has-text-warning';
                const modelIcon = data.model_loaded ? 'fa-check-circle' : 'fa-exclamation-triangle';
                statusHTML += `<span class="icon-text">
                    <span class="icon ${modelColor}"><i class="fas ${modelIcon}"></i></span>
                    <span><strong>Models:</strong> ${data.model_loaded ? 'loaded' : 'not loaded'}</span>
                </span>`;
            } else {
                // For mock/online mode, just show health
                const healthColor = data.healthy ? 'has-text-success' : 'has-text-danger';
                const healthIcon = data.healthy ? 'fa-check-circle' : 'fa-times-circle';
                statusHTML += `<span class="icon-text">
                    <span class="icon ${healthColor}"><i class="fas ${healthIcon}"></i></span>
                    <span><strong>Status:</strong> ${data.healthy ? 'healthy' : 'unhealthy'}</span>
                </span>`;
            }

            statusHTML += '</span>';
            liveStatusDiv.innerHTML = statusHTML;

            // Update main status if not showing message response
            if (!statusDiv.textContent || statusDiv.textContent === 'Checking service status...' || statusDiv.textContent.includes('service ready')) {
                if (data.healthy) {
                    statusDiv.textContent = `Chat service ready (${data.mode} mode)`;
                } else {
                    statusDiv.textContent = 'Service unavailable';
                }
            }
        })
        .catch(err => {
            liveStatusDiv.innerHTML = `<span class="icon-text">
                <span class="icon has-text-danger"><i class="fas fa-times-circle"></i></span>
                <span>Connection error - retrying...</span>
            </span>`;
            console.error('Health check failed:', err);
        });
}

// Initial health check
updateLiveStatus();

// Poll health endpoint every 30 seconds (personal service - no need for frequent checks)
setInterval(updateLiveStatus, 30000);
    </script>
</body>
</html>
