<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quaero - Document Management</title>

    <!-- Material Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    <!-- Beer CSS -->
    <link href="https://cdn.jsdelivr.net/npm/beercss@3.12.11/dist/cdn/beer.min.css" rel="stylesheet">
    <script type="module" src="https://cdn.jsdelivr.net/npm/beercss@3.12.11/dist/cdn/beer.min.js"></script>

    <!-- Highlight.js for code syntax -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    
    <!-- WebSocket Manager -->
    <script src="/static/websocket-manager.js"></script>
    
    <!-- Quaero Theme -->
    <link rel="stylesheet" href="/static/common.css">

</head>
<body class="light">
    {{template "navbar" .}}
    {{template "snackbar" .}}

    <!-- Main Content -->
    <main class="responsive with-panel">
        <!-- Hero Section -->
        <header class="center-align">
            <h3>Document Management</h3>
            <p>Normalized documents with vector embeddings for semantic search</p>
        </header>
        
        {{template "service-status" .}}

        <!-- Document Statistics -->
        <article class="border">
            <header>
                <nav>
                    <h5>Document Statistics</h5>
                    <div class="max"></div>
                    <button class="circle transparent" onclick="loadStats()"><i class="material-icons">refresh</i></button>
                </nav>
            </header>

            <div class="grid">
                <div class="s12 m6 l3">
                    <article class="border center-align">
                        <div class="small-text">TOTAL DOCUMENTS</div>
                        <h4 id="stat-total">-</h4>
                    </article>
                </div>
                <div class="s12 m6 l3">
                    <article class="border center-align">
                        <div class="small-text">VECTORIZED</div>
                        <h4 id="stat-vectorized">-</h4>
                    </article>
                </div>
                <div class="s12 m6 l3">
                    <article class="border center-align">
                        <div class="small-text">JIRA DOCUMENTS</div>
                        <h4 id="stat-jira">-</h4>
                    </article>
                </div>
                <div class="s12 m6 l3">
                    <article class="border center-align">
                        <div class="small-text">CONFLUENCE DOCUMENTS</div>
                        <h4 id="stat-confluence">-</h4>
                    </article>
                </div>
            </div>
        </article>

        <!-- Documents Table -->
        <article class="border">
            <header>
                <nav>
                    <h5>Documents</h5>
                    <span id="document-count" class="small-text">0 documents</span>
                </nav>
            </header>

            <!-- Filter Controls -->
            <div class="grid">
                <div class="s12 m6 l6">
                    <div class="field border">
                        <input type="search" id="search-box" placeholder="Search documents...">
                        <i>search</i>
                    </div>
                </div>
                <div class="s12 m3 l3">
                    <div class="field border suffix">
                        <select id="source-filter" class="small" onchange="filterDocuments()">
                            <option value="">All Sources</option>
                            <option value="jira">Jira</option>
                            <option value="confluence">Confluence</option>
                        </select>
                        <i>arrow_drop_down</i>
                    </div>
                </div>
                <div class="s12 m3 l3">
                    <div class="field border suffix">
                        <select id="vectorized-filter" class="small" onchange="filterDocuments()">
                            <option value="">All Documents</option>
                            <option value="true">Vectorized Only</option>
                            <option value="false">Not Vectorized</option>
                        </select>
                        <i>arrow_drop_down</i>
                    </div>
                </div>
            </div>

            <!-- Documents Table -->
            <div class="scroll">
                <table class="border">
                    <thead>
                        <tr>
                            <th>SOURCE</th>
                            <th>SOURCE ID</th>
                            <th>TITLE</th>
                            <th class="center-align">VECTORIZED</th>
                            <th>UPDATED</th>
                            <th class="center-align">ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody id="documents-table-body">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 15px;">
                                Loading documents...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </article>

        <!-- Document Detail -->
        <article class="border">
            <header>
                <nav>
                    <h5>Document Detail</h5>
                    <span id="selected-document-id" class="small-text"></span>
                </nav>
            </header>
            <pre id="document-detail-json"><code class="language-json"></code></pre>
        </article>

        {{template "service-logs" .}}

    </main>

    {{template "footer" .}}

    <script>
        // State management
        let allDocuments = [];
        let filteredDocuments = [];
        let selectedDocument = null;

        // Load document statistics
        async function loadStats() {
            try {
                const response = await fetch('/api/documents/stats');
                if (!response.ok) {
                    throw new Error('Failed to fetch stats');
                }

                const stats = await response.json();

                document.getElementById('stat-total').textContent = stats.total_documents || 0;
                document.getElementById('stat-vectorized').textContent = stats.vectorized_documents || 0;
                document.getElementById('stat-jira').textContent = stats.jira_documents || 0;
                document.getElementById('stat-confluence').textContent = stats.confluence_documents || 0;

            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('stat-total').textContent = 'Error';
                document.getElementById('stat-vectorized').textContent = 'Error';
                document.getElementById('stat-jira').textContent = 'Error';
                document.getElementById('stat-confluence').textContent = 'Error';
            }
        }

        // Load all documents
        async function loadDocuments() {
            const tbody = document.getElementById('documents-table-body');

            try {
                const response = await fetch('/api/documents');
                if (!response.ok) {
                    throw new Error('Failed to fetch documents');
                }

                const data = await response.json();
                allDocuments = data.documents || [];
                filteredDocuments = [...allDocuments];

                renderDocuments();

            } catch (error) {
                console.error('Error loading documents:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 15px; color: #cc0000;">
                            Failed to load documents. Please try again.
                        </td>
                    </tr>
                `;
            }
        }

        // Filter documents based on search and filters
        function filterDocuments() {
            const searchTerm = document.getElementById('search-box').value.toLowerCase();
            const sourceFilter = document.getElementById('source-filter').value;
            const vectorizedFilter = document.getElementById('vectorized-filter').value;

            filteredDocuments = allDocuments.filter(doc => {
                // Search filter
                const matchesSearch = !searchTerm ||
                    (doc.title && doc.title.toLowerCase().includes(searchTerm)) ||
                    (doc.content && doc.content.toLowerCase().includes(searchTerm)) ||
                    (doc.source_id && doc.source_id.toLowerCase().includes(searchTerm));

                // Source filter
                const matchesSource = !sourceFilter ||
                    (doc.source_type && doc.source_type.toLowerCase() === sourceFilter.toLowerCase());

                // Vectorized filter
                const hasEmbedding = doc.embedding_model && doc.embedding_model !== '';
                const matchesVectorized = !vectorizedFilter ||
                    (vectorizedFilter === 'true' && hasEmbedding) ||
                    (vectorizedFilter === 'false' && !hasEmbedding);

                return matchesSearch && matchesSource && matchesVectorized;
            });

            renderDocuments();
        }

        // Render documents table
        function renderDocuments() {
            const tbody = document.getElementById('documents-table-body');
            const countElement = document.getElementById('document-count');

            if (!filteredDocuments || filteredDocuments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 15px;">
                            No documents found matching the current filters.
                        </td>
                    </tr>
                `;
                countElement.textContent = '0 documents';
                return;
            }

            tbody.innerHTML = filteredDocuments.map((doc, index) => {
                const hasEmbedding = doc.embedding_model && doc.embedding_model !== '';
                const vectorizedBadge = hasEmbedding
                    ? '<span class="chip success">✓</span>'
                    : '<span class="chip error">✗</span>';
                const updatedDate = doc.updated_at ? new Date(doc.updated_at).toLocaleString() : 'N/A';
                const isSelected = selectedDocument && selectedDocument.id === doc.id;

                return `
                    <tr style="${isSelected ? 'background: #e3f2fd;' : ''}">
                        <td onclick="selectDocument(${index})" style="cursor: pointer;">${doc.source_type || 'N/A'}</td>
                        <td onclick="selectDocument(${index})" style="cursor: pointer;">${doc.source_id || 'N/A'}</td>
                        <td onclick="selectDocument(${index})" style="cursor: pointer;">${doc.title || 'Untitled'}</td>
                        <td onclick="selectDocument(${index})" class="center-align" style="cursor: pointer;">${vectorizedBadge}</td>
                        <td onclick="selectDocument(${index})" style="cursor: pointer;">${updatedDate}</td>
                        <td class="no-wrap">
                            <button class="small-round" onclick="event.stopPropagation(); reprocessDocument('${doc.id}')" title="Reprocess">
                                <i class="material-icons">refresh</i>
                            </button>
                            <button class="small-round" onclick="event.stopPropagation(); clearEmbedding('${doc.id}')" title="Clear Embedding">
                                <i>delete</i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            countElement.textContent = `${filteredDocuments.length} document${filteredDocuments.length !== 1 ? 's' : ''}`;
        }

        // Select and display document details
        function selectDocument(index) {
            selectedDocument = filteredDocuments[index];
            displayDocumentDetail(selectedDocument);
            renderDocuments();
        }

        function displayDocumentDetail(doc) {
            const selectedId = document.getElementById('selected-document-id');
            const detailPre = document.getElementById('document-detail-json');
            const codeBlock = detailPre.querySelector('code');

            if (!doc) {
                selectedId.textContent = '';
                codeBlock.textContent = '';
                return;
            }

            selectedId.textContent = doc.id || 'Unknown';
            const jsonString = JSON.stringify(doc, null, 2);
            codeBlock.textContent = jsonString;

            if (typeof hljs !== 'undefined') {
                hljs.highlightElement(codeBlock);
            }
        }

        // Reprocess a single document
        async function reprocessDocument(docId) {
            if (!confirm(`Reprocess document ${docId}?\n\nThis will queue the document for re-vectorization.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/documents/${docId}/reprocess`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('Failed to reprocess document');
                }

                alert('Document queued for reprocessing');
                setTimeout(() => {
                    loadStats();
                    loadDocuments();
                }, 1000);
            } catch (error) {
                console.error('Error reprocessing document:', error);
                alert('Failed to reprocess document: ' + error.message);
            }
        }

        // Clear embedding for a single document
        async function clearEmbedding(docId) {
            if (!confirm(`Clear embedding for document ${docId}?\n\nThe document will need to be reprocessed.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/documents/${docId}/embedding`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Failed to clear embedding');
                }

                alert('Embedding cleared successfully');
                setTimeout(() => {
                    loadStats();
                    loadDocuments();
                }, 1000);
            } catch (error) {
                console.error('Error clearing embedding:', error);
                alert('Failed to clear embedding: ' + error.message);
            }
        }

        // Search box event listener
        document.getElementById('search-box').addEventListener('input', filterDocuments);

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadDocuments();
        });

        // Initialize highlight.js
        if (typeof hljs !== 'undefined') {
            hljs.highlightAll();
        }
    </script>
</body>
</html>
