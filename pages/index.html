<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quaero - Monitoring Dashboard</title>

    <!-- Beer CSS -->
    <link href="https://cdn.jsdelivr.net/npm/beercss@3.12.11/dist/cdn/beer.min.css" rel="stylesheet">
    <script type="module" src="https://cdn.jsdelivr.net/npm/beercss@3.12.11/dist/cdn/beer.min.js"></script>

    <script src="https://unpkg.com/htmx.org@1.9.6"></script>

    <!-- Quaero Theme -->
    <link rel="stylesheet" href="/static/common.css">

    <style>
        /* Force navbar title styling */
        nav.top a:first-child {
            display: flex !important;
            flex-direction: column !important;
        }
    </style>

    <script>
        // Force light theme after material-dynamic-colors loads
        document.addEventListener('DOMContentLoaded', function () {
            // Set light theme immediately
            document.documentElement.setAttribute('data-theme', 'light');
            document.body.setAttribute('data-theme', 'light');

            // Force light theme colors
            document.documentElement.style.setProperty('--background', '#fdfcf5');
            document.documentElement.style.setProperty('--on-background', '#1b1c18');
            document.documentElement.style.setProperty('--surface', '#fafaf2');
            document.documentElement.style.setProperty('--on-surface', '#1b1c18');

            // Ensure navbar styling is applied
            const navTitle = document.querySelector('nav.top a:first-child');
            if (navTitle) {
                navTitle.style.display = 'flex';
                navTitle.style.flexDirection = 'column';
            }
        });

        // Also force theme after a short delay to override any dynamic loading
        setTimeout(function () {
            document.documentElement.setAttribute('data-theme', 'light');
            document.body.setAttribute('data-theme', 'light');
            document.documentElement.style.setProperty('--background', '#fdfcf5');
            document.documentElement.style.setProperty('--on-background', '#1b1c18');
        }, 100);
    </script>
</head>

<body class="light">
    {{template "navbar" .}}
    {{template "snackbar" .}}

    <!-- Main Content -->
    <main class="responsive">
        <!-- Hero Section -->
        <header class="center-align">
            <h3>QUAERO</h3>
            <p>Knowledge collection and semantic search system with vector embeddings and offline LLM support. Secure data extraction from Jira, Confluence, and GitHub with local-first architecture.</p>
        </header>

        <article class="border">
            <header>
                <nav>
                    <h5>Section Title Goes Here</h5>

                    <div class="max"></div>

                    <button class="small-round primary">
                        <i>edit</i>
                    </button>
                    <button class="small-round secondary">
                        <i>settings</i>
                    </button>
                </nav>
            </header>

            <div class="padding-20">
                <p>This is the content area of the section. It can hold forms, text, or other components.</p>
                <div class="field border suffix">
                    <input type="text" placeholder="Example Input">
                    <i>check</i>
                </div>
            </div>
        </article>

        <!-- Parser Status Section -->
        <article class="border">
            <header>
                <nav>
                    <h5>Parser Status</h5>
                    <div class="max"></div>
                    <button id="refresh-parser-status" class="primary" hx-get="/ui/parser-status" hx-target="#parser-status-table" hx-swap="innerHTML" hx-trigger="click, load, every 60s" hx-sync="this:abort">
                        REFRESH
                    </button>
                </nav>
            </header>

            <div class="padding-20">
                <p class="font-mono font-large text-secondary mb-20 text-center">
                    Install Chrome extension and click icon when logged into Jira/Confluence<br>
                    Extension will capture authentication and trigger scraping automatically
                </p>

                <div class="scroll">
                    <table class="border">
                        <thead>
                            <tr>
                                <th>COMPONENT</th>
                                <th>STATUS</th>
                                <th>LAST UPDATED</th>
                                <th>DETAILS</th>
                            </tr>
                        </thead>
                        <tbody id="parser-status-table">
                            <tr>
                                <td colspan="4" class="status-loading">Loading parser status...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </article>

        <!-- Authentication Details Section -->
        <article class="border">
            <header>
                <nav>
                    <h5>Authentication Details</h5>
                </nav>
            </header>

            <div id="auth-details" class="padding-20">
                <div class="scroll">
                    <table class="border">
                        <thead>
                            <tr>
                                <th>PROPERTY</th>
                                <th>VALUE</th>
                            </tr>
                        </thead>
                        <tbody id="auth-summary-table">
                            <tr>
                                <td colspan="2" class="status-loading">No authentication data captured yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="auth-cookies-section" style="margin-top: var(--card-spacing); display: none;">
                    <h6 style="margin-bottom: 10px;">Authentication Cookies</h6>
                    <div class="scroll">
                        <table class="border">
                            <thead>
                                <tr>
                                    <th>NAME</th>
                                    <th>DOMAIN</th>
                                    <th>PATH</th>
                                    <th>SECURE</th>
                                </tr>
                            </thead>
                            <tbody id="auth-cookies-table">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </article>

        {{template "service-logs" .}}

    </main>

    {{template "footer" .}}

    <script>
        // Index page specific functions for auth and status updates
        // WebSocket connections are handled by navbar and service-logs partials

        function updateStatus(status) {
            const statusTable = document.getElementById('service-status-table');
            if (statusTable) {
                statusTable.innerHTML = `
                    <tr>
                        <td class="status-label">Parser Service</td>
                        <td class="status-value status-online">${status.status}</td>
                    </tr>
                    <tr>
                        <td class="status-label">Database</td>
                        <td class="status-value status-online">${status.database}</td>
                    </tr>
                    <tr>
                        <td class="status-label">Extension Auth</td>
                        <td class="status-value">${status.extensionAuth}</td>
                    </tr>
                `;
            }

            // Parser status updates are now handled by HTMX refresh button
            // No need to update parser-status div from WebSocket
        }


        function updateAuthDetails(authData) {
            const authSummaryTable = document.getElementById('auth-summary-table');
            const authCookiesTable = document.getElementById('auth-cookies-table');
            const authCookiesSection = document.getElementById('auth-cookies-section');

            if (!authSummaryTable) return;

            if (!authData || !authData.cookies || authData.cookies.length === 0) {
                authSummaryTable.innerHTML = `
                    <tr>
                        <td colspan="2" class="status-loading">No authentication data captured yet</td>
                    </tr>
                `;
                if (authCookiesSection) {
                    authCookiesSection.style.display = 'none';
                }
                return;
            }

            // Update summary table
            authSummaryTable.innerHTML = `
                <tr>
                    <td><strong>BASE URL</strong></td>
                    <td>${authData.baseUrl || 'N/A'}</td>
                </tr>
                <tr>
                    <td><strong>CLOUD ID</strong></td>
                    <td>${authData.cloudId || 'N/A'}</td>
                </tr>
                <tr>
                    <td><strong>COOKIES COUNT</strong></td>
                    <td>${authData.cookies.length}</td>
                </tr>
            `;

            // Update cookies table
            if (authCookiesTable && authCookiesSection) {
                let cookiesHtml = '';
                authData.cookies.forEach(cookie => {
                    cookiesHtml += `
                        <tr>
                            <td style="word-break: break-all;">${cookie.name}</td>
                            <td>${cookie.domain}</td>
                            <td>${cookie.path}</td>
                            <td class="center-align">${cookie.secure ? '<span class="chip success">✓</span>' : '<span class="chip error">✗</span>'}</td>
                        </tr>
                    `;
                });
                authCookiesTable.innerHTML = cookiesHtml;
                authCookiesSection.style.display = 'block';
            }
        }

        // WebSocket for index page specific data (status table and auth details)
        let indexDataWs;
        let indexDataReconnectInterval;

        function connectIndexDataWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;

            indexDataWs = new WebSocket(wsUrl);

            indexDataWs.onopen = function () {
                console.log('Index data WebSocket connected');
                if (indexDataReconnectInterval) {
                    clearInterval(indexDataReconnectInterval);
                    indexDataReconnectInterval = null;
                }
            };

            indexDataWs.onmessage = function (event) {
                const message = JSON.parse(event.data);
                if (message.type === 'status') {
                    updateStatus(message.payload);
                } else if (message.type === 'auth') {
                    updateAuthDetails(message.payload);
                }
                // Note: navbar handles system status, service-logs handles log messages
            };

            indexDataWs.onerror = function (error) {
                console.error('Index data WebSocket error:', error);
            };

            indexDataWs.onclose = function () {
                console.log('Index data WebSocket disconnected');
                if (!indexDataReconnectInterval) {
                    indexDataReconnectInterval = setInterval(connectIndexDataWebSocket, 3000);
                }
            };
        }

        // Connect on page load
        document.addEventListener('DOMContentLoaded', function () {
            connectIndexDataWebSocket();
        });
    </script>
</body>

</html>