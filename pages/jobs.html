<!DOCTYPE html>
<html lang="en">

<head>
    {{template "head.html" .}}
    <title>Job Management - Quaero</title>
</head>

<body>

    {{template "navbar.html" .}}

    <div class="container-fluid mt-4">

        <!-- Heading Section -->
        <div class="row">
            <div class="cell-12 p-2">
                <h1 class="text-bold">Job Management</h1>
                <p class="text-leader">Monitor and manage crawler jobs for Jira and Confluence data collection</p>
            </div>
        </div>

        <!-- Job Statistics -->
        <div class="row mt-4">
            <div class="cell-12">
                <div class="panel">
                    <div class="panel-header">
                        <div class="d-flex flex-justify-between flex-align-center">
                            <h6 class="m-0">Job Statistics</h6>
                            <div class="d-flex flex-gap-2">
                                <button class="button info small outline" onclick="showCreateJobModal()">
                                    <span class="icon"><i class="fa-solid fa-plus"></i></span>
                                    <span>Create Job</span>
                                </button>
                                <button class="button small outline" onclick="loadStats()">
                                    <span class="icon"><i class="fa-solid fa-rotate-right"></i></span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="panel-content">
                        <div class="d-flex flex-justify-around flex-align-center flex-gap-2" style="flex-wrap: nowrap;">
                            <div class="text-center">
                                <p class="text-small text-muted">TOTAL JOBS</p>
                                <p class="text-bold h3" id="stat-total">-</p>
                            </div>
                            <div class="text-center">
                                <p class="text-small text-muted">PENDING</p>
                                <p class="text-bold h3 fg-orange" id="stat-pending">-</p>
                            </div>
                            <div class="text-center">
                                <p class="text-small text-muted">RUNNING</p>
                                <p class="text-bold h3 fg-cyan" id="stat-running">-</p>
                            </div>
                            <div class="text-center">
                                <p class="text-small text-muted">COMPLETED</p>
                                <p class="text-bold h3 fg-green" id="stat-completed">-</p>
                            </div>
                            <div class="text-center">
                                <p class="text-small text-muted">FAILED</p>
                                <p class="text-bold h3 fg-red" id="stat-failed">-</p>
                            </div>
                            <div class="text-center">
                                <p class="text-small text-muted">CANCELLED</p>
                                <p class="text-bold h3 fg-orange" id="stat-cancelled">-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Default Jobs -->
        <div class="row mt-4">
            <div class="cell-12">
                <div class="panel">
                    <div class="panel-header">
                        <div class="d-flex flex-justify-between flex-align-center">
                            <h6 class="m-0">Default Jobs</h6>
                            <button class="button small outline" onclick="loadDefaultJobs()" title="Refresh Default Jobs">
                                <span class="icon"><i class="fa-solid fa-rotate-right"></i></span>
                            </button>
                        </div>
                    </div>
                    <div class="panel-content">
                        <table class="table striped border">
                            <thead>
                                <tr>
                                    <th>JOB NAME</th>
                                    <th>DESCRIPTION</th>
                                    <th>SCHEDULE</th>
                                    <th class="text-center">STATUS</th>
                                    <th>LAST RUN</th>
                                    <th>NEXT RUN</th>
                                    <th class="text-center">ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody id="default-jobs-table-body">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        Loading default jobs...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Crawler Jobs -->
        <div class="row mt-4">
            <div class="cell-12">
                <div class="panel">
                    <div class="panel-header">
                        <div class="d-flex flex-justify-between flex-align-center">
                            <h6 class="m-0">
                                <span id="job-count" class="text-muted mr-2">0</span>Crawler Jobs
                            </h6>
                            <button class="button small outline" onclick="loadJobs()" title="Refresh Jobs">
                                <span class="icon"><i class="fa-solid fa-rotate-right"></i></span>
                            </button>
                        </div>
                    </div>
                    <div class="panel-content">
                        <!-- Filter Controls -->
                        <div class="row mb-4">
                            <div class="cell-4">
                                <select data-role="select" class="input" id="status-filter" onchange="filterJobs()">
                                    <option value="">All Statuses</option>
                                    <option value="pending">Pending</option>
                                    <option value="running">Running</option>
                                    <option value="completed">Completed</option>
                                    <option value="failed">Failed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div class="cell-4">
                                <select data-role="select" class="input" id="source-filter" onchange="filterJobs()">
                                    <option value="">All Sources</option>
                                    <option value="jira">Jira</option>
                                    <option value="confluence">Confluence</option>
                                </select>
                            </div>
                            <div class="cell-4">
                                <select data-role="select" class="input" id="entity-filter" onchange="filterJobs()">
                                    <option value="">All Entity Types</option>
                                    <option value="projects">Projects</option>
                                    <option value="spaces">Spaces</option>
                                    <option value="repos">Repos</option>
                                </select>
                            </div>
                        </div>

                        <!-- Jobs Table -->
                        <table class="table striped border">
                            <thead>
                                <tr>
                                    <th>JOB ID</th>
                                    <th>SOURCE</th>
                                    <th>ENTITY</th>
                                    <th class="text-center">STATUS</th>
                                    <th>PROGRESS</th>
                                    <th>CREATED</th>
                                    <th class="text-center">ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody id="jobs-table-body">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        Loading jobs...
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- Pagination Controls -->
                        <div class="d-flex flex-justify-center mt-4">
                            <ul id="job-pagination" data-role="pagination"
                                data-length="7"
                                data-total="1"
                                data-current="1"
                                data-on-page-click="onJobPaginationPageClick"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Job Detail -->
        <div class="row mt-4">
            <div class="cell-12">
                <div class="panel">
                    <div class="panel-header">
                        <div class="d-flex flex-justify-between flex-align-center">
                            <h6 class="m-0">Job Detail</h6>
                            <span id="selected-job-id" class="badge info"></span>
                        </div>
                    </div>
                    <div class="panel-content">
                        <pre id="job-detail-json"><code class="language-json"></code></pre>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="cell-12">
                {{template "service-logs.html" .}}
            </div>
        </div>

    </div>

    {{template "footer.html" .}}

    {{template "snackbar.html" .}}

    <!-- Create Job Modal -->
    <div id="create-job-modal" data-role="dialog" data-overlay="true" style="width: 600px; max-width: 90%;">
        <div class="dialog-title">Create New Job</div>
        <div class="dialog-content">
                <form id="create-job-form">
                    <!-- Source Selection -->
                    <div class="form-group mb-4">
                        <label>Source</label>
                        <select data-role="select" class="input" id="job-source-select" required>
                            <option value="">Select a source...</option>
                        </select>
                        <small class="text-muted">Select the data source for this job</small>
                    </div>

                    <!-- Refresh Source Checkbox -->
                    <div class="form-group mb-4">
                        <label class="checkbox">
                            <input type="checkbox" id="refresh-source-checkbox">
                            <span class="check"></span>
                            <span class="caption">Refresh source configuration before execution</span>
                        </label>
                        <small class="text-muted">If checked, the job will fetch the latest source configuration before starting</small>
                    </div>

                    <!-- Optional Seed URLs -->
                    <div class="form-group mb-4">
                        <label>Seed URLs (Optional)</label>
                        <textarea data-role="textarea" id="seed-urls-textarea" class="input" placeholder="https://example.atlassian.net/rest/api/3/project&#10;https://example.atlassian.net/rest/api/space" rows="3"></textarea>
                        <small class="text-muted">One URL per line. Leave empty to derive from source configuration</small>
                    </div>

                    <!-- Loading State -->
                    <div id="modal-loading" style="display: none;" class="text-center p-3">
                        <span class="icon">
                            <i class="fas fa-spinner fa-pulse fa-2x"></i>
                        </span>
                        <p class="mt-2">Creating job...</p>
                    </div>
                </form>
        </div>
        <div class="dialog-actions">
            <button type="button" class="button" onclick="closeCreateJobModal()">Cancel</button>
            <button type="submit" class="button info" onclick="createJobFromSource(event)">Create Job</button>
        </div>
    </div>

    <script>
        // State management
        let allJobs = [];
        let filteredJobs = [];
        let selectedJob = null;
        let currentPage = 1;
        let totalJobs = 0;
        const pageSize = 50;
        let autoRefreshInterval = null;

        // Load job statistics
        async function loadStats(button) {
            let statsBtn = null;

            if (button) {
                statsBtn = button;
            } else if (typeof event !== 'undefined' && event && event.target && typeof event.target.closest === 'function') {
                statsBtn = event.target.closest('button');
            }

            let originalIcon = null;
            if (statsBtn) {
                statsBtn.disabled = true;
                const iconElement = statsBtn.querySelector('.icon i');
                if (iconElement) {
                    originalIcon = iconElement.className;
                    iconElement.className = 'fas fa-spinner fa-pulse';
                }
            }

            try {
                const response = await fetch('/api/jobs/stats');
                if (!response.ok) {
                    throw new Error('Failed to fetch stats');
                }

                const stats = await response.json();

                document.getElementById('stat-total').textContent = stats.total_jobs || 0;
                document.getElementById('stat-pending').textContent = stats.pending_jobs || 0;
                document.getElementById('stat-running').textContent = stats.running_jobs || 0;
                document.getElementById('stat-completed').textContent = stats.completed_jobs || 0;
                document.getElementById('stat-failed').textContent = stats.failed_jobs || 0;
                document.getElementById('stat-cancelled').textContent = stats.cancelled_jobs || 0;

            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('stat-total').textContent = 'Error';
                document.getElementById('stat-running').textContent = 'Error';
                document.getElementById('stat-completed').textContent = 'Error';
                document.getElementById('stat-failed').textContent = 'Error';
                document.getElementById('stat-cancelled').textContent = 'Error';
            } finally {
                if (statsBtn) {
                    statsBtn.disabled = false;
                    const iconElement = statsBtn.querySelector('.icon i');
                    if (iconElement && originalIcon) {
                        iconElement.className = originalIcon;
                    }
                }
            }
        }

        // Load all jobs
        async function loadJobs() {
            const tbody = document.getElementById('jobs-table-body');

            try {
                // Build query parameters from filters
                const params = new URLSearchParams();
                params.append('limit', pageSize);
                params.append('offset', (currentPage - 1) * pageSize);
                params.append('order_by', 'created_at');
                params.append('order_dir', 'DESC');

                const statusFilter = document.getElementById('status-filter').value;
                const sourceFilter = document.getElementById('source-filter').value;
                const entityFilter = document.getElementById('entity-filter').value;

                if (statusFilter) params.append('status', statusFilter);
                if (sourceFilter) params.append('source', sourceFilter);
                if (entityFilter) params.append('entity', entityFilter);

                const response = await fetch(`/api/jobs?${params.toString()}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch jobs');
                }

                const data = await response.json();
                allJobs = data.jobs || [];
                totalJobs = data.total_count || 0;
                filteredJobs = [...allJobs];

                renderJobs();

            } catch (error) {
                console.error('Error loading jobs:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center fg-red">
                            Failed to load jobs. Please try again.
                        </td>
                    </tr>
                `;
            }
        }

        // Filter jobs based on dropdowns
        function filterJobs() {
            currentPage = 1; // Reset to first page when filtering
            loadJobs(); // Reload with new filters
        }

        // Render jobs table
        function renderJobs() {
            const tbody = document.getElementById('jobs-table-body');
            const countElement = document.getElementById('document-count');
            const totalPages = Math.max(1, Math.ceil(totalJobs / pageSize));

            // Update count display
            if (countElement) {
                countElement.textContent = `${totalJobs}`;
            }
            document.getElementById('job-count').textContent = `${totalJobs}`;

            // Update Metro pagination
            const paginationElement = document.getElementById('job-pagination');
            if (paginationElement && typeof Metro !== 'undefined' && Metro.getPlugin) {
                const pagination = Metro.getPlugin(paginationElement, 'pagination');
                if (pagination) {
                    pagination.options.total = totalPages;
                    pagination.options.current = currentPage;
                    pagination.drawPagination();
                }
            }

            if (!filteredJobs || filteredJobs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">
                            No jobs found matching the current filters.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredJobs.map((job, index) => {
                const statusBadge = getStatusBadge(job.status);
                const progressText = getProgressText(job);
                const createdDate = job.created_at ? new Date(job.created_at).toLocaleString() : 'N/A';
                const isSelected = selectedJob && selectedJob.id === job.id;
                const jobIdShort = job.id ? job.id.substring(0, 8) : 'N/A';

                return `
                    <tr class="${isSelected ? 'bg-light' : ''}" onclick="selectJob(${index})" style="cursor: pointer;">
                        <td title="${job.id || 'N/A'}">${jobIdShort}...</td>
                        <td>${job.source_type || 'N/A'}</td>
                        <td>${job.entity_type || 'N/A'}</td>
                        <td class="text-center">${statusBadge}</td>
                        <td>${progressText}</td>
                        <td>${createdDate}</td>
                        <td class="text-center">
                            <button class="button small outline mr-1" onclick="event.stopPropagation(); rerunJob('${job.id}')" title="Rerun Job">
                                <span class="icon"><i class="fa-solid fa-rotate-right"></i></span>
                            </button>
                            ${job.status === 'running' ? `
                            <button class="button warning small outline mr-1" onclick="event.stopPropagation(); cancelJob('${job.id}')" title="Cancel Job">
                                <span class="icon"><i class="fas fa-stop"></i></span>
                            </button>
                            ` : ''}
                            ${job.status !== 'running' ? `
                            <button class="button danger small outline" onclick="event.stopPropagation(); deleteJob('${job.id}')" title="Delete Job">
                                <span class="icon"><i class="fas fa-trash"></i></span>
                            </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Get status badge HTML
        function getStatusBadge(status) {
            const badges = {
                'pending': '<span class="badge warning">Pending</span>',
                'running': '<span class="badge info">Running</span>',
                'completed': '<span class="badge success">Completed</span>',
                'failed': '<span class="badge danger">Failed</span>',
                'cancelled': '<span class="badge">Cancelled</span>'
            };
            return badges[status] || '<span class="badge">Unknown</span>';
        }

        // Get progress text
        function getProgressText(job) {
            if (!job.progress) return 'N/A';

            const progress = typeof job.progress === 'string' ? JSON.parse(job.progress) : job.progress;

            if (progress.percentage !== undefined) {
                return `${Math.round(progress.percentage)}%`;
            }

            if (progress.completed_urls !== undefined && progress.total_urls !== undefined) {
                return `${progress.completed_urls}/${progress.total_urls} URLs`;
            }

            return 'N/A';
        }

        // Metro pagination callback
        function onJobPaginationPageClick(pageNumber) {
            currentPage = pageNumber;
            loadJobs();
        }

        // Select and display job details
        function selectJob(index) {
            selectedJob = filteredJobs[index];
            displayJobDetail(selectedJob);
            renderJobs();
        }

        function displayJobDetail(job) {
            const selectedId = document.getElementById('selected-job-id');
            const detailPre = document.getElementById('job-detail-json');
            const codeBlock = detailPre.querySelector('code');

            if (!job) {
                selectedId.textContent = '';
                codeBlock.textContent = '';
                return;
            }

            selectedId.textContent = job.id || 'Unknown';
            const jsonString = JSON.stringify(job, null, 2);
            codeBlock.textContent = jsonString;

            if (typeof hljs !== 'undefined') {
                hljs.highlightElement(codeBlock);
            }
        }

        // Rerun a job
        async function rerunJob(jobId) {
            if (!confirm(`Rerun job ${jobId.substring(0, 8)}?\n\nThis will create a new job with the same configuration.`)) {
                return;
            }

            let button = null;
            if (typeof event !== 'undefined' && event && event.target && typeof event.target.closest === 'function') {
                button = event.target.closest('button');
            }

            let originalIcon = null;
            if (button) {
                button.disabled = true;
                const iconElement = button.querySelector('.icon i');
                if (iconElement) {
                    originalIcon = iconElement.className;
                    iconElement.className = 'fas fa-spinner fa-pulse';
                }
            }

            try {
                const response = await fetch(`/api/jobs/${jobId}/rerun`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('Failed to rerun job');
                }

                const result = await response.json();
                alert(`Job rerun started successfully!\nNew Job ID: ${result.new_job_id}`);
                setTimeout(() => {
                    loadStats();
                    loadJobs();
                }, 1000);
            } catch (error) {
                console.error('Error rerunning job:', error);
                alert('Failed to rerun job: ' + error.message);
            } finally {
                if (button) {
                    button.disabled = false;
                    const iconElement = button.querySelector('.icon i');
                    if (iconElement && originalIcon) {
                        iconElement.className = originalIcon;
                    }
                }
            }
        }

        // Cancel a running job
        async function cancelJob(jobId) {
            if (!confirm(`Cancel job ${jobId.substring(0, 8)}?\n\nThe job will be stopped immediately.`)) {
                return;
            }

            let button = null;
            if (typeof event !== 'undefined' && event && event.target && typeof event.target.closest === 'function') {
                button = event.target.closest('button');
            }

            let originalIcon = null;
            if (button) {
                button.disabled = true;
                const iconElement = button.querySelector('.icon i');
                if (iconElement) {
                    originalIcon = iconElement.className;
                    iconElement.className = 'fas fa-spinner fa-pulse';
                }
            }

            try {
                const response = await fetch(`/api/jobs/${jobId}/cancel`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('Failed to cancel job');
                }

                alert('Job cancelled successfully');
                setTimeout(() => {
                    loadStats();
                    loadJobs();
                }, 1000);
            } catch (error) {
                console.error('Error cancelling job:', error);
                alert('Failed to cancel job: ' + error.message);
            } finally {
                if (button) {
                    button.disabled = false;
                    const iconElement = button.querySelector('.icon i');
                    if (iconElement && originalIcon) {
                        iconElement.className = originalIcon;
                    }
                }
            }
        }

        // Delete a job
        async function deleteJob(jobId) {
            if (!confirm(`Delete job ${jobId.substring(0, 8)}?\n\nThis will permanently remove the job from the database.`)) {
                return;
            }

            let button = null;
            if (typeof event !== 'undefined' && event && event.target && typeof event.target.closest === 'function') {
                button = event.target.closest('button');
            }

            let originalIcon = null;
            if (button) {
                button.disabled = true;
                const iconElement = button.querySelector('.icon i');
                if (iconElement) {
                    originalIcon = iconElement.className;
                    iconElement.className = 'fas fa-spinner fa-pulse';
                }
            }

            try {
                const response = await fetch(`/api/jobs/${jobId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Failed to delete job');
                }

                alert('Job deleted successfully');
                setTimeout(() => {
                    loadStats();
                    loadJobs();
                }, 1000);
            } catch (error) {
                console.error('Error deleting job:', error);
                alert('Failed to delete job: ' + error.message);
            } finally {
                if (button) {
                    button.disabled = false;
                    const iconElement = button.querySelector('.icon i');
                    if (iconElement && originalIcon) {
                        iconElement.className = originalIcon;
                    }
                }
            }
        }

        // Auto-refresh for running jobs
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }

            autoRefreshInterval = setInterval(() => {
                // Check if there are any running jobs
                const hasRunningJobs = allJobs.some(job => job.status === 'running');
                if (hasRunningJobs) {
                    loadJobs(); // Silently refresh
                    loadStats(); // Update stats
                    loadJobQueue(); // Update queue data
                    loadDefaultJobs(); // Update default jobs status
                }
            }, 5000); // Refresh every 5 seconds
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            loadStats();
            loadJobs();
            loadJobQueue(); // Load queue data on initial page load
            loadDefaultJobs(); // Load default jobs on initial page load
            startAutoRefresh();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function () {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        });

        // Ensure Alpine.js is fully initialized
        document.addEventListener('alpine:init', function () {
            console.log('[Jobs] Alpine.js initialized');
        });

        // Initialize highlight.js - only for job detail, not service logs
        if (typeof hljs !== 'undefined') {
            const codeBlock = document.querySelector('#job-detail-json code');
            if (codeBlock) {
                hljs.highlightElement(codeBlock);
            }
        }

        // Job creation modal functions
        async function showCreateJobModal() {
            const modal = document.getElementById('create-job-modal');
            modal.classList.add('open');
            await loadSourcesForJobCreation();
        }

        function closeCreateJobModal() {
            const modal = document.getElementById('create-job-modal');
            modal.classList.remove('open');
            // Reset form
            document.getElementById('create-job-form').reset();
        }

        async function loadSourcesForJobCreation() {
            const sourceSelect = document.getElementById('job-source-select');

            try {
                const response = await fetch('/api/sources');
                if (!response.ok) {
                    throw new Error('Failed to fetch sources');
                }

                const sources = await response.json();

                // Clear existing options except the first placeholder
                sourceSelect.innerHTML = '<option value="">Select a source...</option>';

                if (!sources || sources.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No sources available - create a source first';
                    option.disabled = true;
                    sourceSelect.appendChild(option);
                    return;
                }

                // Add sources to dropdown
                sources.forEach(source => {
                    const option = document.createElement('option');
                    option.value = source.id;
                    option.textContent = `${source.name} (${source.type})`;
                    option.dataset.sourceType = source.type;
                    sourceSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading sources:', error);
                alert('Failed to load sources: ' + error.message);
            }
        }

        async function createJobFromSource(event) {
            event.preventDefault();

            const sourceSelect = document.getElementById('job-source-select');
            const refreshCheckbox = document.getElementById('refresh-source-checkbox');
            const seedUrlsTextarea = document.getElementById('seed-urls-textarea');
            const modalLoading = document.getElementById('modal-loading');
            const createButton = event.target;

            const sourceID = sourceSelect.value;
            if (!sourceID) {
                alert('Please select a source');
                return;
            }

            const refreshSource = refreshCheckbox.checked;
            const seedUrlsText = seedUrlsTextarea.value.trim();
            const seedURLs = seedUrlsText ? seedUrlsText.split('\n').map(url => url.trim()).filter(url => url) : [];

            // Show loading state
            modalLoading.style.display = 'block';
            createButton.disabled = true;

            let originalIcon = null;
            const iconElement = createButton.querySelector('.icon i');
            if (iconElement) {
                originalIcon = iconElement.className;
                iconElement.className = 'fas fa-spinner fa-pulse';
            }

            try {
                const payload = {
                    source_id: sourceID,
                    refresh_source: refreshSource
                };

                if (seedURLs.length > 0) {
                    payload.seed_urls = seedURLs;
                }

                const response = await fetch('/api/jobs/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                // Show success message
                if (window.showSnackbar) {
                    window.showSnackbar(`Job created successfully! Job ID: ${result.job_id}`, 'success');
                } else {
                    alert(`Job created successfully!\nJob ID: ${result.job_id}`);
                }

                // Close modal and refresh
                closeCreateJobModal();
                setTimeout(() => {
                    loadStats();
                    loadJobs();
                }, 500);

            } catch (error) {
                console.error('Error creating job:', error);
                if (window.showSnackbar) {
                    window.showSnackbar('Failed to create job: ' + error.message, 'error');
                } else {
                    alert('Failed to create job: ' + error.message);
                }
            } finally {
                modalLoading.style.display = 'none';
                createButton.disabled = false;
                if (iconElement && originalIcon) {
                    iconElement.className = originalIcon;
                }
            }
        }

        // Load queue data (optional enhancement)
        async function loadJobQueue() {
            try {
                const response = await fetch('/api/jobs/queue');
                if (!response.ok) {
                    throw new Error('Failed to fetch job queue');
                }

                const queue = await response.json();

                // Update pending and running counts in stats
                document.getElementById('stat-pending').textContent = queue.pending ? queue.pending.length : 0;
                document.getElementById('stat-running').textContent = queue.running ? queue.running.length : 0;

            } catch (error) {
                console.error('Error loading job queue:', error);
            }
        }

        // ===== DEFAULT JOBS MANAGEMENT =====

        // Load default jobs from API
        async function loadDefaultJobs() {
            const tbody = document.getElementById('default-jobs-table-body');

            try {
                const response = await fetch('/api/jobs/default');
                if (!response.ok) {
                    throw new Error('Failed to fetch default jobs');
                }

                const data = await response.json();
                const jobs = data.jobs || [];

                if (jobs.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center">
                                No default jobs configured.
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = jobs.map(job => {
                    const statusBadge = job.enabled
                        ? '<span class="badge success">Enabled</span>'
                        : '<span class="badge">Disabled</span>';

                    const lastRun = job.last_run
                        ? new Date(job.last_run).toLocaleString()
                        : 'Never';

                    const nextRun = job.next_run
                        ? new Date(job.next_run).toLocaleString()
                        : 'N/A';

                    const isRunning = job.is_running;
                    const runningIndicator = isRunning
                        ? '<span class="icon fg-cyan"><i class="fa-solid fa-spinner fa-pulse"></i></span>'
                        : '';

                    return `
                        <tr>
                            <td>
                                ${runningIndicator}
                                <strong>${job.name}</strong>
                            </td>
                            <td>${job.description || 'N/A'}</td>
                            <td><code>${job.schedule}</code></td>
                            <td class="text-center">${statusBadge}</td>
                            <td>${lastRun}</td>
                            <td>${nextRun}</td>
                            <td class="text-center">
                                ${job.enabled ? `
                                <button class="button warning small outline mr-1"
                                        onclick="toggleDefaultJob('${job.name}', false)"
                                        title="Disable Job"
                                        ${isRunning ? 'disabled' : ''}>
                                    <span class="icon"><i class="fa-solid fa-pause"></i></span>
                                </button>
                                ` : `
                                <button class="button success small outline mr-1"
                                        onclick="toggleDefaultJob('${job.name}', true)"
                                        title="Enable Job">
                                    <span class="icon"><i class="fa-solid fa-play"></i></span>
                                </button>
                                `}
                                <button class="button small outline"
                                        onclick="editJobSchedule('${job.name}', '${job.schedule}')"
                                        title="Edit Schedule">
                                    <span class="icon"><i class="fa-solid fa-clock"></i></span>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading default jobs:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center fg-red">
                            Failed to load default jobs. Please try again.
                        </td>
                    </tr>
                `;
            }
        }

        // Toggle default job enabled/disabled status
        async function toggleDefaultJob(jobName, enable) {
            const action = enable ? 'enable' : 'disable';
            const endpoint = `/api/jobs/default/${jobName}/${action}`;

            try {
                const response = await fetch(endpoint, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `Failed to ${action} job`);
                }

                const result = await response.json();

                if (window.showSnackbar) {
                    window.showSnackbar(result.message || `Job ${enable ? 'enabled' : 'disabled'} successfully`, 'success');
                } else {
                    alert(result.message || `Job ${enable ? 'enabled' : 'disabled'} successfully`);
                }

                // Reload default jobs to reflect changes
                setTimeout(() => loadDefaultJobs(), 500);

            } catch (error) {
                console.error(`Error ${action}ing job:`, error);
                if (window.showSnackbar) {
                    window.showSnackbar(`Failed to ${action} job: ` + error.message, 'error');
                } else {
                    alert(`Failed to ${action} job: ` + error.message);
                }
            }
        }

        // Edit job schedule (shows prompt)
        function editJobSchedule(jobName, currentSchedule) {
            const newSchedule = prompt(
                `Edit schedule for "${jobName}"\n\n` +
                `Current schedule: ${currentSchedule}\n\n` +
                `Enter new cron schedule (format: minute hour day month weekday):\n` +
                `Examples:\n` +
                `  */5 * * * *  = Every 5 minutes\n` +
                `  */10 * * * * = Every 10 minutes\n` +
                `  0 * * * *    = Every hour\n` +
                `  0 0 * * *    = Every day at midnight\n\n` +
                `Note: Minimum interval is 5 minutes`,
                currentSchedule
            );

            if (newSchedule && newSchedule !== currentSchedule) {
                updateJobSchedule(jobName, newSchedule);
            }
        }

        // Update job schedule via API
        async function updateJobSchedule(jobName, schedule) {
            const endpoint = `/api/jobs/default/${jobName}/schedule`;

            try {
                const response = await fetch(endpoint, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ schedule: schedule })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to update schedule');
                }

                const result = await response.json();

                if (window.showSnackbar) {
                    window.showSnackbar(result.message || 'Schedule updated successfully', 'success');
                } else {
                    alert(result.message || 'Schedule updated successfully');
                }

                // Reload default jobs to reflect changes
                setTimeout(() => loadDefaultJobs(), 500);

            } catch (error) {
                console.error('Error updating schedule:', error);
                if (window.showSnackbar) {
                    window.showSnackbar('Failed to update schedule: ' + error.message, 'error');
                } else {
                    alert('Failed to update schedule: ' + error.message);
                }
            }
        }
    </script>
</body>

</html>