<!DOCTYPE html>
<html lang="en">
<head>
    {{template "head.html" .}}
    <title>Job Management - Quaero</title>
</head>
<body class="has-navbar-fixed-top">
    <div class="wrapper">
        {{template "navbar.html" .}}

        <section class="section">
        <div class="container">
            <!-- Hero Section -->
            <section class="hero is-primary is-bold">
                <div class="hero-body">
                    <div class="container has-text-centered">
                        <h1 class="title">Job Management</h1>
                        <h2 class="subtitle">Monitor and manage crawler jobs for Jira and Confluence data collection</h2>
                    </div>
                </div>
            </section>

            <!-- Job Statistics -->
            <div class="card mt-5">
                <header class="card-header">
                    <p class="card-header-title">Job Statistics</p>
                    <div class="card-header-icon">
                        <button class="button is-small is-outlined" onclick="loadStats()">
                            <span class="icon"><i class="fa-solid fa-rotate-right"></i></span>
                        </button>
                    </div>
                </header>
                <div class="card-content">
                    <nav class="level">
                        <div class="level-item has-text-centered">
                            <div>
                                <p class="heading">TOTAL JOBS</p>
                                <p class="title" id="stat-total">-</p>
                            </div>
                        </div>
                        <div class="level-item has-text-centered">
                            <div>
                                <p class="heading">RUNNING</p>
                                <p class="title has-text-info" id="stat-running">-</p>
                            </div>
                        </div>
                        <div class="level-item has-text-centered">
                            <div>
                                <p class="heading">COMPLETED</p>
                                <p class="title has-text-success" id="stat-completed">-</p>
                            </div>
                        </div>
                        <div class="level-item has-text-centered">
                            <div>
                                <p class="heading">FAILED</p>
                                <p class="title has-text-danger" id="stat-failed">-</p>
                            </div>
                        </div>
                        <div class="level-item has-text-centered">
                            <div>
                                <p class="heading">CANCELLED</p>
                                <p class="title has-text-warning" id="stat-cancelled">-</p>
                            </div>
                        </div>
                    </nav>
                </div>
            </div>

            <!-- Jobs Table -->
            <div class="card mt-5">
                <header class="card-header">
                    <p class="card-header-title">
                        <span id="job-count" class="has-text-grey mr-2">0</span>Jobs
                    </p>
                    <div class="card-header-icon">
                        <button class="button is-small is-outlined" onclick="loadJobs()">
                            <span class="icon"><i class="fa-solid fa-rotate-right"></i></span>
                        </button>
                    </div>
                </header>
                <div class="card-content">
                    <!-- Filter Controls -->
                    <div class="columns">
                        <div class="column is-3">
                            <div class="field">
                                <div class="control has-icons-left">
                                    <div class="select is-fullwidth">
                                        <select id="status-filter" onchange="filterJobs()">
                                            <option value="">All Statuses</option>
                                            <option value="pending">Pending</option>
                                            <option value="running">Running</option>
                                            <option value="completed">Completed</option>
                                            <option value="failed">Failed</option>
                                            <option value="cancelled">Cancelled</option>
                                        </select>
                                    </div>
                                    <span class="icon is-small is-left"><i class="fas fa-filter"></i></span>
                                </div>
                            </div>
                        </div>
                        <div class="column is-3">
                            <div class="field">
                                <div class="control has-icons-left">
                                    <div class="select is-fullwidth">
                                        <select id="source-filter" onchange="filterJobs()">
                                            <option value="">All Sources</option>
                                            <option value="jira">Jira</option>
                                            <option value="confluence">Confluence</option>
                                        </select>
                                    </div>
                                    <span class="icon is-small is-left"><i class="fas fa-database"></i></span>
                                </div>
                            </div>
                        </div>
                        <div class="column is-3">
                            <div class="field">
                                <div class="control has-icons-left">
                                    <div class="select is-fullwidth">
                                        <select id="entity-filter" onchange="filterJobs()">
                                            <option value="">All Entity Types</option>
                                            <option value="project">Project</option>
                                            <option value="space">Space</option>
                                        </select>
                                    </div>
                                    <span class="icon is-small is-left"><i class="fas fa-folder"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Jobs Table -->
                    <div class="table-container">
                        <table class="table is-fullwidth is-striped is-hoverable">
                            <thead>
                                <tr>
                                    <th>JOB ID</th>
                                    <th>SOURCE</th>
                                    <th>ENTITY</th>
                                    <th class="has-text-centered">STATUS</th>
                                    <th>PROGRESS</th>
                                    <th>CREATED</th>
                                    <th class="has-text-centered">ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody id="jobs-table-body">
                                <tr>
                                    <td colspan="7" class="has-text-centered">
                                        Loading jobs...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination Controls -->
                    <nav class="pagination is-centered mt-4" role="navigation" aria-label="pagination">
                        <button id="prev-page" class="pagination-previous button is-small is-outlined" onclick="previousPage()">Previous</button>
                        <button id="next-page" class="pagination-next button is-small is-outlined" onclick="nextPage()">Next</button>
                        <ul class="pagination-list">
                            <li><span class="pagination-link has-text-grey" id="page-info">Page 1 of 1</span></li>
                        </ul>
                    </nav>
                </div>
            </div>

            <!-- Job Detail -->
            <div class="card mt-5">
                <header class="card-header">
                    <p class="card-header-title">Job Detail</p>
                    <div class="card-header-icon">
                        <span id="selected-job-id" class="tag is-info"></span>
                    </div>
                </header>
                <div class="card-content">
                    <pre id="job-detail-json"><code class="language-json"></code></pre>
                </div>
            </div>

            {{template "service-logs.html" .}}
        </div>
    </section>
    </div>

    <footer class="footer">
        {{template "footer.html" .}}
    </footer>

    {{template "snackbar.html" .}}

    <script>
        // State management
        let allJobs = [];
        let filteredJobs = [];
        let selectedJob = null;
        let currentPage = 1;
        let totalJobs = 0;
        const pageSize = 50;
        let autoRefreshInterval = null;

        // Load job statistics
        async function loadStats(button) {
            let statsBtn = null;

            if (button) {
                statsBtn = button;
            } else if (typeof event !== 'undefined' && event && event.target && typeof event.target.closest === 'function') {
                statsBtn = event.target.closest('button');
            }

            if (statsBtn) {
                statsBtn.disabled = true;
                statsBtn.classList.add('is-loading');
            }

            try {
                const response = await fetch('/api/jobs/stats');
                if (!response.ok) {
                    throw new Error('Failed to fetch stats');
                }

                const stats = await response.json();

                document.getElementById('stat-total').textContent = stats.total_jobs || 0;
                document.getElementById('stat-running').textContent = stats.running_jobs || 0;
                document.getElementById('stat-completed').textContent = stats.completed_jobs || 0;
                document.getElementById('stat-failed').textContent = stats.failed_jobs || 0;
                document.getElementById('stat-cancelled').textContent = stats.cancelled_jobs || 0;

            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('stat-total').textContent = 'Error';
                document.getElementById('stat-running').textContent = 'Error';
                document.getElementById('stat-completed').textContent = 'Error';
                document.getElementById('stat-failed').textContent = 'Error';
                document.getElementById('stat-cancelled').textContent = 'Error';
            } finally {
                if (statsBtn) {
                    statsBtn.disabled = false;
                    statsBtn.classList.remove('is-loading');
                }
            }
        }

        // Load all jobs
        async function loadJobs() {
            const tbody = document.getElementById('jobs-table-body');

            try {
                // Build query parameters from filters
                const params = new URLSearchParams();
                params.append('limit', pageSize);
                params.append('offset', (currentPage - 1) * pageSize);
                params.append('order_by', 'created_at');
                params.append('order_dir', 'DESC');

                const statusFilter = document.getElementById('status-filter').value;
                const sourceFilter = document.getElementById('source-filter').value;
                const entityFilter = document.getElementById('entity-filter').value;

                if (statusFilter) params.append('status', statusFilter);
                if (sourceFilter) params.append('source', sourceFilter);
                if (entityFilter) params.append('entity', entityFilter);

                const response = await fetch(`/api/jobs?${params.toString()}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch jobs');
                }

                const data = await response.json();
                allJobs = data.jobs || [];
                totalJobs = data.total_count || 0;
                filteredJobs = [...allJobs];

                renderJobs();

            } catch (error) {
                console.error('Error loading jobs:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="has-text-centered has-text-danger">
                            Failed to load jobs. Please try again.
                        </td>
                    </tr>
                `;
            }
        }

        // Filter jobs based on dropdowns
        function filterJobs() {
            currentPage = 1; // Reset to first page when filtering
            loadJobs(); // Reload with new filters
        }

        // Render jobs table
        function renderJobs() {
            const tbody = document.getElementById('jobs-table-body');
            const countElement = document.getElementById('document-count');
            const totalPages = Math.max(1, Math.ceil(totalJobs / pageSize));

            // Update count display
            if (countElement) {
                countElement.textContent = `${totalJobs}`;
            }
            document.getElementById('job-count').textContent = `${totalJobs}`;

            // Update pagination controls
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages;
            document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;

            if (!filteredJobs || filteredJobs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="has-text-centered">
                            No jobs found matching the current filters.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredJobs.map((job, index) => {
                const statusBadge = getStatusBadge(job.status);
                const progressText = getProgressText(job);
                const createdDate = job.created_at ? new Date(job.created_at).toLocaleString() : 'N/A';
                const isSelected = selectedJob && selectedJob.id === job.id;
                const jobIdShort = job.id ? job.id.substring(0, 8) : 'N/A';

                return `
                    <tr class="${isSelected ? 'is-selected' : ''}" onclick="selectJob(${index})" style="cursor: pointer;">
                        <td title="${job.id || 'N/A'}">${jobIdShort}...</td>
                        <td>${job.source_type || 'N/A'}</td>
                        <td>${job.entity_type || 'N/A'}</td>
                        <td class="has-text-centered">${statusBadge}</td>
                        <td>${progressText}</td>
                        <td>${createdDate}</td>
                        <td class="has-text-centered">
                            <button class="button is-small is-outlined" onclick="event.stopPropagation(); rerunJob('${job.id}')" title="Rerun Job">
                                <span class="icon"><i class="fa-solid fa-rotate-right"></i></span>
                            </button>
                            ${job.status === 'running' ? `
                            <button class="button is-small is-warning is-outlined" onclick="event.stopPropagation(); cancelJob('${job.id}')" title="Cancel Job">
                                <span class="icon"><i class="fas fa-stop"></i></span>
                            </button>
                            ` : ''}
                            ${job.status !== 'running' ? `
                            <button class="button is-small is-danger is-outlined" onclick="event.stopPropagation(); deleteJob('${job.id}')" title="Delete Job">
                                <span class="icon"><i class="fas fa-trash"></i></span>
                            </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Get status badge HTML
        function getStatusBadge(status) {
            const badges = {
                'pending': '<span class="tag is-warning">Pending</span>',
                'running': '<span class="tag is-info">Running</span>',
                'completed': '<span class="tag is-success">Completed</span>',
                'failed': '<span class="tag is-danger">Failed</span>',
                'cancelled': '<span class="tag">Cancelled</span>'
            };
            return badges[status] || '<span class="tag">Unknown</span>';
        }

        // Get progress text
        function getProgressText(job) {
            if (!job.progress) return 'N/A';

            const progress = typeof job.progress === 'string' ? JSON.parse(job.progress) : job.progress;

            if (progress.percentage !== undefined) {
                return `${Math.round(progress.percentage)}%`;
            }

            if (progress.completed_urls !== undefined && progress.total_urls !== undefined) {
                return `${progress.completed_urls}/${progress.total_urls} URLs`;
            }

            return 'N/A';
        }

        // Pagination functions
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                loadJobs();
            }
        }

        function nextPage() {
            const totalPages = Math.max(1, Math.ceil(totalJobs / pageSize));
            if (currentPage < totalPages) {
                currentPage++;
                loadJobs();
            }
        }

        // Select and display job details
        function selectJob(index) {
            selectedJob = filteredJobs[index];
            displayJobDetail(selectedJob);
            renderJobs();
        }

        function displayJobDetail(job) {
            const selectedId = document.getElementById('selected-job-id');
            const detailPre = document.getElementById('job-detail-json');
            const codeBlock = detailPre.querySelector('code');

            if (!job) {
                selectedId.textContent = '';
                codeBlock.textContent = '';
                return;
            }

            selectedId.textContent = job.id || 'Unknown';
            const jsonString = JSON.stringify(job, null, 2);
            codeBlock.textContent = jsonString;

            if (typeof hljs !== 'undefined') {
                hljs.highlightElement(codeBlock);
            }
        }

        // Rerun a job
        async function rerunJob(jobId) {
            if (!confirm(`Rerun job ${jobId.substring(0, 8)}?\n\nThis will create a new job with the same configuration.`)) {
                return;
            }

            let button = null;
            if (typeof event !== 'undefined' && event && event.target && typeof event.target.closest === 'function') {
                button = event.target.closest('button');
            }

            if (button) {
                button.disabled = true;
                button.classList.add('is-loading');
            }

            try {
                const response = await fetch(`/api/jobs/${jobId}/rerun`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('Failed to rerun job');
                }

                const result = await response.json();
                alert(`Job rerun started successfully!\nNew Job ID: ${result.new_job_id}`);
                setTimeout(() => {
                    loadStats();
                    loadJobs();
                }, 1000);
            } catch (error) {
                console.error('Error rerunning job:', error);
                alert('Failed to rerun job: ' + error.message);
            } finally {
                if (button) {
                    button.disabled = false;
                    button.classList.remove('is-loading');
                }
            }
        }

        // Cancel a running job
        async function cancelJob(jobId) {
            if (!confirm(`Cancel job ${jobId.substring(0, 8)}?\n\nThe job will be stopped immediately.`)) {
                return;
            }

            let button = null;
            if (typeof event !== 'undefined' && event && event.target && typeof event.target.closest === 'function') {
                button = event.target.closest('button');
            }

            if (button) {
                button.disabled = true;
                button.classList.add('is-loading');
            }

            try {
                const response = await fetch(`/api/jobs/${jobId}/cancel`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('Failed to cancel job');
                }

                alert('Job cancelled successfully');
                setTimeout(() => {
                    loadStats();
                    loadJobs();
                }, 1000);
            } catch (error) {
                console.error('Error cancelling job:', error);
                alert('Failed to cancel job: ' + error.message);
            } finally {
                if (button) {
                    button.disabled = false;
                    button.classList.remove('is-loading');
                }
            }
        }

        // Delete a job
        async function deleteJob(jobId) {
            if (!confirm(`Delete job ${jobId.substring(0, 8)}?\n\nThis will permanently remove the job from the database.`)) {
                return;
            }

            let button = null;
            if (typeof event !== 'undefined' && event && event.target && typeof event.target.closest === 'function') {
                button = event.target.closest('button');
            }

            if (button) {
                button.disabled = true;
                button.classList.add('is-loading');
            }

            try {
                const response = await fetch(`/api/jobs/${jobId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Failed to delete job');
                }

                alert('Job deleted successfully');
                setTimeout(() => {
                    loadStats();
                    loadJobs();
                }, 1000);
            } catch (error) {
                console.error('Error deleting job:', error);
                alert('Failed to delete job: ' + error.message);
            } finally {
                if (button) {
                    button.disabled = false;
                    button.classList.remove('is-loading');
                }
            }
        }

        // Auto-refresh for running jobs
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }

            autoRefreshInterval = setInterval(() => {
                // Check if there are any running jobs
                const hasRunningJobs = allJobs.some(job => job.status === 'running');
                if (hasRunningJobs) {
                    loadJobs(); // Silently refresh
                    loadStats(); // Update stats
                }
            }, 5000); // Refresh every 5 seconds
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadJobs();
            startAutoRefresh();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        });

        // Ensure Alpine.js is fully initialized
        document.addEventListener('alpine:init', function() {
            console.log('[Jobs] Alpine.js initialized');
        });

        // Initialize highlight.js - only for job detail, not service logs
        if (typeof hljs !== 'undefined') {
            const codeBlock = document.querySelector('#job-detail-json code');
            if (codeBlock) {
                hljs.highlightElement(codeBlock);
            }
        }
    </script>
</body>
</html>
