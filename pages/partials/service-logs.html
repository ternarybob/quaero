{{define "service-logs"}}

<!-- Service Logs -->
<article class="border no-padding">
    <header>
        <nav>
            <h5 class="max">Service Logs</h5>
            <button class="circle transparent" onclick="refreshServiceLogs()" title="Refresh Logs">
                <i class="material-icons">refresh</i>
            </button>
            <button class="circle transparent" onclick="clearServiceLogs()" title="Clear Logs">
                <i class="material-icons">delete</i>
            </button>
        </nav>
    </header>

    <div class="small-padding">
        <div id="service-logs" class="service-logs-container"></div>
    </div>
</article>

<script>
    // Service logs using shared WebSocket manager
    let displayedLogs = new Set();

    function handleLogMessage(logData) {
        const logsContainer = document.getElementById('service-logs');
        if (!logsContainer) return;

        const logLine = `${logData.timestamp}|${logData.level}|${logData.message}`;

        if (displayedLogs.has(logLine)) return;
        displayedLogs.add(logLine);

        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';

        const timestamp = logData.timestamp || new Date().toLocaleTimeString('en-US', { hour12: false });
        const level = logData.level || 'info';
        const message = logData.message || '';

        let levelClass = 'log-level-info';
        let levelText = 'INFO';
        if (level.toLowerCase() === 'error') {
            levelClass = 'log-level-error';
            levelText = 'ERROR';
        } else if (level.toLowerCase() === 'warn') {
            levelClass = 'log-level-warn';
            levelText = 'WARN';
        } else if (level.toLowerCase() === 'debug') {
            levelClass = 'log-level-debug';
            levelText = 'DEBUG';
        }

        logEntry.innerHTML = `
            <span class="log-timestamp">[${timestamp}]</span>
            <span class="${levelClass}">[${levelText}]</span>
            <span class="log-message">${escapeHtml(message)}</span>
        `;

        logsContainer.appendChild(logEntry);
        logsContainer.scrollTop = logsContainer.scrollHeight;

        // Limit to last 100 entries
        while (logsContainer.children.length > 100) {
            const removed = logsContainer.removeChild(logsContainer.firstChild);
            displayedLogs.delete(removed.textContent);
        }
    }

    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    function clearServiceLogs() {
        const logsContainer = document.getElementById('service-logs');
        if (logsContainer) {
            logsContainer.innerHTML = '';
            displayedLogs.clear();
        }
    }

    function refreshServiceLogs() {
        // Fetch recent logs from API (last 5 minutes)
        fetch('/api/logs/recent')
            .then(response => response.json())
            .then(data => {
                if (data.logs && Array.isArray(data.logs)) {
                    // Clear existing logs
                    clearServiceLogs();
                    // Add fetched logs
                    data.logs.forEach(logData => handleLogMessage(logData));
                }
            })
            .catch(error => {
                console.error('Failed to refresh service logs:', error);
            });
    }


    // Subscribe to log messages on page load
    document.addEventListener('DOMContentLoaded', function () {
        if (typeof WebSocketManager !== 'undefined') {
            // Subscribe to log messages
            WebSocketManager.subscribe('log', handleLogMessage);

            // Subscribe to connection status changes
            // This will immediately call updateLogsWSStatus with current connection state

            console.log('[Service Logs] WebSocket subscriptions established');
        } else {
            console.error('[Service Logs] WebSocketManager not loaded');
        }

        // Load service logs on page load (past 5 minutes)
        refreshServiceLogs();
    });
</script>
{{end}}