<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quaero - Settings</title>

    <!-- Material Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    <!-- Beer CSS -->
    <link href="https://cdn.jsdelivr.net/npm/beercss@3.12.11/dist/cdn/beer.min.css" rel="stylesheet">
    <script type="module" src="https://cdn.jsdelivr.net/npm/beercss@3.12.11/dist/cdn/beer.min.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    
    <!-- WebSocket Manager -->
    <script src="/static/websocket-manager.js"></script>
    
    <!-- Quaero Theme -->
    <link rel="stylesheet" href="/static/common.css">

</head>
<body class="light">
    {{template "navbar" .}}
    {{template "snackbar" .}}

    <!-- Main Content -->
    <main class="responsive">
        <!-- Hero Section -->
        <header class="center-align">
            <h3>Settings</h3>
            <p>System configuration and operational controls</p>
        </header>
        
        {{template "service-status" .}}

        <!-- Full Configuration Table -->
        <article class="border">
            <header>
                <nav>
                    <h5>System Configuration (Read-Only)</h5>
                    <div class="max"></div>
                    <button class="circle transparent" onclick="loadConfig()"><i class="material-icons">refresh</i></button>
                </nav>
            </header>
            <div style="padding: 20px;">
                <div class="scroll">
                    <table class="border">
                        <thead>
                            <tr>
                                <th style="width: 30%;">Section</th>
                                <th style="width: 35%;">Setting</th>
                                <th style="width: 35%;">Value</th>
                            </tr>
                        </thead>
                        <tbody id="config-table-body">
                            <tr>
                                <td colspan="3" style="text-align: center; padding: 20px; color: #6a6a6a;">
                                    Loading configuration...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </article>

        <!-- Danger Zone -->
        <article class="border danger-zone-card">
            <header>
                <nav>
                    <h5 style="color: #cc0000;">⚠ Danger Zone</h5>
                </nav>
            </header>
            <div style="padding: 20px;">
                <div class="danger-zone-section">
                    <div>
                        <div class="danger-zone-title">Clear All Documents</div>
                        <div class="danger-zone-description">
                            Deletes ALL documents from the collection database. This will remove all indexed content from Jira and Confluence.
                            Source data (Jira projects/issues and Confluence spaces/pages) will remain and can be re-synced.
                        </div>
                    </div>
                    <button class="btn-danger" onclick="confirmRemoveEmbeddings()">CLEAR ALL</button>
                </div>
            </div>
        </article>

        {{template "service-logs" .}}

    </main>

    {{template "footer" .}}


    <script>

        // Load system configuration (placeholder - needs backend endpoint)
        async function loadConfig() {
            // TODO: Implement /api/config endpoint
            // Mock configuration data matching TOML structure
            const config = {
                server: {
                    host: 'localhost',
                    port: 8085,
                    llama_dir: './llama'
                },
                'sources.confluence': {
                    enabled: true,
                    spaces: ['TEAM', 'DOCS']
                },
                'sources.jira': {
                    enabled: true,
                    projects: ['DATA', 'ENG']
                },
                llm: {
                    mode: 'offline'
                },
                'llm.offline': {
                    model_dir: './models',
                    embed_model: 'nomic-embed-text-v1.5.Q8_0.gguf',
                    chat_model: 'qwen2.5-7b-instruct-q4_k_m.gguf',
                    context_size: 2048,
                    thread_count: 4,
                    gpu_layers: 0
                },
                'llm.audit': {
                    enabled: true,
                    log_queries: false
                }
            };

            // Populate configuration table
            const tbody = document.getElementById('config-table-body');
            tbody.innerHTML = '';

            for (const [section, values] of Object.entries(config)) {
                if (typeof values === 'object' && !Array.isArray(values)) {
                    let firstRow = true;
                    for (const [key, value] of Object.entries(values)) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="section-cell">${firstRow ? '[' + section + ']' : ''}</td>
                            <td>${key}</td>
                            <td class="value-cell">${Array.isArray(value) ? JSON.stringify(value) : value}</td>
                        `;
                        tbody.appendChild(row);
                        firstRow = false;
                    }
                } else {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="section-cell">[${section}]</td>
                        <td>-</td>
                        <td class="value-cell">${values}</td>
                    `;
                    tbody.appendChild(row);
                }
            }

        }

        // Confirm and remove all embeddings
        async function confirmRemoveEmbeddings() {
            const confirmed = confirm(
                '⚠ WARNING: This will delete ALL documents from the collection database.\n\n' +
                'This will remove all indexed content from Jira and Confluence.\n' +
                'Source data (Jira projects/issues and Confluence spaces/pages) will remain and can be re-synced.\n\n' +
                'Continue?'
            );

            if (!confirmed) return;

            try {
                const response = await fetch('/api/embeddings', {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Failed to clear documents');
                }

                const result = await response.json();
                alert(`Success: ${result.message}\n\nDocuments deleted: ${result.documents_affected}`);
            } catch (error) {
                console.error('Error clearing documents:', error);
                alert('Failed to clear documents: ' + error.message);
            }
        }


        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
        });
    </script>
</body>
</html>
