<!DOCTYPE html>
<html lang="en">

<head>
    {{template "head.html" .}}
    <title>Settings - Quaero</title>
</head>

<body>

    {{template "navbar.html" .}}

    <main class="page-container">

        <!-- Page Title -->
        <div class="page-title">
            <h1>Settings</h1>
            <p>System configuration and operational controls</p>
        </div>

        <!-- Full Configuration Table -->
        <section>
            <div class="card">
                <div class="card-header">
                    <header class="navbar">
                        <section class="navbar-section">
                            <h2>System Configuration (Read-Only)</h2>
                        </section>
                        <section class="navbar-section">
                            <button class="btn btn-sm" onclick="loadConfig()">
                                <i class="fa-solid fa-rotate-right"></i>
                            </button>
                        </section>
                    </header>
                </div>
                <div class="card-body">
                        <table class="table striped border">
                            <thead>
                                <tr>
                                    <th>Section</th>
                                    <th>Setting</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody id="config-table-body">
                                <tr>
                                    <td colspan="3" class="text-center text-muted">
                                        Loading configuration...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Danger Zone -->
        <section style="margin-top: 1.5rem;">
            <div class="card">
                <div class="card-header">
                    <h2 style="color: var(--color-danger);">Danger Zone</h2>
                </div>
                <div class="card-body">
                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap;">
                        <div>
                            <p style="font-weight: bold;">Clear All Documents</p>
                            <p>
                                Deletes ALL documents from the collection database. This will remove all indexed content from Jira and Confluence.
                                Source data (Jira projects/issues and Confluence spaces/pages) will remain and can be re-synced.
                            </p>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-error" onclick="confirmRemoveEmbeddings()">
                                <i class="fas fa-trash"></i>
                                <span>CLEAR ALL</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Service Logs -->
        <section style="margin-top: 1.5rem;">
            {{template "service-logs.html" .}}
        </section>

    </main>

    {{template "footer.html" .}}

    {{template "snackbar.html" .}}

    <script>
        // Load system configuration
        async function loadConfig() {
            // Mock configuration data matching TOML structure
            const config = {
                server: {
                    host: 'localhost',
                    port: 8085,
                    llama_dir: './llama'
                },
                'sources.confluence': {
                    enabled: true,
                    spaces: ['TEAM', 'DOCS']
                },
                'sources.jira': {
                    enabled: true,
                    projects: ['DATA', 'ENG']
                },
                llm: {
                    mode: 'offline'
                },
                'llm.offline': {
                    model_dir: './models',
                    embed_model: 'nomic-embed-text-v1.5.Q8_0.gguf',
                    chat_model: 'qwen2.5-7b-instruct-q4_k_m.gguf',
                    context_size: 2048,
                    thread_count: 4,
                    gpu_layers: 0
                },
                'llm.audit': {
                    enabled: true,
                    log_queries: false
                }
            };

            // Populate configuration table
            const tbody = document.getElementById('config-table-body');
            tbody.innerHTML = '';

            for (const [section, values] of Object.entries(config)) {
                if (typeof values === 'object' && !Array.isArray(values)) {
                    let firstRow = true;
                    for (const [key, value] of Object.entries(values)) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="section-cell">${firstRow ? '[' + section + ']' : ''}</td>
                            <td>${key}</td>
                            <td class="value-cell">${Array.isArray(value) ? JSON.stringify(value) : value}</td>
                        `;
                        tbody.appendChild(row);
                        firstRow = false;
                    }
                } else {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="section-cell">[${section}]</td>
                        <td>-</td>
                        <td class="value-cell">${values}</td>
                    `;
                    tbody.appendChild(row);
                }
            }
        }

        // Confirm and remove all embeddings
        async function confirmRemoveEmbeddings() {
            const confirmed = confirm(
                'âš  WARNING: This will delete ALL documents from the collection database.\n\n' +
                'This will remove all indexed content from Jira and Confluence.\n' +
                'Source data (Jira projects/issues and Confluence spaces/pages) will remain and can be re-synced.\n\n' +
                'Continue?'
            );

            if (!confirmed) return;

            try {
                const response = await fetch('/api/embeddings', {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Failed to clear documents');
                }

                const result = await response.json();
                showNotification(`Success: ${result.message}\n\nDocuments deleted: ${result.documents_affected}`, 'success');
            } catch (error) {
                console.error('Error clearing documents:', error);
                showNotification('Failed to clear documents: ' + error.message, 'error');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            loadConfig();
        });
    </script>
</body>

</html>