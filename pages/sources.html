<!DOCTYPE html>
<html lang="en">

<head>
    {{template "head.html" .}}
    <title>Source Management - Quaero</title>
</head>

<body>

    {{template "navbar.html" .}}

    <main class="page-container">

        <!-- Page Title -->
        <div class="page-title">
            <h1>Source Management</h1>
            <p>Configure and manage data sources for collection and indexing</p>
        </div>

        <!-- Application Status -->
        <section x-data="appStatus">
            <div class="card">
                <div class="card-header">
                    <header class="navbar">
                        <section class="navbar-section">
                            <h2>Application Status</h2>
                        </section>
                        <section class="navbar-section">
                            <span :class="'label ' + getStatusColor(state)" x-text="state"></span>
                        </section>
                    </header>
                </div>
                <div class="card-body">
                    <p><strong>Current State:</strong> <span x-text="state"></span></p>
                    <p><strong>Last Updated:</strong> <span x-text="formatTimestamp(timestamp)"></span></p>
                    <div x-show="Object.keys(metadata).length > 0">
                        <p><strong>Details:</strong></p>
                        <pre class="code-block" x-text="JSON.stringify(metadata, null, 2)"></pre>
                    </div>
                </div>
            </div>
        </section>

        <!-- Sources Management Component (wrap card and modal in shared scope) -->
        <section style="margin-top: 1.5rem;" x-data="sourceManagement">
            <!-- Sources List -->
            <div class="card">
                <div class="card-header">
                    <header class="navbar">
                        <section class="navbar-section">
                            <h2>
                                <span x-text="sources.length" style="color: var(--text-secondary); margin-right: 0.5rem;"></span>Sources
                            </h2>
                        </section>
                        <section class="navbar-section">
                            <div class="btn-group btn-group-block">
                                <button class="btn btn-sm btn-primary" @click="openCreateModal($event)">
                                    <i class="fas fa-plus"></i>
                                    <span>Add Source</span>
                                </button>
                                <button class="btn btn-sm" @click="loadSources()" title="Refresh Sources">
                                    <i class="fa-solid fa-rotate-right"></i>
                                </button>
                            </div>
                        </section>
                    </header>
                </div>
                <div class="card-body">
                        <!-- Sources Table -->
                        <table class="table striped border">
                            <thead>
                                <tr>
                                    <th>NAME</th>
                                    <th>TYPE</th>
                                    <th>BASE URL</th>
                                    <th>AUTHENTICATION</th>
                                    <th class="text-center">STATUS</th>
                                    <th>CREATED</th>
                                    <th class="text-center">ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-if="sources.length === 0">
                                    <tr>
                                        <td colspan="7" class="text-center">
                                            No sources configured. Click "Add Source" to get started.
                                        </td>
                                    </tr>
                                </template>
                                <template x-for="source in sources" :key="source.id">
                                    <tr>
                                        <td x-text="source.name"></td>
                                        <td>
                                            <span class="label" :class="{
                                                    'label-primary': ['jira', 'confluence'].includes(source.type),
                                                    'label-secondary': source.type === 'github'
                                                }" x-text="source.type.toUpperCase()"></span>
                                        </td>
                                        <td x-text="source.base_url"></td>
                                        <td>
                                            <template x-if="source.auth_id">
                                                <span class="label label-success">Configured</span>
                                            </template>
                                            <template x-if="!source.auth_id">
                                                <span class="label">None</span>
                                            </template>
                                        </td>
                                        <td class="text-center">
                                            <span class="label" :class="source.enabled ? 'label-success' : 'label-warning'" x-text="source.enabled ? 'Enabled' : 'Disabled'"></span>
                                        </td>
                                        <td x-text="formatDate(source.created_at)"></td>
                                        <td class="text-center">
                                            <button class="btn btn-sm" @click="editSource(source, $event)" title="Edit Source" style="margin-right: 0.25rem;">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-error" @click="deleteSource(source.id)" title="Delete Source">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Create/Edit Source Modal -->
            <div class="modal" :class="{'active': showCreateModal || showEditModal}" @keydown.escape.window="closeModal()">
                <a href="#close" class="modal-overlay" aria-label="Close" @click.prevent="closeModal()"></a>
                <div class="modal-container" role="dialog" aria-modal="true" style="max-width: 600px;">
                    <div class="modal-header">
                        <a href="#close" class="btn btn-clear float-right" aria-label="Close" @click.prevent="closeModal()"></a>
                        <div class="modal-title h5" x-text="showEditModal ? 'Edit Source' : 'Add New Source'"></div>
                    </div>
                    <div class="modal-body">
                        <div class="content">
                            <div class="form-group">
                                <label class="form-label">Name</label>
                                <input class="form-input" type="text" x-model="currentSource.name" placeholder="My Jira Instance">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Type</label>
                                <select class="form-select" x-model="currentSource.type">
                                    <option value="jira">Jira</option>
                                    <option value="confluence">Confluence</option>
                                    <option value="github">GitHub</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Base URL</label>
                                <input class="form-input" type="url" x-model="currentSource.base_url" placeholder="https://yourcompany.atlassian.net">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Authentication</label>
                                <select class="form-select" x-model="currentSource.auth_id">
                                    <option value="">No Authentication</option>
                                    <template x-for="auth in authentications" :key="auth.id">
                                        <option :value="auth.id" x-text="`${auth.name} (${auth.site_domain})`"></option>
                                    </template>
                                </select>
                                <p class="form-input-hint">Select authentication credentials for this source</p>
                                <template x-if="authentications.length === 0">
                                    <p class="form-input-hint text-warning">
                                        No authentication configured.
                                        <a href="/auth">Add authentication</a> first.
                                    </p>
                                </template>
                            </div>

                            <div class="form-group">
                                <label class="form-checkbox">
                                    <input type="checkbox" x-model="currentSource.enabled">
                                    <i class="form-icon"></i> Enabled
                                </label>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Crawl Configuration</label>
                                <div style="margin-bottom: 0.5rem;">
                                    <label class="form-label" style="font-size: 0.875rem;">Max Depth</label>
                                    <input class="form-input" type="number" x-model.number="currentSource.crawl_config.max_depth" min="1" max="10">
                                </div>
                                <div style="margin-bottom: 0.5rem;">
                                    <label class="form-label" style="font-size: 0.875rem;">Concurrency</label>
                                    <input class="form-input" type="number" x-model.number="currentSource.crawl_config.concurrency" min="1" max="10">
                                </div>
                                <div style="margin-bottom: 0.5rem;">
                                    <label class="form-label" style="font-size: 0.875rem;">Detail Level</label>
                                    <select class="form-select" x-model="currentSource.crawl_config.detail_level">
                                        <option value="minimal">Minimal</option>
                                        <option value="basic">Basic</option>
                                        <option value="full">Full</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="form-checkbox">
                                        <input type="checkbox" x-model="currentSource.crawl_config.follow_links">
                                        <i class="form-icon"></i> Follow Links
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" @click="saveSource()">Save</button>
                        <button class="btn" @click="closeModal()">Cancel</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Service Logs -->
        <section style="margin-top: 1.5rem;">
            {{template "service-logs.html" .}}
        </section>

    </main>

    {{template "footer.html" .}}

    {{template "snackbar.html" .}}

    <script>
        // Initialize Alpine.js components when DOM is ready
        document.addEventListener('DOMContentLoaded', function () {
            console.log('[Sources] Page loaded, Alpine.js components should be initialized');
        });

        // Ensure Alpine.js is fully initialized
        document.addEventListener('alpine:init', function () {
            console.log('[Sources] Alpine.js initialized');
        });

        // Plain JavaScript ESC key handler for modal (backup for Alpine directive)
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.querySelector('.modal.active');
                if (modal) {
                    // Trigger Alpine's closeModal method if available
                    const sourceSection = document.querySelector('[x-data="sourceManagement"]');
                    if (sourceSection && sourceSection.__x) {
                        sourceSection.__x.$data.closeModal();
                    }
                }
            }
        });

        // Focus trap for modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                const modal = document.querySelector('.modal.active .modal-container');
                if (modal) {
                    const focusableElements = modal.querySelectorAll(
                        'a[href], button:not([disabled]), textarea:not([disabled]), input:not([disabled]), select:not([disabled])'
                    );
                    const firstFocusable = focusableElements[0];
                    const lastFocusable = focusableElements[focusableElements.length - 1];

                    if (e.shiftKey) {
                        if (document.activeElement === firstFocusable) {
                            lastFocusable.focus();
                            e.preventDefault();
                        }
                    } else {
                        if (document.activeElement === lastFocusable) {
                            firstFocusable.focus();
                            e.preventDefault();
                        }
                    }
                }
            }
        });
    </script>
</body>

</html>