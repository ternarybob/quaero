# Stock Deep Dive Analysis - Full Pipeline Test
# =========================================================================
# Test version with orchestration, format_output, and email steps
# Uses a single ticker for faster testing
# =========================================================================

id = "stock-deep-dive-tools-full-test"
name = "Stock Deep Dive Analysis (Tools) - Full Pipeline Test"
type = "orchestrator"
description = "Test full pipeline - orchestrator, format_output, and email steps"
tags = ["stocks", "deep-dive", "analysis", "kneppy", "orchestrator", "tools", "test"]
schedule = ""
timeout = "2h"
enabled = true
auto_start = false

[meta]
author = "Claude Code"
version = "1.0"
created = "2026-01-11"
purpose = "Test full pipeline with format and email steps"

[config]
# Single ticker for faster testing
variables = [
    { ticker = "ASX:GNP" },
]

[step.orchestrate_analysis]
type = "orchestrator"
description = "AI-powered deep dive analysis with dynamic planning"
on_error = "fail"
thinking_level = "HIGH"
model_preference = "auto"
output_tags = ["stock-deep-dive-report"]

# Available tools
available_tools = [
    { name = "fetch_fundamentals", description = "Fetch comprehensive stock fundamentals including financials, valuation metrics, analyst coverage, and historical data. Creates document tagged with ['deep_dive_data', '<ticker-lowercase>']. REQUIRED params: ticker (string, e.g. 'ASX:GNP'). OPTIONAL: period (string) - Y1, Y2, Y3, Y5 (default Y3). Provides: PE ratio, EV/EBITDA, margins, shares outstanding, insider ownership, revenue/profit history, analyst targets.", worker = "market_fundamentals", output_tags = ["deep_dive_data"] },
    { name = "fetch_announcements", description = "Fetch and classify official ASX company announcements with price sensitivity flags and signal:noise analysis. Creates document tagged with ['deep_dive_data', '<ticker-lowercase>']. REQUIRED params: ticker (string, e.g. 'ASX:GNP'). OPTIONAL: period (string) - M1, M3, M6, Y1 (default Y1), limit (int) - max announcements. Provides: announcements with relevance classification, price sensitivity flags, signal-to-noise ratio.", worker = "market_announcements", output_tags = ["deep_dive_data"] },
    { name = "fetch_market_data", description = "Fetch price history and calculate technical indicators. Creates document tagged with ['deep_dive_data', '<ticker-lowercase>']. REQUIRED params: ticker (string, e.g. 'ASX:GNP'). OPTIONAL: period (string) - M1, M3, M6, Y1, Y2 (default Y2). Provides: current price, OHLCV history, SMA20/50/200, RSI14, support/resistance levels, trend signal.", worker = "market_data", output_tags = ["deep_dive_data"] },
    { name = "analyze_competitors", description = "Identify ASX-listed competitors using LLM analysis of company fundamentals. Creates document tagged with ['deep_dive_data', '<ticker-lowercase>']. REQUIRED params: ticker (string, e.g. 'ASX:GNP'). Provides: list of competitor ASX codes with rationale for competitive moat assessment.", worker = "market_competitor", api_key = "{google_gemini_api_key}", output_tags = ["deep_dive_data"] },
    { name = "analyze_summary", description = "Generate deep LLM-based analysis from collected documents using the Kneppy framework template. REQUIRED params: prompt (string) - detailed analysis instructions, filter_tags (array) - tags to filter documents. Use filter_tags=['deep_dive_data', '<ticker-lowercase>'] to get all data for a stock. OPTIONAL: thinking_level (string) - LOW or HIGH (use HIGH for comprehensive analysis). The prompt should reference the Kneppy Invest framework pillars.", worker = "summary" },
]

goal = """
Perform a comprehensive deep dive analysis of ASX:GNP using the Kneppy Invest Business Rating framework.

=== DOCUMENT TAGGING (IMPORTANT) ===
All data collection tools tag documents with:
- ["deep_dive_data", "<ticker-lowercase>"] (e.g., ["deep_dive_data", "gnp"])

When using analyze_summary, filter with: filter_tags=["deep_dive_data", "gnp"]

=== PHASE 1: DATA COLLECTION ===

For ASX:GNP, collect all required data:

1. FUNDAMENTALS: Use fetch_fundamentals with period: Y3
2. ANNOUNCEMENTS: Use fetch_announcements with period: Y1
3. MARKET DATA: Use fetch_market_data with period: Y2
4. COMPETITOR ANALYSIS: Use analyze_competitors

=== PHASE 2: DEEP DIVE ANALYSIS ===

Use analyze_summary with HIGH thinking_level and filter_tags=["deep_dive_data", "gnp"].

Analyze all SIX PILLARS of the Kneppy Invest Business Rating:

QUANTITATIVE PILLARS:
1. CAPITAL EFFICIENCY - ROIC consistently > 15%, 5-year trend, ROIC vs WACC spread
2. SHARE ALLOCATION - Outstanding shares flat/decreasing, buybacks, capital raises
3. FINANCIAL ROBUSTNESS - Net Debt/EBITDA < 2.0x, cash position, runway
4. CASH FLOW REALITY - FCF/Net Income conversion > 90%, quality of earnings

QUALITATIVE PILLARS:
5. MANAGEMENT ALIGNMENT - Insider ownership, insider trading, institutional backing
6. COMPETITIVE MOAT - Source of advantage, margin sustainability, competitor positioning

=== OUTPUT REQUIREMENTS ===

FINAL OUTPUT MUST INCLUDE:
- Deep dive report with all Kneppy pillars
- Final scorecard with Quality Grade
- Clear marking of data gaps with DATA_UNAVAILABLE
- Improvements section with recommendations
"""

# =========================================================================
# Format Output Step
# =========================================================================

[step.format_output]
type = "output_formatter"
description = "Format deep dive reports as PDF attachments"
depends = "orchestrate_analysis"
on_error = "fail"
input_tags = ["stock-deep-dive-report"]
output_tags = ["email_report"]
title = "Stock Deep Dive Analysis - Test Report"
format = "pdf"
attachment = true
style = "body"

# =========================================================================
# Email Step
# =========================================================================

[step.email_report]
type = "email"
description = "Email deep dive analysis report with PDF attachment"
depends = "format_output"
always_run = true
on_error = "fail"
to = "bobmcallan@gmail.com"
subject = "Stock Deep Dive Analysis (Test) - Kneppy Framework Report"

on_error_subject = "Stock Deep Dive Analysis (Test) - An Error Occurred"
include_logs_on_error = true
