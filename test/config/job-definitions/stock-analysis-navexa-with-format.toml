# Stock Analysis - Navexa Portfolio with Format and Email
# =========================================================================
# Extended version that includes format_output step for PDF formatting
#
# WORKFLOW:
# 1. Navexa Portfolio: Fetch portfolio with holdings from Navexa API
# 2. Data Collection: Deterministic stock data fetching
# 3. Stock Analysis: AI analysis using embedded template
# 4. Portfolio Review: AI-generated portfolio review
# 5. Format Output: Format documents for email with PDF attachment
# 6. Email Report: Send analysis results with formatted attachment
#
# OUTPUT TAG: portfolio-review
# =========================================================================

id = "stock-analysis-navexa-with-format"
name = "Stock Analysis (Navexa Portfolio) - With Format"
type = "orchestrator"
description = "AI-powered stock analysis with format and email steps"
tags = ["stocks", "analysis", "navexa", "portfolio", "hybrid", "format", "test"]
schedule = ""
timeout = "3h"
enabled = true
auto_start = false

[meta]
author = "Claude Code"
version = "1.0"
created = "2026-01-11"
purpose = "Test Navexa portfolio analysis with format and email steps"

[config]
# Portfolio name to analyze (from Navexa)
portfolio_name = "SMSF"

# Benchmark for comparison
benchmarks = [{ code = "XJO", name = "S&P/ASX 200" }]

# =========================================================================
# Step 1: Navexa Portfolio
# =========================================================================

[step.navexa_portfolio]
type = "navexa_portfolio"
description = "Fetch Navexa portfolio with holdings"
on_error = "fail"
name = "{config.portfolio_name}"
output_tags = ["collect_data"]

# =========================================================================
# Step 2: Data Collection
# =========================================================================

[step.collect_data]
type = "market_data_collection"
description = "Collect stock data for Navexa holdings"
depends = "navexa_portfolio"
on_error = "fail"
output_tags = ["analyze"]

# =========================================================================
# Step 3: Stock Analysis
# =========================================================================

[step.analyze]
type = "summary"
description = "Analyze collected stock data"
depends = "collect_data"
on_error = "fail"
template = "stock-analysis"
output_tags = ["portfolio_review"]

# =========================================================================
# Step 4: Portfolio Review
# =========================================================================

[step.portfolio_review]
type = "portfolio_review"
description = "Generate AI portfolio review"
depends = "analyze"
on_error = "fail"
output_tags = ["format_output"]

# =========================================================================
# Step 5: Format Output
# =========================================================================

[step.format_output]
type = "output_formatter"
description = "Format portfolio review as PDF attachment"
depends = "portfolio_review"
on_error = "fail"
input_tags = ["format_output"]
output_tags = ["email_report"]
title = "Navexa Portfolio Analysis Report"
format = "pdf"
attachment = true
style = "body"

# =========================================================================
# Step 6: Email Report
# =========================================================================

[step.email_report]
type = "email"
description = "Email Navexa portfolio analysis with PDF attachment"
depends = "format_output"
always_run = true
on_error = "fail"
to = "bobmcallan@gmail.com"
subject = "Navexa Portfolio Analysis - AI-Powered Report"

on_error_subject = "Navexa Portfolio Analysis - An Error Occurred"
include_logs_on_error = true
