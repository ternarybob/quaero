# SMSF Portfolio Summary Template
# =========================================================================
# Generates a consolidated portfolio review from individual stock analyses.
# Aggregates all stock recommendations into a single portfolio-level view
# with BUY|SELL|HOLD recommendations and SMSF compliance notes.
#
# PREREQUISITE: Stock analyses must be completed first using asx-stock-review
# template. This template finds completed analyses via filter_tags.
#
# USAGE:
# This template is invoked via a job_template step in a portfolio job:
#   [step.generate_portfolio_summary]
#   type = "job_template"
#   template = "smsf-portfolio-summary"
#   depends = "run_stock_analysis, fetch_benchmark_indices"
#
# SINGLETON MODE:
# This template declares singleton=true in [config], so it runs once regardless
# of parent variables. Parent config.variables are still inherited for data access
# (e.g., portfolio holdings data), but not used for iteration.
# =========================================================================

id = "smsf-portfolio-summary"
name = "SMSF Portfolio Summary"
type = "portfolio_summary"
description = "Generate consolidated SMSF portfolio review with practical investment recommendations"
tags = ["smsf", "portfolio", "summary", "template"]
schedule = ""
timeout = "30m"
enabled = true
auto_start = false

# Template configuration
# Singleton mode: this template runs once, not iterating over parent variables
# Parent config.variables are still inherited for data access within steps
[config]
singleton = true

# =========================================================================
# Step 1: Generate Consolidated Portfolio Summary
# =========================================================================
# Reads ALL stock-recommendation documents and creates a portfolio-level
# view with consolidated BUY|SELL|HOLD recommendations.

[step.generate_summary]
type = "summary"
description = "Generate consolidated SMSF portfolio review with practical investment recommendations"
on_error = "fail"
filter_tags = ["stock-portfolio"]
thinking_level = "HIGH"
max_iterations = 2
critique_prompt = """
Critique the Draft Portfolio Review against these rules:

1. **DATA ACCURACY (CRITICAL)**:
   - Check the "Gain/Loss Table".
   - Did the draft use the EXACT `Avg Price` and `Units` from the "Portfolio Holdings Data" section?
   - Do the math: (Current Price - Avg Price) * Units = Total Return. Is it correct?
   - If ANY value is a placeholder (e.g., $[X.XX]), REJECT IT.

2. **SECTION CHECK**:
   - "Gain/Loss Table" MUST be present with color coding (green +, red -).
   - "Stock-by-Stock Recommendation" MUST be a single table with Industry column, ordered by ticker.
   - Each row MUST include detailed assessment (Long Term View, Technical Opinion, Signal/Noise, Review Trigger).
   - "Global Macro" section MUST NOT be present (it is irrelevant).
   - "Report Date" must be the current analysis date.

3. **TONE & CONTENT**:
   - No generic "market speak".
   - BUY/HOLD/SELL must use color indicators.
   - No "Detailed Stock Assessment" section (content is in the table).
   - No "Alternative Replacements" section.

If the draft is perfect, output: "NO_CHANGES_NEEDED".
Otherwise, list the specific errors to fix.
"""
prompt = """You are a Senior Investment Strategist and Compliance Officer preparing a practical SMSF portfolio review.

## RULES
1. **DATA SOURCE**: Use ONLY the provided "Portfolio Holdings Data" for Units and Avg Price. Use stock documents for Current Price.
2. **NO HALLUCINATIONS**: Do not invent historical data. If data is missing, say "N/A".
3. **NO GLOBAL MACRO**: Focus only on the specific stocks in the portfolio.
4. **SIGNAL/NOISE**: For each stock, you must assess the "Signal/Noise Ratio" based on the analysis provided.

## COLOR CODING
- **Positive values**: Use ğŸŸ¢ or (+) prefix for gains
- **Negative values**: Use ğŸ”´ or (-) prefix for losses
- **BUY**: ğŸŸ¢ BUY
- **HOLD**: ğŸŸ  HOLD
- **SELL**: ğŸ”´ SELL

# SMSF PORTFOLIO REVIEW: PRACTICAL INVESTMENT ASSESSMENT
## Strategy: Diversified Australian Equities with ETF Exposure
## Analysis Date: [Use Current Date]

---

## EXECUTIVE SUMMARY

[High-level summary of portfolio health, total value, and key actions]

---

## GAIN/LOSS TABLE

| Ticker | Units | Avg Price | Current Price | Cost Basis | Current Value | Total Return | Total Return % |
|--------|-------|-----------|---------------|------------|---------------|--------------|----------------|
| [Ticker] | [Units] | [Avg] | [Current] | [Cost] | [Value] | ğŸŸ¢/ğŸ”´ $X | ğŸŸ¢/ğŸ”´ X% |
| **TOTAL** | | | | **$X** | **$X** | **$X** | **X%** |

*(Calculate EXACTLY. Do not use placeholders. Use ğŸŸ¢ for positive, ğŸ”´ for negative.)*

---

## STOCK-BY-STOCK RECOMMENDATION

*Single table ordered alphabetically by ticker. Include Industry column.*

| Ticker | Industry | Action | Conviction | 7D | 1M | 3M | 6M | 1Y | 2Y | Volume | Tech Opinion | Signal/Noise | Review Trigger |
|--------|----------|--------|------------|-----|-----|-----|-----|-----|-----|--------|--------------|--------------|----------------|
| [AAA] | [Industry] | ğŸŸ¢ BUY / ğŸŸ  HOLD / ğŸ”´ SELL | 1-10 | [7D %] | [1M %] | [3M %] | [6M %] | [1Y %] | [2Y %] | [Vol Trend] | [200MA, levels] | [High/Med/Low %] | [Event to watch] |

**Column Definitions:**
- **Performance Columns (7D, 1M, 3M, 6M, 1Y, 2Y)**: Price change over period with color coding
  - Format: ğŸŸ¢/ğŸŸ /ğŸ”´ +X.X% ($Y.YY)
  - ğŸŸ¢ Green: Positive performance (>2%)
  - ğŸŸ  Orange: Neutral performance (-2% to +2%)
  - ğŸ”´ Red: Negative performance (<-2%)
- **Volume**: Long-term average daily volume and recent trend
  - Format: "1.2M avg, â†‘ 25% (1M)" or "850K avg, â†“ 15% (1W)"
  - Shows if last week/month volume is above (â†‘) or below (â†“) long-term average
- **Tech Opinion**: Review of 200MA and key technical levels
- **Signal/Noise**: Is the company narrative credible? (Use the Signal-to-Noise metric from analysis)
- **Review Trigger**: Specific event to watch (e.g. "Next Earnings", "Price < $X")

---

## PRIORITY ACTIONS

1. [High Priority Action]
2. [Medium Priority Action]

---

**DISCLAIMER**: General information only. Not financial advice.
"""
output_tags = ["smsf-portfolio-review", "smsf-portfolio", "portfolio-summary"]

# Validation patterns - ensure required sections are present with actual content
# The summary worker will verify these patterns exist in the output
output_validation = [
    "## GAIN/LOSS TABLE",
    "## STOCK-BY-STOCK RECOMMENDATION",
    "## EXECUTIVE SUMMARY",
]
